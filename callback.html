<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando Login</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { text-align: center; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4a6fa5; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { color: #d93025; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Processando seu login...</h2>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
            const errorElement = document.getElementById('error');

            try {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const error = params.get('error');

                if (error) {
                    throw new Error(params.get('error_description') || 'Erro no servidor de autorização');
                }

                if (!code) {
                    throw new Error('Código de autorização não recebido');
                }

                const codeVerifier = sessionStorage.getItem('pkce_verifier');
                if (!codeVerifier) {
                    throw new Error('Sessão expirada. Por favor, faça login novamente.');
                }

                console.log('Trocando código por token...');
                const response = await fetch(`${BACKEND_URL}/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: 'frontend-spa',
                        code: code,
                        redirect_uri: window.location.href.split('?')[0],
                        code_verifier: codeVerifier
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || 'Erro ao obter token');
                }

                const tokenData = await response.json();
                console.log('Token recebido:', tokenData);
                
                // Redireciona para a página principal
                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error('Erro no callback:', error);
                errorElement.textContent = error.message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        });
    </script>
</body>
</html>
