<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard da Escola - Inoutchi</title>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Leaflet.js (para o mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet.draw (para desenhar no mapa) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Estilos (CSS) -->
    <style>
        /* Estilos Globais e Variáveis (inspirado nos outros dashboards) */
        :root {
            --primary-color: #3B82F6;
            --secondary-color: #1E40AF;
            --background-color: #F3F4F6;
            --sidebar-bg: #1F2937;
            --sidebar-text: #D1D5DB;
            --sidebar-active: #3B82F6;
            --text-color: #111827;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* Cabeçalho Superior */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .header .logo img {
            height: 40px;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .btn-logout {
            background-color: #EF4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background-color: #DC2626;
        }

        /* Layout Principal */
        .dashboard-container {
            display: flex;
            height: calc(100vh - 61px);
            /* Altura total menos o cabeçalho */
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding-top: 20px;
            flex-shrink: 0;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-nav li a .icon {
            width: 20px;
            text-align: center;
        }

        .sidebar-nav li a:hover {
            background-color: #374151;
        }

        .sidebar-nav li a.active {
            background-color: var(--sidebar-active);
            color: white;
            font-weight: 600;
        }

        /* Área de Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            /* Todas as seções começam escondidas */
        }

        .content-section.active {
            display: block;
            /* A seção ativa é mostrada */
        }

        .section-header h1 {
            margin-top: 0;
            font-size: 28px;
            color: var(--text-color);
        }

        /* Estilos para a Seção de Conteúdo */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        /* Tabela */
        .content-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
        }

        .content-table th,
        .content-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .content-table th {
            background-color: #F9FAFB;
            font-size: 12px;
            text-transform: uppercase;
            color: #6B7280;
        }

        .content-table td {
            color: var(--text-color);
        }

        .content-table tbody tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 8px;

        }

        .btn-edit {
            background-color: #FBBF24;
            color: #78350F;
        }

        .btn-edit:hover {
            background-color: #F59E0B;
        }

        .btn-delete {
            background-color: #F87171;
            color: #7F1D1D;
        }

        .btn-delete:hover {
            background-color: #EF4444;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #6B7280;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close-button {
            color: #9CA3AF;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover {
            color: var(--text-color);
        }

        .modal-body {
            padding: 20px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .btn-secondary {
            background-color: #E5E7EB;
            color: #374151;
        }

        .btn-secondary:hover {
            background-color: #D1D5DB;
        }

        .form-group select[multiple] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: white;
        }

        #map {
            height: 400px;
            /* Altura do mapa */
            width: 100%;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .geofence-form-container {
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .geofence-form-container h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Para dividir o formulário em colunas */
        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .search-results {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
        }

        .search-results div {
            padding: 8px;
            cursor: pointer;
        }

        .search-results div:hover {
            background-color: #f0f0f0;
        }

        .selected-items-list span {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px 5px 0 0;
        }

        .selected-items-list span button {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            /* Verde para sucesso por padrão */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .toast.error {
            background-color: #dc3545;
            /* Vermelho para erro */
        }

        /* Ajuste no botão de exclusão do modal */
        #confirmDeleteBtn:hover {
            background-color: #B91C1C !important;
        }

        .pagination-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            justify-content: center;
            margin-top: 25px;
            padding: 15px;
            background-color: #F9FAFB;
            /* Um fundo suave */
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .pagination-info {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            background-color: var(--primary-color);
            /* Azul padrão do tema */
            color: white;
            /* Texto branco para contraste */
            border: none;
            /* Garante que não haja bordas indesejadas */
        }

        /* Efeito hover: escurece o botão, mas APENAS se ele não estiver desabilitado */
        .pagination-btn:not(:disabled):hover {
            background-color: var(--secondary-color);
            /* Azul mais escuro no hover */
        }

        /* Desabilita eventos de clique no ícone para garantir que o clique vá para o botão */
        .pagination-btn i {
            pointer-events: none;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #E5E7EB;
        }

        .page-info-text {
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 10px;
            font-size: 15px;
        }

        .modern-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* Cria duas colunas de largura igual */
            gap: 20px;
            /* Espaçamento entre as colunas e linhas */
        }

        .grid-col-span-2 {
            grid-column: span 2;
            /* Faz um item ocupar as duas colunas */
        }

        /*
         * Limita a largura máxima do contêiner de filtros para
         * evitar que ele se estique demais em telas grandes.
         */
        #token-management-view-content .card-body .row {
            max-width: 900px;
            /* Define uma largura máxima generosa para o conjunto */
        }

        /*
         * Garante que em telas pequenas (mobile), as colunas
         * tenham um espaço entre si quando empilhadas.
         */
        @media (max-width: 767px) {
            #token-management-view-content .card-body .row>[class*="col-"] {
                margin-bottom: 1rem;
            }
        }

        .custom-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            background-color: #FFFFFF;
            font-size: 1rem;
            color: #111827;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .custom-form-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        select.custom-form-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        #token-management-view-content .card-body .row {
            max-width: 900px;
            /* Limita a largura máxima do conjunto de filtros */
        }

        @media (max-width: 767px) {
            #token-management-view-content .card-body .row>[class*="col-"] {
                margin-bottom: 1rem;
                /* Adiciona espaço vertical no mobile */
            }
        }

        token-management-view-content .form-label {
            margin-bottom: 0.5rem;
            /* Adiciona 8px de espaço vertical */
        }

        #token-management-view-content .custom-form-input {
            width: 64ch;
            /* Tenta ter a largura de ~64 caracteres */
            max-width: 100%;
            /* Trava de segurança: não ultrapassa o tamanho da coluna pai */
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            /* Permite que os itens quebrem para a linha de baixo em telas pequenas */
            align-items: flex-end;
            /* Alinha a base dos itens (ótimo para o botão) */
            gap: 24px;
            /* Cria um espaço horizontal entre os filtros */
        }

        /* 2. O grupo de filtro (label + campo) que garante o layout VERTICAL */
        .filter-group .form-label {
            display: block;
            /* Força o label a ficar em sua própria linha (ACIMA) */
            margin-bottom: 8px;
            /* Cria o espaço entre o texto e o campo abaixo dele */
        }

        /* 3. O campo de input/select, que agora terá o tamanho correto */
        .filters-container .custom-form-input {
            width: 64ch;
            /* Define a largura desejada de ~64 caracteres */
            max-width: 100%;
            /* Garante que não quebre o layout em telas menores */
        }

        /* 4. Um pequeno ajuste para o botão não ficar esticado */
        .filter-group.button-group {
            padding-bottom: 1px;
            /* Alinhamento fino do botão */
        }

        /* ====================================================================== */
        /* #### INÍCIO DO BLOCO DE ESTILIZAÇÃO DA GEOLOCALIZAÇÃO #### */
        /* ====================================================================== */

        /* --- Estilos Gerais para a Seção de Geolocalização --- */
        #geolocalizacao-content .geofence-form-container,
        #geolocalizacao-content .table-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        /* --- 1. Estilizando o Formulário de Detalhes da Área --- */
        #geolocalizacao-content .geofence-form-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color, #3B82F6);
            border-bottom: 2px solid var(--border-color, #E5E7EB);
            padding-bottom: 10px;
        }

        #geolocalizacao-content .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        #geolocalizacao-content .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #geolocalizacao-content .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        #geolocalizacao-content .form-group input,
        #geolocalizacao-content .form-group select {
            padding: 10px;
            border: 1px solid var(--border-color, #ccc);
            border-radius: 5px;
            font-size: 1rem;
        }

        #geolocalizacao-content .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* --- 2. Estilizando a Tabela de Áreas Salvas --- */
        #geolocalizacao-content .table-container h3 {
            margin-top: 0;
            color: var(--primary-color, #3B82F6);
        }

        /* Badges para Tipo ENTRADA/SAIDA */
        .badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
        }

        .badge-entrada {
            background-color: #28a745;
        }

        /* Verde */
        .badge-saida {
            background-color: #dc3545;
        }

        /* Vermelho */

        /* Badges para Status Ativo/Inativo */
        .status-badge.status-active {
            color: #166534;
            background-color: #dcfce7;
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-badge.status-inactive {
            color: #991b1b;
            background-color: #fee2e2;
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Botões de Ação na Tabela */
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #6c757d;
            margin: 0 5px;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: var(--primary-color, #3B82F6);
        }

        .btn-icon.btn-delete:hover {
            color: #dc3545;
        }

        /* --- 3. Estilizando o Display de Coordenadas do Mapa --- */

        .map-info-display {
            background-color: #f8f9fa;
            padding: 8px 15px;
            border: 1px solid #e9ecef;
            border-radius: 0 0 8px 8px;
            /* Arredonda cantos inferiores */
            margin-top: -8px;
            /* "Gruda" no mapa */
            text-align: center;
            font-size: 0.9rem;
            color: #495057;
        }

        /* ====================================================================== */
        /* #### FIM DO BLOCO DE ESTILIZAÇÃO #### */
        /* ====================================================================== */

        /* Estilo para o texto (ENTRADA) e (SAIDA) na lista */
        .geofence-type-strong.type-entrada {
            color: green;
        }

        .geofence-type-strong.type-saida {
            color: red;
        }

        /* --- Estilo para o contêiner da lista (igual aos outros) --- */
        .list-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .list-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color, #3B82F6);
            border-bottom: 2px solid var(--border-color, #E5E7EB);
            padding-bottom: 10px;
        }

        /* --- Estilo para cada item na lista (o mais importante) --- */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color, #E5E7EB);
            transition: background-color 0.2s;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: #f9fafb;
        }

        .list-item span {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--text-color, #374151);
        }

        /* Garante que os botões de ação fiquem agrupados */
        .list-item div {
            display: flex;
            gap: 8px;
        }

        /*
        Ajuste fino nos botões de ícone para garantir
        consistência total com as outras abas.
        */
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #6c757d;
            padding: 5px;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: var(--primary-color, #3B82F6);
        }

        .btn-icon.btn-delete:hover {
            color: #dc3545;
        }
    </style>

</head>

<body>
    <div id="alert-container"></div>

    <!-- Cabeçalho Padrão do Sistema -->
    <header class="header">
        <div class="logo">
            <!-- Usaremos a mesma logo dos outros dashboards para consistência -->
            <img src="img/LogoTipoInoutchi.png" alt="Logomarca Inoutchi">
        </div>
        <div class="user-info">
            <span id="userName">Admin Escola</span>
            <div class="user-avatar" id="userAvatar">E</div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </header>

    <!-- Container Principal do Dashboard -->
    <div class="dashboard-container">

        <!-- Menu de Navegação Lateral -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="#" class="nav-link active" data-target="visao-geral">
                        <i class="fas fa-tachometer-alt icon"></i> Visão Geral
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="geolocalizacao">
                        <i class="fas fa-map-marker-alt icon"></i> Geolocalização
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="diretores">
                        <i class="fas fa-user-tie icon"></i> Diretores
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="tutores">
                        <i class="fas fa-user-friends icon"></i> Tutores
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="transportes">
                        <i class="fas fa-bus icon"></i> Transportes
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="salas">
                        <i class="fas fa-chalkboard-teacher icon"></i> Salas
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="alunos">
                        <i class="fas fa-child icon"></i> Alunos
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-target="token-management-view">
                        <i class="fas fa-shield-alt icon"></i> Gestão de Tokens
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Área de Conteúdo Dinâmico -->
        <main class="main-content">
            <!-- Seção Visão Geral (Padrão) -->
            <section id="visao-geral-content" class="content-section active">
                <div class="section-header">
                    <h1>Visão Geral</h1>
                </div>
                <p>Bem-vindo ao painel de administração da escola. Em breve, esta área exibirá gráficos e relatórios
                    sobre o fluxo da sua escola.</p>
            </section>

            <!-- Seção Geolocalização -->
            <section id="geolocalizacao-content" class="content-section">

                <!-- TÍTULO CORRIGIDO (APENAS UM) -->
                <div class="section-header">
                    <h1>Gestão de Geolocalização (Geofence)</h1>
                </div>

                <!-- O MAPA -->
                <div id="map"></div>

                <div id="map-coordinates-display" class="map-info-display">
                    <span>Clique no mapa para ver as coordenadas de um ponto.</span>
                </div>

                <!-- O FORMULÁRIO DE EDIÇÃO/CRIAÇÃO -->
                <div class="geofence-form-container">

                    <!-- 
                        GARANTIA 1: O <form> envolve TUDO: o título, os inputs e o botão.
                        GARANTIA 2: O onsubmit chama DIRETAMENTE a função que queremos.
                    -->
                    <form id="geofenceForm" onsubmit="saveGeofence(event)">
                        <h3>Detalhes da Área</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="geofenceNome">Nome da Área</label>
                                <input type="text" id="geofenceNome" required>
                            </div>
                            <div class="form-group">
                                <label for="geofenceTipo">Tipo de Ação</label>
                                <select id="geofenceTipo">
                                    <option value="ENTRADA">Entrada</option>
                                    <option value="SAIDA">Saída</option>
                                </select>
                            </div>
                        </div>

                        <!-- Inputs ocultos que serão preenchidos pelo mapa -->
                        <input type="hidden" id="geofenceId">
                        <input type="hidden" id="geofenceLatitude">
                        <input type="hidden" id="geofenceLongitude">
                        <input type="hidden" id="geofenceRaio">

                        <div class="form-actions">
                            <!-- 
                                GARANTIA 3: O botão é type="submit", a chave que liga a ignição do formulário.
                            -->
                            <button type="submit" class="btn btn-primary">Salvar Área</button>
                            <button type="button" class="btn btn-secondary"
                                onclick="resetGeofenceForm()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- A TABELA ONDE AS ÁREAS SALVAS APARECEM -->
                <div class="table-container">
                    <h3>Áreas Salvas</h3>
                    <div id="geofenceList">
                        <!-- A lista de áreas será inserida aqui pelo JavaScript -->
                    </div>

                </div>
            </section>

            <!-- Seção Diretores -->
            <section id="diretores-content" class="content-section">
                <div class="section-header">
                    <h1>Gestão de Diretores</h1>
                </div>
                <!-- Cabeçalho da Seção de Diretores -->
                <div class="section-header">
                    <h1>Gestão de Diretores</h1>
                    <button class="btn btn-primary" onclick="openDiretorModal()">
                        <i class="fas fa-plus"></i> Adicionar Novo Diretor
                    </button>
                </div>

                <!-- Tabela para Listar os Diretores -->
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th style="width: 150px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="diretoresTableBody">
                        <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
                        <tr>
                            <td colspan="3" class="empty-state">Carregando diretores...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Modal para Adicionar/Editar Diretor -->
                <div id="diretorModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="diretorModalTitle">Adicionar Novo Diretor</h2>
                            <span class="close-button" onclick="closeDiretorModal()">&times;</span>
                        </div>
                        <form id="diretorForm">
                            <div class="modal-body">
                                <input type="hidden" id="diretorId">
                                <div class="form-group">
                                    <label for="diretorNome">Nome Completo</label>
                                    <input type="text" id="diretorNome" required>
                                </div>
                                <div class="form-group">
                                    <label for="diretorEmail">Email</label>
                                    <input type="email" id="diretorEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="diretorCpf">CPF</label>
                                    <input type="text" id="diretorCpf" required>
                                </div>

                                <div class="form-group">
                                    <label for="diretorSenha">Senha</label>
                                    <input type="text" id="diretorSenha" placeholder="Deixe em branco para não alterar">
                                </div>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeDiretorModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Seção Tutores -->
            <section id="tutores-content" class="content-section">
                <!-- Cabeçalho da Seção (Combinado e Limpo) -->
                <div class="section-header">
                    <h1>Gestão de Tutores</h1>
                    <button class="btn btn-primary" onclick="openTutorModal()">
                        <i class="fas fa-plus"></i> Adicionar Novo Tutor
                    </button>
                </div>
                <!-- ADICIONADO: Barra de Busca para Tutores -->
                <div class="search-bar-container" style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="text" id="tutorSearch" class="form-control" placeholder="Buscar tutor por nome..."
                        style="flex-grow: 1;">
                    <button class="btn btn-primary" type="button" onclick="searchTutorsOnListPage()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

                <!-- Tabela para Listar os Tutores (Intacta) -->
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Alunos Vinculados</th>
                            <th style="width: 150px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tutoresTableBody">
                        <tr>
                            <td colspan="4" class="empty-state">Carregando tutores...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- ADICIONADO: Container da Paginação -->
                <div id="tutorsPagination" class="pagination-container" style="display: none;">
                    <!-- A paginação será renderizada aqui pelo JavaScript -->
                </div>

                <!-- Modal para Adicionar/Editar Tutor (INTACTO, exatamente como você enviou) -->
                <div id="tutorModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="tutorModalTitle">Adicionar Novo Tutor</h3>
                            <button class="close-modal" onclick="closeTutorModal()">&times;</button>
                        </div>
                        <form id="tutorForm">
                            <div class="modal-body">
                                <input type="hidden" id="tutorId">

                                <div class="form-group">
                                    <label for="tutorNome">Nome Completo</label>
                                    <input type="text" id="tutorNome" required>
                                </div>

                                <div class="form-group">
                                    <label for="tutorEmail">Email</label>
                                    <input type="email" id="tutorEmail" required>
                                </div>

                                <div class="form-group">
                                    <label for="tutorCpf">CPF</label>
                                    <input type="text" id="tutorCpf" required>
                                </div>

                                <!-- ====================================================== -->
                                <!-- ==== ADICIONE ESTE BLOCO SE ELE NÃO EXISTIR ==== -->
                                <!-- ====================================================== -->
                                <div class="form-group">
                                    <label for="tutorFone">Telefone</label>
                                    <input type="text" id="tutorFone" placeholder="(Opcional)">
                                </div>
                                <!-- ====================================================== -->

                                <div class="form-group">
                                    <label for="tutorSenha">Senha</label>
                                    <input type="password" id="tutorSenha"
                                        placeholder="Deixe em branco para não alterar">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeTutorModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Seção Transportes -->
            <section id="transportes-content" class="content-section">
                <div class="section-header">
                    <h1>Gestão de Transportes</h1>
                </div>
                <!-- Cabeçalho da Seção de Transportes -->
                <div class="section-header">
                    <h1>Gestão de Transportes</h1>
                    <button class="btn btn-primary" onclick="openTransporteModal()">
                        <i class="fas fa-plus"></i> Adicionar Novo Transporte
                    </button>
                </div>

                <!-- Tabela para Listar os Transportes -->
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nome/Empresa</th>
                            <th>Email de Contato</th>
                            <th>Telefone</th>
                            <th style="width: 150px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transportesTableBody">
                        <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
                        <tr>
                            <td colspan="4" class="empty-state">Carregando transportes...</td>
                        </tr>
                    </tbody>
                </table>

                <div id="transportesPagination" class="pagination-container"></div>

                <!-- Modal para Adicionar/Editar Transporte -->
                <div id="transporteModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="transporteModalTitle">Adicionar Novo Transporte</h2>
                            <span class="close-button" onclick="closeTransporteModal()">&times;</span>
                        </div>
                        <form id="transporteForm">
                            <div class="modal-body">
                                <input type="hidden" id="transporteId">
                                <div class="form-group">
                                    <label for="transporteNome">Nome (Empresa ou Motorista)</label>
                                    <input type="text" id="transporteNome" required>
                                </div>
                                <div class="form-group">
                                    <label for="transporteCpf">CPF</label>
                                    <input type="text" id="transporteCpf" required>
                                </div>
                                <div class="form-group">
                                    <label for="transporteEmail">Email de Contato</label>
                                    <input type="email" id="transporteEmail" required>
                                </div>
                                <!-- ID CORRETO -->
                                <div class="form-group">
                                    <label for="transporteFone">Telefone</label>
                                    <input type="text" id="transporteFone">
                                </div>
                                <!-- Campo de Senha -->
                                <div class="form-group">
                                    <label for="transporteSenha">Senha de Acesso</label>
                                    <input type="text" id="transporteSenha"
                                        placeholder="Deixe em branco para não alterar">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeTransporteModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Seção Salas -->
            <section id="salas-content" class="content-section">
                <div class="section-header">
                    <h1>Gestão de Salas</h1>
                </div>
                <div class="section-header">
                    <h1>Gestão de Salas</h1>
                    <button class="btn btn-primary" onclick="openSalaModal()">
                        <i class="fas fa-plus"></i> Adicionar Nova Sala
                    </button>
                </div>

                <!-- Tabela para Listar as Salas -->
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nome da Sala</th>
                            <th style="width: 150px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="salasTableBody">
                        <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
                        <tr>
                            <td colspan="2" class="empty-state">Carregando salas...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Modal para Adicionar/Editar Sala -->
                <div id="salaModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="salaModalTitle">Adicionar Nova Sala</h2>
                            <span class="close-button" onclick="closeSalaModal()">&times;</span>
                        </div>
                        <form id="salaForm">
                            <div class="modal-body">
                                <input type="hidden" id="salaId">
                                <div class="form-group">
                                    <label for="salaNome">Nome da Sala</label>
                                    <input type="text" id="salaNome" required placeholder="Ex: Maternal II">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeSalaModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Seção Alunos -->
            <section id="alunos-content" class="content-section">
                <!-- LIMPEZA: Cabeçalho combinado e limpo -->
                <div class="section-header">
                    <h1>Gestão de Alunos</h1>
                    <button class="btn btn-primary" onclick="openAlunoModal()">
                        <i class="fas fa-plus"></i> Adicionar Novo Aluno
                    </button>
                </div>
                <!-- ADICIONADO: Barra de Busca para Alunos -->
                <div class="search-bar-container" style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="text" id="tutorSearch" class="form-control" placeholder="Buscar aluno por nome..."
                        style="flex-grow: 1;">
                    <button class="btn btn-primary" type="button" onclick="searchTutorsOnListPage()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

                <!-- Tabela para Listar os Alunos (Intacta) -->
                <table class="content-table">
                    <thead>
                        <tr>
                            <th>Nome do Aluno</th>
                            <th>Sala</th>
                            <th>Tutor(es)</th>
                            <th style="width: 150px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="alunosTableBody">
                        <tr>
                            <td colspan="4" class="empty-state">Carregando alunos...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Container da Paginação (Intacto) -->
                <div id="pagination-controls" class="pagination"></div>

                <!-- Modal para Adicionar/Editar Aluno (INTACTO) -->
                <div id="alunoModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="alunoModalTitle">Adicionar Novo Aluno</h2>
                            <span class="close-button" onclick="closeAlunoModal()">&times;</span>
                        </div>
                        <form id="alunoForm">
                            <div class="modal-body">
                                <input type="hidden" id="alunoId">
                                <input type="hidden" id="alunoStatus">

                                <!-- AQUI COMEÇA O NOSSO NOVO LAYOUT EM GRID -->
                                <div class="form-grid">

                                    <h4 class="grid-col-span-2">Dados Pessoais</h4>

                                    <div class="form-group">
                                        <label for="alunoNome">Nome Completo</label>
                                        <input type="text" id="alunoNome" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="alunoNascimento">Data de Nascimento</label>
                                        <input type="date" id="alunoNascimento" required>
                                    </div>

                                    <hr class="grid-col-span-2" style="margin: 10px 0;">

                                    <h4 class="grid-col-span-2">Vínculos Escolares</h4>

                                    <div class="form-group">
                                        <label for="alunoSala">Sala</label>
                                        <select id="alunoSala" class="modern-select" required></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="alunoTransporte">Transporte (Opcional)</label>
                                        <select id="alunoTransporte" class="modern-select"></select>
                                    </div>

                                    <!-- O grupo de tutores ocupará a largura total -->
                                    <div class="form-group grid-col-span-2">
                                        <label>Tutor(es) Responsáveis</label>
                                        <div class="tutor-adder"
                                            style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background-color: #f9fafb; padding: 10px; border-radius: 6px;">
                                            <input type="text" id="tutorSearchInput" placeholder="Busque um tutor..."
                                                style="flex: 2; min-width: 150px;">

                                            <select id="tutorParentescoSelect" class="modern-select"
                                                style="flex: 1; min-width: 120px;">
                                                <option value="" disabled selected>Parentesco</option>
                                                <option value="PAI">Pai</option>
                                                <option value="MAE">Mãe</option>
                                                <option value="TUTOR_LEGAL">Tutor Legal</option>
                                            </select>

                                            <button type="button" id="addTutorBtn" class="btn btn-primary"
                                                style="flex-basis: 100%; margin-top: 5px;">Adicionar Tutor</button>
                                        </div>
                                        <div id="tutorSearchResults" class="search-results"></div>
                                        <div id="selectedTutorsListContainer">
                                            <strong>Tutores Adicionados:</strong>
                                            <div id="tutorSelectedList" class="selected-items-list"
                                                style="margin-top: 10px;">
                                                <p id="noTutorsSelected" style="color: #6B7280;">Nenhum tutor adicionado
                                                    ainda.</p>
                                            </div>
                                        </div>
                                    </div>

                                </div> <!-- FIM DO NOSSO LAYOUT EM GRID -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeAlunoModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </form>


                    </div>
                </div>
            </section>
            <section id="token-management-view-content" class="content-section">
                <h2 class="mb-4">Gestão e Auditoria de Tokens de Acesso</h2>

                <!-- Filtros e Busca (Estrutura Correta) -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="filters-container">

                            <!-- Grupo 1: Campo de Busca -->
                            <div class="filter-group">
                                <label for="token-search-input" class="form-label">Buscar por Aluno ou Tutor</label>
                                <input type="text" class="custom-form-input" id="token-search-input"
                                    placeholder="Digite um nome...">
                            </div>

                            <!-- Grupo 2: Campo de Status -->
                            <div class="filter-group">
                                <label for="token-status-filter" class="form-label">Filtrar por Status</label>
                                <select id="token-status-filter" class="custom-form-input">
                                    <option value="ALL" selected>Todos</option>
                                    <option value="ACTIVE">Ativos</option>
                                    <option value="USED">Utilizados</option>
                                    <option value="EXPIRED">Expirados</option>
                                    <option value="REVOKED">Revogados</option>
                                </select>
                            </div>

                            <!-- Grupo 3: Botão -->
                            <div class="filter-group button-group">
                                <button class="btn btn-primary" id="apply-token-filters-btn">Aplicar</button>
                            </div>

                        </div>
                    </div>
                </div>


                <!-- Container da Tabela de Tokens -->
                <div id="all-tokens-container" class="card">
                    <div class="card-body">
                        <div id="all-tokens-loading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Carregando tokens...</p>
                        </div>
                        <div id="all-tokens-error" class="alert alert-danger" style="display: none;"></div>
                        <div id="all-tokens-table-container" class="table-responsive" style="display: none;">
                            <table class="content-table">
                                <thead>
                                    <tr>
                                        <th>Aluno</th>
                                        <th>Tutor (Gerador)</th>
                                        <th>Destinatário</th>
                                        <th>Gerado em</th>
                                        <th>Expira em</th>
                                        <th>Status</th>
                                        <th>Utilizado/Revogado em</th>
                                    </tr>
                                </thead>
                                <tbody id="all-tokens-tbody">
                                    <!-- Linhas de tokens serão inseridas aqui pelo JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="token-pagination-controls" class="d-flex justify-content-center mt-3">
                            <!-- Os botões de paginação serão inseridos aqui pelo JavaScript -->
                        </div>
                    </div>

            </section>

        </main>

        <!-- Modal de Confirmação de Exclusão -->
        <div id="deleteConfirmModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 id="deleteModalTitle">Confirmar Exclusão</h2>
                    <span class="close-button" onclick="closeDeleteConfirmModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">Você tem certeza que deseja realizar esta ação?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeDeleteConfirmModal()">Cancelar</button>
                    <!-- Este botão terá sua ação definida pelo JavaScript -->
                    <button type="button" id="confirmDeleteBtn" class="btn btn-delete"
                        style="background-color: #DC2626; color: white;">Sim, Excluir</button>
                </div>
            </div>
        </div>

        <!-- Notificação Toast (para mensagens de sucesso/erro) -->
        <div id="toastNotification" class="toast">
            <p id="toastMessage">Operação realizada com sucesso!</p>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        const API_URL = 'https://inoutchi-backend.onrender.com'; // URL base da sua API backend
        let ESCOLA_ID = localStorage.getItem('escolaId');     // Pega o ID da escola salvo no login
        let AUTH_TOKEN = localStorage.getItem('access_token'); // Pega o token salvo no login

        let map; // Variável global para o mapa
        let drawnItems; // Camada para os desenhos
        let savedGeofencesLayer; // Camada para exibir TODAS as geofences salvas
        let currentPage = 0;

        let selectedTutors = [];
        let currentTokenPage = 0;
        let currentPageTransportes = 0;
        let currentUser; // Variável global para armazenar os dados do usuário logado

        // Lógica para navegação entre as abas
        document.addEventListener('DOMContentLoaded', async function () {

            try {
                const response = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!response.ok) {
                    throw new Error('Falha ao autenticar e carregar dados do usuário.');
                }
                currentUser = await response.json(); // Preenche a variável global
            } catch (error) {
                console.error("Erro crítico de inicialização:", error);
                alert("Sessão inválida ou expirada. Por favor, faça o login novamente.");
                window.location.href = 'index.html';
                return;
            }

            // 1. Sua guarda de autenticação (perfeita, mantida)
            if (!AUTH_TOKEN || !ESCOLA_ID) {
                alert("Sessão inválida ou expirada. Por favor, faça o login novamente.");
                window.location.href = 'index.html';
                return;
            }

            // Mapeia cada ID de formulário à sua respectiva função de salvar (perfeito, mantido)
            const formHandlers = {
                'salaForm': saveSala,
                'diretorForm': saveDiretor,
                'transporteForm': saveTransporte,
                'tutorForm': saveTutor,
                'alunoForm': saveAluno
            };

            for (const formId in formHandlers) {
                const formElement = document.getElementById(formId);
                if (formElement) {
                    formElement.addEventListener('submit', function (event) {
                        event.preventDefault();
                        formHandlers[formId](event);
                    });
                }
            }

            // 2. Seus gatilhos de clique para carregar dados (perfeitos, mantidos)
            document.querySelector('a[data-target="salas"]').addEventListener('click', loadSalas);
            document.querySelector('a[data-target="diretores"]').addEventListener('click', loadDiretores);
            document.querySelector('a[data-target="transportes"]').addEventListener('click', () => loadTransportes(0));
            document.querySelector('a[data-target="tutores"]').addEventListener('click', () => loadAllTutors());
            document.querySelector('a[data-target="alunos"]').addEventListener('click', () => loadAlunos(0));
            document.querySelector('a[data-target="geolocalizacao"]').addEventListener('click', initMap);

            // 3. Seus botões de "Adicionar" (perfeitos, mantidos)
            const btnAdicionar = document.getElementById('btnAdicionarAluno');
            if (btnAdicionar) {
                btnAdicionar.addEventListener('click', () => openAlunoModal());
            }

            // 4. Delegação de evento para botões de exclusão na tabela de alunos (perfeito, mantido)
            const alunosTableBody = document.getElementById('alunosTableBody');
            if (alunosTableBody) {
                alunosTableBody.addEventListener('click', function (event) {
                    const deleteButton = event.target.closest('.btn-delete');
                    if (!deleteButton) return;

                    const alunoId = deleteButton.dataset.id;
                    const alunoNome = deleteButton.dataset.nome;
                    openDeleteConfirmModal(alunoId, alunoNome);
                });
            }

            // =====================================================================================
            // #### NOVA ADIÇÃO: Delegação de evento para botões de exclusão na tabela de TUTORES ####
            // =====================================================================================
            const tutoresTableBody = document.getElementById('tutoresTableBody');
            if (tutoresTableBody) {
                tutoresTableBody.addEventListener('click', function (event) {
                    // Procura pelo botão de deletar mais próximo de onde o usuário clicou
                    const deleteButton = event.target.closest('.btn-delete');

                    // Se não clicou em um botão de deletar, não faz nada
                    if (!deleteButton) return;

                    // Pega o ID e o Nome dos atributos data-* do botão
                    const tutorId = deleteButton.dataset.id;
                    const tutorNome = deleteButton.dataset.nome;

                    // Chama a função de exclusão diretamente com os dados do botão
                    deleteTutor(tutorId, tutorNome);
                });
            }
            // =====================================================================================


            // 5. Sua lógica de navegação por abas (perfeita, mantida)
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            navLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('data-target');
                    const targetSection = document.getElementById(targetId + '-content');
                    if (targetSection) {
                        targetSection.classList.add('active');
                        if (targetId === 'token-management-view') {
                            loadAllTokens();
                        }
                    }
                });
            });
        });



        /**
         * Realiza o logout do usuário, limpando a sessão e redirecionando para a página de login.
         */
        function logout() {
            // Adiciona uma confirmação para evitar logouts acidentais
            if (confirm("Você tem certeza que deseja sair do sistema?")) {

                // 1. Limpa TODOS os dados da sessão salvos no navegador.
                // Isso remove 'access_token', 'escolaId', 'token_expiry', etc.
                localStorage.clear();

                // 2. Redireciona o usuário para a página de login.
                window.location.href = 'index.html';
            }
        }

        // Função para carregar e exibir as salas
        async function loadSalas() {
            const tableBody = document.getElementById('salasTableBody');
            tableBody.innerHTML = '<tr><td colspan="2" class="empty-state">Carregando salas...</td></tr>';

            try {
                // Endpoint baseado na análise do DiretorController
                const response = await fetch(`${API_URL}/api/diretores/${ESCOLA_ID}/salas`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }

                const data = await response.json();

                // O backend retorna um objeto com 'sucesso' e 'mensagem' para lista vazia
                if (data.sucesso && data.codigo === "NENHUMA_SALA") {
                    tableBody.innerHTML = `<tr><td colspan="2" class="empty-state">${data.mensagem}</td></tr>`;
                    return;
                }

                renderSalas(data);

            } catch (error) {
                console.error('Falha ao carregar salas:', error);
                tableBody.innerHTML = '<tr><td colspan="2" class="empty-state">Erro ao carregar as salas. Tente novamente.</td></tr>';
            }
        }

        // Função para renderizar os dados na tabela
        function renderSalas(salas) {
            const tableBody = document.getElementById('salasTableBody');
            tableBody.innerHTML = '';

            salas.forEach(sala => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${sala.nome}</td>
            <td class="action-buttons">
                <button class="btn btn-edit" onclick="openSalaModal(${sala.id}, '${sala.nome}')">
                    <i class="fas fa-pencil-alt"></i> Editar
                </button>
                <button class="btn btn-delete" onclick="deleteSala(${sala.id}, '${sala.nome}')">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Funções para controlar o Modal
        const salaModal = document.getElementById('salaModal');

        function openSalaModal(id = null, nome = '') {
            const form = document.getElementById('salaForm');
            form.reset();

            const modalTitle = document.getElementById('salaModalTitle');
            const salaIdInput = document.getElementById('salaId');
            const salaNomeInput = document.getElementById('salaNome');

            if (id) {
                modalTitle.textContent = 'Editar Sala';
                salaIdInput.value = id;
                salaNomeInput.value = nome;
            } else {
                modalTitle.textContent = 'Adicionar Nova Sala';
                salaIdInput.value = '';
            }
            salaModal.style.display = 'flex';
        }

        function closeSalaModal() {
            salaModal.style.display = 'none';
        }

        // Fecha o modal se o usuário clicar fora dele
        window.onclick = function (event) {
            if (event.target == salaModal) {
                closeSalaModal();
            }
        }

        // Função para Salvar (Criar ou Editar) uma sala
        async function saveSala(event) {
            event.preventDefault();

            const salaId = document.getElementById('salaId').value;
            const nome = document.getElementById('salaNome').value;
            const isEditing = !!salaId;

            // Assumindo endpoints REST padrão para POST e PUT
            const url = isEditing ? `${API_URL}/api/salas/${salaId}` : `${API_URL}/api/salas`;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ nome: nome, escolaId: parseInt(ESCOLA_ID) }) // Enviando o nome e o ID da escola
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao salvar a sala.');
                }

                closeSalaModal();
                loadSalas(); // Recarrega a lista
                alert(`Sala "${nome}" salva com sucesso!`);

            } catch (error) {
                console.error('Erro ao salvar sala:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Função para Deletar uma sala
        async function deleteSala(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir a sala "${nome}"?`)) {
                return;
            }

            try {
                // Assumindo endpoint REST padrão para DELETE
                const response = await fetch(`${API_URL}/api/salas/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao excluir a sala.');
                }

                loadSalas(); // Recarrega a lista
                alert(`Sala "${nome}" excluída com sucesso!`);

            } catch (error) {
                console.error('Erro ao excluir sala:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Gatilho para carregar as salas quando a aba for clicada
        document.querySelector('a[data-target="salas"]').addEventListener('click', loadSalas);

        // --- LÓGICA PARA O CRUD DE DIRETORES ---

        // Função para carregar e exibir os diretores
        async function loadDiretores() {
            const tableBody = document.getElementById('diretoresTableBody');
            tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">Carregando diretores...</td></tr>';

            try {
                // Endpoint para buscar diretores associados à escola
                const response = await fetch(`${API_URL}/api/escolas/${ESCOLA_ID}/diretores`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const diretores = await response.json();
                renderDiretores(diretores);

            } catch (error) {
                console.error('Falha ao carregar diretores:', error);
                tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">Erro ao carregar os diretores.</td></tr>';
            }
        }

        // Função para renderizar os dados na tabela de diretores
        function renderDiretores(diretores) {
            const tableBody = document.getElementById('diretoresTableBody');
            tableBody.innerHTML = '';

            if (!diretores || diretores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">Nenhum diretor cadastrado.</td></tr>';
                return;
            }

            diretores.forEach(diretor => {
                const row = document.createElement('tr');
                // A função openDiretorModal agora passa o objeto inteiro para facilitar
                row.innerHTML = `
            <td>${diretor.nome}</td>
            <td>${diretor.email}</td>
            <td class="action-buttons">
                <button class="btn btn-edit" onclick='openDiretorModal(${JSON.stringify(diretor)})'>
                    <i class="fas fa-pencil-alt"></i> Editar
                </button>
                <button class="btn btn-delete" onclick="deleteDiretor(${diretor.id}, '${diretor.nome}')">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Funções para controlar o Modal de Diretor
        const diretorModal = document.getElementById('diretorModal');

        function openDiretorModal(diretor = null) {
            const form = document.getElementById('diretorForm');
            form.reset();

            const modalTitle = document.getElementById('diretorModalTitle');
            document.getElementById('diretorSenha').placeholder = "Deixe em branco para não alterar";

            if (diretor && diretor.id) { // Modo de edição
                modalTitle.textContent = 'Editar Diretor';
                document.getElementById('diretorId').value = diretor.id;
                document.getElementById('diretorNome').value = diretor.nome;
                document.getElementById('diretorEmail').value = diretor.email;
                document.getElementById('diretorCpf').value = diretor.cpf;
            } else { // Modo de criação
                modalTitle.textContent = 'Adicionar Novo Diretor';
                document.getElementById('diretorId').value = '';
                document.getElementById('diretorSenha').placeholder = "Crie uma senha para o novo diretor";
                document.getElementById('diretorSenha').required = true;
            }
            diretorModal.style.display = 'flex';
        }

        function closeDiretorModal() {
            document.getElementById('diretorSenha').required = false;
            diretorModal.style.display = 'none';
        }

        // Lógica para fechar o modal
        window.addEventListener('click', function (event) {
            if (event.target == diretorModal) {
                closeDiretorModal();
            }
        });

        // Função para Salvar (Criar ou Editar) um diretor
        async function saveDiretor(event) {
            event.preventDefault();

            const diretorId = document.getElementById('diretorId').value;
            const nome = document.getElementById('diretorNome').value;
            const email = document.getElementById('diretorEmail').value;
            const cpf = document.getElementById('diretorCpf').value;
            const senha = document.getElementById('diretorSenha').value;
            const isEditing = !!diretorId;

            // Validação simplificada: Apenas garante que a senha não está vazia ao criar.
            if (!isEditing && !senha) {
                alert('Por favor, defina uma senha para o novo diretor.');
                return;
            }

            const url = isEditing ? `${API_URL}/api/diretores/${diretorId}` : `${API_URL}/api/diretores`;
            const method = isEditing ? 'PUT' : 'POST';

            let payload = { nome, email, cpf, escolaId: ESCOLA_ID };
            // A senha só é enviada se algo foi digitado.
            if (senha) {
                payload.senha = senha;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao salvar o diretor.');
                }
                closeDiretorModal();
                loadDiretores();
                showToast(`Diretor "${nome}" salvo com sucesso!`);
            } catch (error) {
                console.error('Erro ao salvar diretor:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Função para Deletar um diretor
        async function deleteDiretor(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o diretor "${nome}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/diretores/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.mensagem || 'Erro ao excluir o diretor.');
                }

                loadDiretores();
                alert(`Diretor "${nome}" excluído com sucesso!`);

            } catch (error) {
                console.error('Erro ao excluir diretor:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Gatilho para carregar os diretores quando a aba for clicada
        document.querySelector('a[data-target="diretores"]').addEventListener('click', loadDiretores);

        // --- LÓGICA PARA O CRUD DE TRANSPORTES ---

        // Função para carregar e exibir os transportes
        async function loadTransportes() {
            const tableBody = document.getElementById('transportesTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Carregando transportes...</td></tr>';

            try {
                // Assumindo endpoint para buscar transportadores da escola
                const response = await fetch(`${API_URL}/api/transporte/${ESCOLA_ID}/transportadores`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const transportes = await response.json();
                renderTransportes(transportes);

            } catch (error) {
                console.error('Falha ao carregar transportes:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Erro ao carregar os transportes.</td></tr>';
            }
        }

        // Função para renderizar os dados na tabela de transportes
        function renderTransportes(transportes) {
            const tableBody = document.getElementById('transportesTableBody');
            tableBody.innerHTML = '';

            if (!transportes || transportes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhum transporte cadastrado.</td></tr>';
                return;
            }

            transportes.forEach(transporte => {
                const row = document.createElement('tr');
                // PAYLOAD CORRETO: Usa 'fone' que vem do DTO, em vez de 'telefone'
                // BOTÕES: Adicionado texto para clareza, mantendo os ícones.
                row.innerHTML = `
                    <td>${transporte.nome}</td>
                    <td>${transporte.email}</td>
                    <td>${transporte.fone || '-'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" onclick='openTransporteModal(${JSON.stringify(transporte)})'>
                            <i class="fas fa-pencil-alt"></i> Editar
                        </button>
                        <button class="btn btn-delete" onclick="deleteTransporte(${transporte.id}, '${transporte.nome}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Funções para controlar o Modal de Transporte
        const transporteModal = document.getElementById('transporteModal');

        /**
 * Abre o modal para criar ou editar um transporte.
 * VERSÃO CORRIGIDA: Busca os dados completos do transportador antes de editar.
 */
        async function openTransporteModal(transporteIncompleto = null) {
            const modal = document.getElementById('transporteModal');
            const form = document.getElementById('transporteForm');
            const modalTitle = document.getElementById('transporteModalTitle');
            const senhaInput = document.getElementById('transporteSenha');
            const submitButton = form.querySelector('button[type="submit"]');

            form.reset();
            modal.style.display = 'flex';
            modalTitle.textContent = 'Carregando...'; // Estado de carregamento
            submitButton.disabled = true; // Desabilita o botão salvar enquanto carrega

            try {
                if (transporteIncompleto && transporteIncompleto.id) { // MODO DE EDIÇÃO
                    modalTitle.textContent = 'Editar Transporte';

                    // 1. BUSCA OS DADOS COMPLETOS DO TRANSPORTADOR PELA API
                    const response = await fetch(`${API_URL}/api/management/transportadores/${transporteIncompleto.id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });

                    if (!response.ok) {
                        throw new Error('Não foi possível carregar os dados completos do transportador.');
                    }
                    const transporteCompleto = await response.json();

                    // 2. PREENCHE O FORMULÁRIO COM OS DADOS COMPLETOS (INCLUINDO O CPF)
                    document.getElementById('transporteId').value = transporteCompleto.id;
                    document.getElementById('transporteNome').value = transporteCompleto.nome;
                    document.getElementById('transporteEmail').value = transporteCompleto.email;
                    document.getElementById('transporteCpf').value = transporteCompleto.cpf; // Agora vai funcionar!
                    document.getElementById('transporteFone').value = transporteCompleto.fone;

                    // Lógica da senha para edição
                    senhaInput.placeholder = "Deixe em branco para não alterar";
                    senhaInput.required = false;

                } else { // MODO DE CRIAÇÃO
                    modalTitle.textContent = 'Adicionar Novo Transporte';
                    document.getElementById('transporteId').value = ''; // Garante que o ID está limpo

                    // Lógica da senha para criação
                    senhaInput.placeholder = "Crie uma senha para o novo usuário";
                    senhaInput.required = true;
                }
            } catch (error) {
                console.error("Erro ao abrir o modal de transporte:", error);
                modalTitle.textContent = 'Erro ao Carregar';
                showToast(error.message, 'error'); // Usa sua função de notificação
                setTimeout(() => modal.style.display = 'none', 2000); // Fecha o modal em caso de erro
            } finally {
                submitButton.disabled = false; // Reabilita o botão Salvar
            }
        }

        function closeTransporteModal() {
            transporteModal.style.display = 'none';
        }

        // Fecha o modal se o usuário clicar fora dele
        window.addEventListener('click', function (event) {
            if (event.target == transporteModal) {
                closeTransporteModal();
            }
        });

        // Função para Salvar (Criar ou Editar) um transporte
        async function saveTransporte(event) {
            event.preventDefault();

            const transporteId = document.getElementById('transporteId').value;
            const nome = document.getElementById('transporteNome').value;
            const cpf = document.getElementById('transporteCpf').value;
            const email = document.getElementById('transporteEmail').value;
            const fone = document.getElementById('transporteFone').value; // CAMPO CORRETO
            const senha = document.getElementById('transporteSenha').value;
            const isEditing = !!transporteId;

            // ENDPOINT CORRETO: Aponta para a API de GESTÃO
            const url = isEditing ? `${API_URL}/api/management/transportadores/${transporteId}` : `${API_URL}/api/management/transportadores`;
            const method = isEditing ? 'PUT' : 'POST';

            // PAYLOAD CORRETO: Monta o DTO com 'fone', sem 'documento'
            let payload = { nome, cpf, email, fone, escolaId: parseInt(ESCOLA_ID) };
            if (!isEditing) {
                if (!senha) {
                    alert('Por favor, defina uma senha para o novo transporte.');
                    return;
                }
                payload.senha = senha;
            } else if (senha) {
                // Em edição, só envia a senha se ela for preenchida
                payload.senha = senha;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao salvar o transporte.');
                }

                closeTransporteModal();
                loadTransportes(currentPageTransportes); // Recarrega na página atual
                alert(`Transporte "${nome}" salvo com sucesso!`);

            } catch (error) {
                console.error('Erro ao salvar transporte:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Função para Deletar um transporte
        async function deleteTransporte(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o transporte "${nome}"? Esta ação também removerá o usuário de login associado.`)) {
                return;
            }

            try {
                // ENDPOINT CORRETO: Aponta para a API de GESTÃO
                const response = await fetch(`${API_URL}/api/management/transportadores/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao excluir o transporte.');
                }

                loadTransportes(0); // Recarrega do início após deletar
                alert(`Transporte "${nome}" excluído com sucesso!`);

            } catch (error) {
                console.error('Erro ao excluir transporte:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Gatilho para carregar os transportes quando a aba for clicada
        document.querySelector('a[data-target="transportes"]').addEventListener('click', () => loadTransportes(0));

        // --- LÓGICA PARA O CRUD DE TUTORES ---
        let currentTutorsPage = 0;
        const tutorsPageSize = 10; // Define 10 tutores por página

        // Gatilho para carregar os tutores quando a aba for clicada (chama a NOVA função)
        document.querySelector('a[data-target="tutores"]').addEventListener('click', () => loadAllTutors());

        /**
         * Função principal para carregar os tutores com paginação e busca.
         */
        async function loadAllTutors(page = 0, searchTerm = '') {
            const tbody = document.getElementById('tutoresTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Carregando tutores...</td></tr>';

            // Constrói a URL da API com busca e paginação
            const url = new URL(`${API_URL}/api/tutores`);
            url.searchParams.append('page', page);
            url.searchParams.append('size', 10); // ou o tamanho da sua página
            url.searchParams.append('sort', 'nome,asc');
            if (searchTerm) {
                url.searchParams.append('nome', searchTerm);
            }

            try {
                const response = await fetch(url.toString(), {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!response.ok) throw new Error('Falha ao carregar tutores');

                const pageData = await response.json();
                tbody.innerHTML = '';

                if (!pageData.content || pageData.content.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum tutor encontrado.</td></tr>';
                    // Mesmo sem tutores, chame a paginação para que ela possa se esconder ou mostrar "0 de 0"
                    setupTutorsPagination(pageData);
                    return;
                }

                pageData.content.forEach(tutor => {
                    const tr = document.createElement('tr');
                    // Usando o HTML correto com data-attributes para o botão de deletar
                    tr.innerHTML = `
                <td>${tutor.nome}</td>
                <td>${tutor.cpf || '-'}</td>
                <td>${tutor.email}</td>
                <td>${tutor.fone || '-'}</td>
                <td class="action-buttons">
                    <button class="btn btn-edit" onclick="openTutorModal(${tutor.id})">
                        <i class="fas fa-pencil-alt"></i> Editar
                    </button>
                    <button class="btn btn-delete" data-id="${tutor.id}" data-nome="${tutor.nome}">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </td>
            `;
                    tbody.appendChild(tr);
                });

                // ===================================================
                // #### CORREÇÃO APLICADA AQUI ####
                // Chamando a função de paginação que realmente existe no seu código.
                setupTutorsPagination(pageData);
                // ===================================================

            } catch (error) {
                console.error('Erro ao carregar tutores:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state text-danger">Erro ao carregar tutores. ${error.message}</td></tr>`;
            }
        }

        /**
         * Renderiza as linhas da tabela de tutores.
         */
        function renderTutorsTable(tutores) {
            const tableBody = document.getElementById('tutoresTableBody');
            tableBody.innerHTML = '';

            if (!tutores || tutores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhum tutor encontrado.</td></tr>';
                return;
            }

            tutores.forEach(tutor => {
                const row = document.createElement('tr');
                const alunosNomes = tutor.alunos && tutor.alunos.length > 0
                    ? tutor.alunos.map(a => a.nome).join(', ')
                    : '<span style="color: #9CA3AF;">Nenhum</span>';

                // ===== MUDANÇA APLICADA AQUI =====
                // Trocamos JSON.stringify(tutor) por apenas tutor.id
                row.innerHTML = `
            <td>${tutor.nome}</td>
            <td>${tutor.email}</td>
            <td>${alunosNomes}</td>
            <td class="action-buttons">
                <button class="btn btn-edit" onclick="openTutorModal(${tutor.id})">
                    <i class="fas fa-pencil-alt"></i> Editar
                </button>
                <button class="btn btn-delete" data-id="${tutor.id}" data-nome="${tutor.nome}">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        /**
 * Configura os botões e informações da paginação dos tutores.
 */
        function setupTutorsPagination(pageData) {
            const paginationContainer = document.getElementById('tutorsPagination');
            paginationContainer.innerHTML = '';
            paginationContainer.className = 'pagination-container';

            const totalPages = pageData.totalPages;
            const pageNumber = pageData.number;
            const totalElements = pageData.totalElements;

            if (totalElements === 0) {
                paginationContainer.style.display = 'none';
                return;
            }
            paginationContainer.style.display = 'flex';

            if (totalPages <= 1) {
                paginationContainer.innerHTML = `<div class="pagination-info">Mostrando ${totalElements} de ${totalElements} registros</div>`;
                return;
            }

            const startRecord = (pageNumber * pageData.size) + 1;
            const endRecord = startRecord + pageData.numberOfElements - 1;
            const isFirstPage = pageData.first;
            const isLastPage = pageData.last;

            // A função de busca é necessária para a paginação funcionar com o filtro
            const searchTerm = document.getElementById('tutorSearch').value;

            paginationContainer.innerHTML = `
        <div class="pagination-info">Mostrando ${startRecord}-${endRecord} de ${totalElements} registros</div>
        <div class="pagination-buttons">
            <button class="btn pagination-btn" onclick="loadAllTutors(0, '${searchTerm}')" ${isFirstPage ? 'disabled' : ''}><i class="fas fa-angle-double-left"></i></button>
            <button class="btn pagination-btn" onclick="loadAllTutors(${pageNumber - 1}, '${searchTerm}')" ${isFirstPage ? 'disabled' : ''}><i class="fas fa-angle-left"></i></button>
            <span class="page-info-text">Página ${pageNumber + 1} de ${totalPages}</span>
            <button class="btn pagination-btn" onclick="loadAllTutors(${pageNumber + 1}, '${searchTerm}')" ${isLastPage ? 'disabled' : ''}><i class="fas fa-angle-right"></i></button>
            <button class="btn pagination-btn" onclick="loadAllTutors(${totalPages - 1}, '${searchTerm}')" ${isLastPage ? 'disabled' : ''}><i class="fas fa-angle-double-right"></i></button>
        </div>
    `;
        }




        // Função para popular a caixa de seleção de alunos
        async function populateAlunosSelect(selectedAlunoIds = []) {
            const select = document.getElementById('tutorAlunos');
            select.innerHTML = '<option disabled>Carregando alunos...</option>';

            try {
                const response = await fetch(`${API_URL}/api/escolas/${ESCOLA_ID}/alunos`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!response.ok) throw new Error('Falha ao buscar alunos');

                const alunos = await response.json();
                select.innerHTML = ''; // Limpa as opções

                if (alunos && alunos.length > 0) {
                    alunos.forEach(aluno => {
                        const option = document.createElement('option');
                        option.value = aluno.id;
                        option.textContent = aluno.nome;
                        // Se o ID do aluno estiver na lista de selecionados, marca o option
                        if (selectedAlunoIds.includes(aluno.id)) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option disabled>Nenhum aluno cadastrado na escola</option>';
                }

            } catch (error) {
                console.error(error);
                select.innerHTML = '<option disabled>Erro ao carregar alunos</option>';
            }
        }

        // Funções para controlar o Modal de Tutor
        const tutorModal = document.getElementById('tutorModal');

        // 2. FUNÇÃO PARA ABRIR O MODAL (PARA CRIAR OU EDITAR)
        async function openTutorModal(id = null) {
            const modal = document.getElementById('tutorModal');
            const title = document.getElementById('tutorModalTitle');
            const form = document.getElementById('tutorForm');
            const senhaInput = document.getElementById('tutorSenha');

            form.reset(); // Limpa o formulário
            document.getElementById('tutorId').value = '';

            if (id) { // Modo de Edição
                title.textContent = 'Editar Tutor';
                senhaInput.placeholder = 'Deixe em branco para não alterar';

                try {
                    const response = await fetch(`${API_URL}/api/tutores/${id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar dados do tutor.');

                    const tutor = await response.json(); // O backend retorna TutorDetalheDTO

                    document.getElementById('tutorId').value = tutor.id;
                    document.getElementById('tutorNome').value = tutor.nome;
                    document.getElementById('tutorEmail').value = tutor.email;
                    document.getElementById('tutorCpf').value = tutor.cpf;
                    document.getElementById('tutorFone').value = tutor.fone;

                } catch (error) {
                    console.error(error);
                    alert('Não foi possível carregar os dados do tutor para edição.');
                    return;
                }

            } else { // Modo de Criação
                title.textContent = 'Adicionar Novo Tutor';
                senhaInput.placeholder = 'Defina uma senha para o novo tutor';
            }

            modal.style.display = 'block';
        }

        // 3. FUNÇÃO PARA FECHAR O MODAL
        function closeTutorModal() {
            document.getElementById('tutorModal').style.display = 'none';
        }

        window.addEventListener('click', function (event) {
            if (event.target == tutorModal) {
                closeTutorModal();
            }
        });

        // 4. FUNÇÃO PARA SALVAR (CREATE E UPDATE)
        async function saveTutor(event) {
            // Previne o comportamento padrão do formulário (que é recarregar a página)
            event.preventDefault();

            // =========================================================================
            // #### A SOLUÇÃO DEFINITIVA PARA DUPLICIDADE ####
            // 1. Pega o formulário que disparou o evento.
            // 2. Encontra o botão de submit DENTRO deste formulário.
            // 3. Desabilita o botão IMEDIATAMENTE.
            // Isso cria uma "trava" que impede que a segunda requisição (ambiental) seja processada.
            // =========================================================================
            const form = event.target;
            const saveButton = form.querySelector('button[type="submit"]');

            if (saveButton.disabled) {
                // Se o botão já estiver desabilitado, ignora esta chamada completamente.
                return;
            }
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            const tutorId = document.getElementById('tutorId').value;
            const isEditing = !!tutorId;

            try {
                const nome = document.getElementById('tutorNome').value.trim();
                const email = document.getElementById('tutorEmail').value.trim();
                const cpf = document.getElementById('tutorCpf').value.trim();
                const senha = document.getElementById('tutorSenha').value;

                if (!nome || !email || !cpf) {
                    throw new Error('Nome, Email e CPF são obrigatórios.');
                }
                if (!isEditing && !senha) {
                    throw new Error('Por favor, defina uma senha para o novo tutor.');
                }

                const payload = { nome, email, cpf, senha, fone: document.getElementById('tutorFone').value.trim() };

                if (isEditing && !payload.senha) {
                    delete payload.senha;
                }

                const url = isEditing ? `${API_URL}/api/tutores/${tutorId}` : `${API_URL}/api/tutores`;
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: JSON.stringify(payload)
                });

                if (!response.ok && response.status !== 409) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Erro ao processar a solicitação.');
                }

                closeTutorModal();
                loadAllTutors();
                alert(`Tutor "${nome}" salvo com sucesso!`);

            } catch (error) {
                console.error('Erro ao salvar tutor:', error);
                alert(`Erro: ${error.message}`);
            } finally {
                // Garante que o botão seja reativado, não importa o que aconteça.
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar';
            }
        }

        // 5. FUNÇÃO PARA DELETAR UM TUTOR (DELETE)
        async function deleteTutor(id, nome) {

            try {
                const response = await fetch(`${API_URL}/api/tutores/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.mensagem || `Erro ${response.status} ao excluir o tutor.`);
                }

                alert(`Tutor "${nome}" excluído com sucesso!`);
                loadTutores();

            } catch (error) {
                console.error('Erro ao excluir tutor:', error);
                alert(`Erro: ${error.message}`);
            }
        }

        // Vincula o evento de submit do formulário
        document.getElementById('tutorForm').addEventListener('submit', saveTutor);

        // 1. FUNÇÃO PARA CARREGAR E EXIBIR A LISTA DE TUTORES (READ)
        async function loadTutores(page = 0) {
            // CORREÇÃO: Usando o ID correto da sua tabela: 'tutoresTableBody'
            const tbody = document.getElementById('tutoresTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Carregando tutores...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/api/tutores?page=${page}&size=10&sort=nome,asc`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const pageData = await response.json();
                tbody.innerHTML = '';

                if (pageData.content.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nenhum tutor encontrado.</td></tr>';
                    return;
                }

                pageData.content.forEach(tutor => {
                    const tr = document.createElement('tr');

                    // ==================================================================
                    // ===== A CORREÇÃO DEFINITIVA ESTÁ AQUI =====
                    // 1. Usando o seu estilo de botão ("btn-edit", ícone, etc.)
                    // 2. Passando APENAS o ID numérico: onclick="openTutorModal(${tutor.id})"
                    // ==================================================================
                    tr.innerHTML = `
                <td>${tutor.nome}</td>
                <td>${tutor.cpf || '-'}</td>
                <td>${tutor.email}</td>
                <td>${tutor.fone || '-'}</td>
                <td class="action-buttons">
                    <button class="btn btn-edit" onclick="openTutorModal(${tutor.id})">
                        <i class="fas fa-pencil-alt"></i> Editar
                    </button>
                    <button class="btn btn-delete" onclick="deleteTutor(${tutor.id}, '${tutor.nome}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </td>
            `;
                    tbody.appendChild(tr);
                });

                // setupPagination(pageData, 'tutors-pagination', loadTutores);

            } catch (error) {
                console.error('Falha ao carregar tutores:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state text-danger">Falha ao carregar tutores.</td></tr>`;
            }
        }

        // --- LÓGICA PARA O CRUD DE ALUNOS ---

        /**
         * Carrega a lista de alunos da escola logada e renderiza na tabela.
         * Função para carregar e exibir os alunos com paginação e busca.
         */
        async function loadAlunos(page = 0, searchTerm = '') { // 1. Adicionado 'searchTerm'
            currentPage = page;
            const tableBody = document.getElementById('alunosTableBody');
            // CORREÇÃO: Sua tabela agora tem 4 colunas, então o colspan deve ser 4.
            tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Carregando alunos...</td></tr>';

            try {
                // 2. Construção dinâmica da URL
                let url = `${API_URL}/api/alunos?page=${page}&size=10&sort=nome,asc`;

                // Adiciona o parâmetro de busca à URL, se ele foi fornecido
                if (searchTerm) {
                    url += `&nome=${encodeURIComponent(searchTerm)}`;
                }

                const response = await fetch(url, { // A variável 'url' agora contém a busca
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const pageData = await response.json();
                renderAlunos(pageData.content);
                renderPagination(pageData);

            } catch (error) {
                console.error('Falha ao carregar alunos:', error);
                // CORREÇÃO: colspan ajustado para 4 também no erro.
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Erro ao carregar os alunos.</td></tr>';
            }
        }

        /**
         * Função chamada pelo botão "Buscar" na página de Alunos.
         */
        function searchAlunos() {
            const searchTerm = document.getElementById('alunoSearch').value;
            loadAlunos(0, searchTerm); // Inicia a busca sempre pela primeira página
        }

        /**
         * Renderiza os controles de paginação, agora ciente do termo de busca.
         * (VERSÃO FINAL)
         */
        function renderPagination(pageData) {
            const paginationContainer = document.getElementById('pagination-controls');
            paginationContainer.innerHTML = '';
            paginationContainer.className = 'pagination-container';

            const totalPages = pageData.totalPages;
            const pageNumber = pageData.number;
            const totalElements = pageData.totalElements;

            if (totalElements === 0) {
                paginationContainer.innerHTML = `<div class="pagination-info">Nenhum aluno encontrado.</div>`;
                return;
            }
            paginationContainer.style.display = 'flex';

            if (totalPages <= 1) {
                paginationContainer.innerHTML = `<div class="pagination-info">Mostrando 1-${totalElements} de ${totalElements} registros</div>`;
                return;
            }

            const startRecord = (pageNumber * pageData.size) + 1;
            const endRecord = startRecord + pageData.numberOfElements - 1;
            const isFirstPage = pageData.first;
            const isLastPage = pageData.last;

            // Pega o termo de busca atual para manter o filtro na paginação
            const searchTerm = document.getElementById('alunoSearch')?.value || '';

            paginationContainer.innerHTML = `
        <div class="pagination-info">Mostrando ${startRecord}-${endRecord} de ${totalElements} registros</div>
        <div class="pagination-buttons">
            <button class="btn pagination-btn" onclick="loadAlunos(0, '${searchTerm}')" ${isFirstPage ? 'disabled' : ''} title="Primeira Página"><i class="fas fa-angle-double-left"></i></button>
            <button class="btn pagination-btn" onclick="loadAlunos(${pageNumber - 1}, '${searchTerm}')" ${isFirstPage ? 'disabled' : ''} title="Página Anterior"><i class="fas fa-angle-left"></i></button>
            <span class="page-info-text">Página ${pageNumber + 1} de ${totalPages}</span>
            <button class="btn pagination-btn" onclick="loadAlunos(${pageNumber + 1}, '${searchTerm}')" ${isLastPage ? 'disabled' : ''} title="Próxima Página"><i class="fas fa-angle-right"></i></button>
            <button class="btn pagination-btn" onclick="loadAlunos(${totalPages - 1}, '${searchTerm}')" ${isLastPage ? 'disabled' : ''} title="Última Página"><i class="fas fa-angle-double-right"></i></button>
        </div>
    `;
        }


        /**
         * Renderiza os dados dos alunos na tabela.
         */
        // Função para renderizar os dados na tabela de alunos
        function renderAlunos(alunos) {
            const tableBody = document.getElementById('alunosTableBody');
            tableBody.innerHTML = '';

            if (!alunos || alunos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhum aluno cadastrado.</td></tr>';
                return;
            }

            alunos.forEach(aluno => {
                const row = document.createElement('tr');

                const tutoresNomes = aluno.tutores && aluno.tutores.length > 0
                    ? aluno.tutores.map(t => t.nome).join(', ')
                    : '<span style="color: #9CA3AF;">Nenhum</span>';

                // REMOVEMOS o onclick e adicionamos data-attributes.
                row.innerHTML = `
            <td>${aluno.nome}</td>
            <td>${aluno.salaNome || 'Sem sala'}</td>
            <td>${tutoresNomes}</td>
            <td class="action-buttons">
                <button class="btn btn-edit" onclick='openAlunoModal(${JSON.stringify(aluno)})'>
                    <i class="fas fa-pencil-alt"></i> Editar
                </button>
                <button class="btn btn-delete" data-id="${aluno.id}" data-nome="${aluno.nome}">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // --- Funções para popular os <select> do modal de Aluno ---
        async function populateSalasSelect(selectedId = null) {
            const select = document.getElementById('alunoSala');
            select.innerHTML = '<option value="">Carregando...</option>';
            const response = await fetch(`${API_URL}/api/diretores/${ESCOLA_ID}/salas`, { headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` } });
            const salas = await response.json();
            select.innerHTML = '<option value="">Selecione uma sala</option>';
            salas.forEach(sala => {
                const option = new Option(sala.nome, sala.id);
                if (sala.id === selectedId) option.selected = true;
                select.add(option);
            });
        }

        async function populateTransportesSelect(selectedId = null) {
            const select = document.getElementById('alunoTransporte');
            select.innerHTML = '<option value="">Carregando...</option>';

            try {
                // URL corrigida para apontar para o novo endpoint no DiretorController
                const response = await fetch(`${API_URL}/api/transporte/${ESCOLA_ID}/transportadores`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) {
                    throw new Error(`Falha na requisição: ${response.statusText}`);
                }

                const transportes = await response.json();

                select.innerHTML = '<option value="">Nenhum (Opcional)</option>'; // Opção padrão

                if (transportes && transportes.length > 0) {
                    transportes.forEach(transporte => {
                        const option = new Option(transporte.nome, transporte.id);
                        if (transporte.id === selectedId) {
                            option.selected = true;
                        }
                        select.add(option);
                    });
                }
                // Se a lista vier vazia, ele apenas mostrará a opção "Nenhum".

            } catch (error) {
                console.error("Erro ao carregar transportadores:", error);
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }
        }

        async function populateTutoresMultiSelect(selectedIds = []) {
            const select = document.getElementById('alunoTutores');
            select.innerHTML = '<option>Carregando...</option>';
            const response = await fetch(`${API_URL}/api/escolas/${ESCOLA_ID}/tutores`, { headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` } });
            const tutores = await response.json();
            select.innerHTML = '';
            tutores.forEach(tutor => {
                const option = new Option(tutor.nome, tutor.id);
                if (selectedIds.includes(tutor.id)) option.selected = true;
                select.add(option);
            });
        }

        // Funções para controlar o Modal de Aluno
        const alunoModal = document.getElementById('alunoModal');

        /**
 * Abre o modal para criar ou editar um aluno.
 * Esta versão garante que a busca de tutores funcione em AMBOS os modos.
 */
        async function openAlunoModal(alunoIncompleto = null) {
            const modal = document.getElementById('alunoModal');
            const modalTitle = document.getElementById('alunoModalTitle');
            const form = document.getElementById('alunoForm');
            const submitButton = form.querySelector('button[type="submit"]');

            form.reset();
            modal.style.display = 'flex';
            modalTitle.textContent = 'Carregando Dados...';
            submitButton.disabled = true;

            // =======================================================================
            // #### INÍCIO DA CORREÇÃO ####
            // Limpa o estado anterior e RECONECTA OS EVENTOS a cada abertura do modal.
            // =======================================================================
            selectedTutors = [];
            renderSelectedTutors();
            document.getElementById('tutorSearchInput').oninput = (e) => searchTutors(e.target.value);
            document.getElementById('addTutorBtn').onclick = handleAddTutor;
            document.getElementById('tutorSearchResults').innerHTML = '';
            // =======================================================================
            // #### FIM DA CORREÇÃO ####
            // =======================================================================

            try {
                let alunoCompleto = null;

                if (alunoIncompleto && alunoIncompleto.id) {
                    // --- MODO DE EDIÇÃO ---
                    const response = await fetch(`${API_URL}/api/alunos/${alunoIncompleto.id}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    if (!response.ok) {
                        throw new Error('Não foi possível carregar os dados completos do aluno para edição.');
                    }
                    alunoCompleto = await response.json();
                    modalTitle.textContent = 'Editar Aluno';
                } else {
                    // --- MODO DE CRIAÇÃO ---
                    modalTitle.textContent = 'Adicionar Novo Aluno';
                }

                // Popula os dropdowns (salas e transportes)
                await Promise.all([
                    populateSalasSelect(alunoCompleto ? alunoCompleto.salaId : null),
                    populateTransportesSelect(alunoCompleto ? alunoCompleto.transporteId : null)
                ]);

                // Preenche o formulário com os dados do objeto COMPLETO (se existir)
                if (alunoCompleto) {
                    document.getElementById('alunoId').value = alunoCompleto.id;
                    document.getElementById('alunoNome').value = alunoCompleto.nome;
                    document.getElementById('alunoNascimento').value = alunoCompleto.dataAniversario ? alunoCompleto.dataAniversario.split('T')[0] : '';
                    document.getElementById('alunoStatus').value = alunoCompleto.status;

                    if (alunoCompleto.tutores && alunoCompleto.tutores.length > 0) {
                        selectedTutors = alunoCompleto.tutores.map(t => ({ id: t.id, nome: t.nome, parentesco: t.parentesco || 'INDEFINIDO' }));
                        renderSelectedTutors();
                    }
                } else {
                    // Garante que campos ocultos estejam limpos para o modo de criação
                    document.getElementById('alunoId').value = '';
                    document.getElementById('alunoStatus').value = 'AUSENTE'; // Status padrão
                }

            } catch (error) {
                console.error("Erro ao preparar o modal do aluno:", error);
                modalTitle.textContent = 'Erro ao Carregar Dados';
                setTimeout(() => closeAlunoModal(), 1500);
            } finally {
                submitButton.disabled = false;
            }
        }


        /**
 * Salva um aluno (cria um novo ou atualiza um existente).
 * VERSÃO FINAL E LIMPA.
 */
        async function saveAluno(event) {
            event.preventDefault();
            const submitButton = document.querySelector('#alunoForm button[type="submit"]');

            const tutorSearchInput = document.getElementById('tutorSearchInput');
            const form = document.getElementById('alunoForm');
            tutorSearchInput.setCustomValidity('');

            if (selectedTutors.length === 0) {
                tutorSearchInput.setCustomValidity('É obrigatório adicionar ao menos um tutor para o aluno.');
                form.reportValidity();
                return;
            }

            try {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                const alunoId = document.getElementById('alunoId').value;
                const isEditing = !!alunoId;

                const tutoresPayload = selectedTutors.map(t => ({ id: t.id, parentesco: t.parentesco }));

                // Monta o payload base
                let payload = {
                    nome: document.getElementById('alunoNome').value,
                    dataAniversario: document.getElementById('alunoNascimento').value,
                    salaId: parseInt(document.getElementById('alunoSala').value),
                    tutores: tutoresPayload,
                    status: document.getElementById('alunoStatus').value
                };

                // Adiciona o escolaId apenas na criação
                if (!isEditing) {
                    payload.escolaId = parseInt(ESCOLA_ID);
                }

                const transporteId = document.getElementById('alunoTransporte').value;
                if (transporteId) {
                    payload.transporteId = parseInt(transporteId);
                }

                const url = isEditing ? `${API_URL}/api/alunos/${alunoId}` : `${API_URL}/api/alunos`;
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${AUTH_TOKEN}` },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro desconhecido ao salvar o aluno.');
                }

                closeAlunoModal();
                loadAlunos(currentPage);

            } catch (error) {
                console.error('Erro ao salvar aluno:', error);
                if (error.message !== 'Validação falhou: nenhum tutor selecionado.') {
                    alert(`Erro: ${error.message}`);
                }
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Salvar';
                }
            }
        }

        /**
         * Fecha o modal de aluno.
         */
        function closeAlunoModal() {
            document.getElementById('alunoModal').style.display = 'none';
        }

        window.addEventListener('click', function (event) {
            if (event.target == alunoModal) {
                closeAlunoModal();
            }
        });


        /**
     * Carrega as salas da escola logada e preenche o dropdown no modal.
     */
        async function loadSalasDropdown() {
            const salaSelect = document.getElementById('alunoSala');
            salaSelect.innerHTML = '<option value="">Carregando salas...</option>';

            try {
                // Assumindo que você tenha um endpoint para listar salas da escola
                const response = await fetch(`${API_URL}/api/diretores/${ESCOLA_ID}/salas`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) {
                    console.error(`Falha ao buscar salas. Status: ${response.status}`);
                    throw new Error('Falha ao buscar salas.');
                }

                const responseData = await response.json();
                // O endpoint pode retornar um objeto de erro ou um array
                const salas = responseData.error ? [] : responseData;

                salaSelect.innerHTML = '<option value="">Selecione a Sala</option>';
                if (salas.length > 0) {
                    salas.forEach(sala => {
                        const option = document.createElement('option');
                        option.value = sala.id;
                        option.textContent = sala.nome;
                        salaSelect.appendChild(option);
                    });
                } else {
                    salaSelect.innerHTML = '<option value="">Nenhuma sala encontrada</option>';
                }

            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                salaSelect.innerHTML = '<option value="">Erro ao carregar salas</option>';
            }
        }

        // --- LÓGICA PARA A GEOLOCALIZAÇÃO ---

        // =================================================================
        // #### A VERSÃO FINAL, COMPLETA E CORRETA DA initMap ####
        // =================================================================
        function initMap() {
            // Trava de segurança: Se o mapa já foi criado, não faz nada.
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
                return;
            }

            // Inicializa o mapa e as camadas (esta parte está correta)
            map = L.map('map').setView([-15.7801, -47.9292], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            drawnItems = new L.FeatureGroup();
            savedGeofencesLayer = new L.FeatureGroup();
            map.addLayer(drawnItems);
            map.addLayer(savedGeofencesLayer);

            var drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems, remove: false, edit: false },
                draw: { polygon: false, polyline: false, rectangle: false, marker: false, circle: true }
            });
            map.addControl(drawControl);

            // Adiciona os listeners de eventos (esta parte está correta)
            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                const latlng = layer.getLatLng();
                const radius = layer.getRadius();
                document.getElementById('geofenceLatitude').value = latlng.lat.toFixed(6);
                document.getElementById('geofenceLongitude').value = latlng.lng.toFixed(6);
                document.getElementById('geofenceRaio').value = radius.toFixed(2);
                showAlert('Área desenhada! Preencha os detalhes e salve.', 'info');
                drawnItems.clearLayers();
                drawnItems.addLayer(layer);
            });

            const coordsDisplay = document.getElementById('map-coordinates-display');
            map.on('click', function (e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                coordsDisplay.innerHTML = `<span>Coordenadas do Ponto: <b>${lat}, ${lng}</b></span>`;
            });

            map.on('mousemove', function (e) {
                if (!map.drawing) {
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    coordsDisplay.innerHTML = `<span>Coordenadas do Mouse: <b>${lat}, ${lng}</b></span>`;
                }
            });

            // ===============================================================
            // A CORREÇÃO LÓGICA:
            // Nós esperamos um instante para a aba se tornar visível.
            // ===============================================================
            setTimeout(() => {
                // PRIMEIRO: Forçamos o mapa a se redimensionar corretamente.
                map.invalidateSize();

                loadAndRenderGeofenceList();
            }, 100);


            // SEGUNDO: SÓ DEPOIS que o mapa está estável, nós carregamos
            // a função que desenha os círculos.
            //loadGeofences();

        //}, 150); // Um tempo de espera seguro.
        }

        // Limpa o formulário e o desenho temporário
        function resetGeofenceForm() {
            document.getElementById('geofenceForm').reset();
            document.getElementById('geofenceId').value = '';
            document.getElementById('geofenceLatitude').value = '';
            document.getElementById('geofenceLongitude').value = '';
            document.getElementById('geofenceRaio').value = '';
            drawnItems.clearLayers();
        }

        async function loadAndRenderGeofenceList() {
            if (!currentUser || !currentUser.escolaId) return;

            const listContainer = document.getElementById('geofenceList');
            listContainer.innerHTML = '<p>Carregando áreas...</p>';

            try {
                const response = await fetch(`${API_URL}/api/geofences/escola/${currentUser.escolaId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (response.status === 404) {
                    listContainer.innerHTML = '<p>Nenhuma área de geolocalização foi criada ainda.</p>';
                    return;
                }
                if (!response.ok) throw new Error('Falha ao carregar as áreas.');

                const geofences = await response.json();
                listContainer.innerHTML = '';

                if (geofences.length === 0) {
                    listContainer.innerHTML = '<p>Nenhuma área de geolocalização foi criada ainda.</p>';
                    return;
                }

                // Cria os itens na lista HTML
                geofences.forEach(geofence => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    const tipoClass = geofence.tipo === 'ENTRADA' ? 'entrada' : 'saida';
                    item.innerHTML = `
                <span>
                    <i class="fas fa-map-marker-alt" style="color: ${geofence.tipo === 'ENTRADA' ? 'green' : 'red'};"></i>
                    ${geofence.nome}
                    <strong class="geofence-type-strong type-${tipoClass}">(${geofence.tipo})</strong>
                </span>
                <div>
                    <button class="btn-icon" onclick='populateGeofenceForm(${JSON.stringify(geofence)})' title="Editar Área"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon btn-delete" onclick='deleteGeofence(${geofence.id}, "${geofence.nome}")' title="Excluir Área"><i class="fas fa-trash"></i></button>
                </div>
            `;
                    listContainer.appendChild(item);
                });

            } catch (error) {
                listContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
            }
        }

        // Carrega as geofences da API e as exibe no mapa e na lista
        async function loadGeofences() {
            if (!currentUser || !currentUser.escolaId) return;

            const listContainer = document.getElementById('geofenceList');
            listContainer.innerHTML = '<p>Carregando áreas...</p>';

            try {
                const response = await fetch(`${API_URL}/api/geofences/escola/${currentUser.escolaId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (response.status === 404) {
                    listContainer.innerHTML = '<p>Nenhuma área de geolocalização foi criada ainda.</p>';
                    return;
                }
                if (!response.ok) throw new Error('Falha ao carregar as áreas.');

                const geofences = await response.json();
                listContainer.innerHTML = '';

                if (geofences.length === 0) {
                    listContainer.innerHTML = '<p>Nenhuma área de geolocalização foi criada ainda.</p>';
                    return;
                }

                // Limpa e redesenha as geocercas salvas no mapa
                savedGeofencesLayer.clearLayers();
                geofences.forEach(geofence => {
                    const color = geofence.tipo === 'ENTRADA' ? 'green' : 'red';
                    L.circle([geofence.latitude, geofence.longitude], {
                        radius: geofence.raioMetros,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.2
                    }).bindPopup(`<b>${geofence.nome}</b><br>${geofence.tipo}`).addTo(savedGeofencesLayer);
                });

                // Cria os itens na lista HTML
                geofences.forEach(geofence => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    const tipoClass = geofence.tipo === 'ENTRADA' ? 'entrada' : 'saida';
                    item.innerHTML = `
                <span>
                    <i class="fas fa-map-marker-alt" style="color: ${geofence.tipo === 'ENTRADA' ? 'green' : 'red'};"></i>
                    ${geofence.nome} 
                    <strong class="geofence-type-strong type-${tipoClass}">(${geofence.tipo})</strong>
                </span>
                <div>
                    <button class="btn-icon" onclick='populateGeofenceForm(${JSON.stringify(geofence)})' title="Editar Área"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon btn-delete" onclick='deleteGeofence(${geofence.id}, "${geofence.nome}")' title="Excluir Área"><i class="fas fa-trash"></i></button>
                </div>
            `;
                    listContainer.appendChild(item);
                });

            } catch (error) {
                listContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
            }
        }


        // Preenche o formulário com os dados de uma geofence para edição
        function populateGeofenceForm(geofence) {
            document.getElementById('geofenceId').value = geofence.id;
            document.getElementById('geofenceNome').value = geofence.nome;
            document.getElementById('geofenceTipo').value = geofence.tipo;
            document.getElementById('geofenceLatitude').value = geofence.latitude;
            document.getElementById('geofenceLongitude').value = geofence.longitude;
            document.getElementById('geofenceRaio').value = geofence.raioMetros;

            // Desenha o círculo no mapa para visualização
            drawnItems.clearLayers();
            const circle = L.circle([geofence.latitude, geofence.longitude], { radius: geofence.raioMetros });
            drawnItems.addLayer(circle);
            map.fitBounds(circle.getBounds()); // Centraliza o mapa no círculo

            window.scrollTo(0, 0); // Rola a página para o topo
            showAlert('Editando área. Modifique os dados ou o desenho e salve.', 'info');
        }

        async function saveGeofence(event) {
            event.preventDefault(); // Impede o recarregamento da página

            const form = document.getElementById('geofenceForm');
            const saveButton = form.querySelector('button[type="submit"]');

            if (saveButton.disabled) return;
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const geofenceId = document.getElementById('geofenceId').value;
                const latitude = document.getElementById('geofenceLatitude').value;

                if (!latitude) {
                    throw new Error("Desenhe uma área no mapa antes de salvar.");
                }

                const body = {
                    escolaId: currentUser.escolaId,
                    nome: document.getElementById('geofenceNome').value,
                    tipo: document.getElementById('geofenceTipo').value,
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(document.getElementById('geofenceLongitude').value),
                    raioMetros: parseFloat(document.getElementById('geofenceRaio').value),
                    ativo: true
                };

                const isUpdate = !!geofenceId;
                const url = isUpdate ? `${API_URL}/api/geofences/${geofenceId}` : `${API_URL}/api/geofences`;
                const method = isUpdate ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.mensagem || `Erro HTTP ${response.status}. A API não retornou uma mensagem clara.`);
                }

                showAlert('Área salva com sucesso!', 'success');
                resetGeofenceForm();
                loadGeofences();

            } catch (error) {
                // Agora, qualquer erro REAL será capturado e exibido.
                console.error("Erro em saveGeofence:", error);
                showAlert(error.message, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Área';
            }
        }


        // Deleta uma geofence
        async function deleteGeofence(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir a área "${nome}"?`)) {
                return;
            }

            const accessToken = localStorage.getItem('access_token');
            // Assumindo que o endpoint de deleção seja DELETE /api/geofences/{id}
            const url = `${BACKEND_URL}/api/geofences/${id}`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) {
                    throw new Error('Falha ao excluir a área.');
                }

                showAlert('Área excluída com sucesso!', 'success');
                loadGeofences(); // Recarrega

            } catch (error) {
                showAlert(error.message, 'error');
            }
        }



        // Gatilho para inicializar o mapa quando a aba for clicada
        document.querySelector('a[data-target="geolocalizacao"]').addEventListener('click', initMap);

        //=======================================================================
        // =========== LÓGICA PARA GESTÃO DE TOKENS (DASHBOARD ESCOLA) ===========
        //=======================================================================

        // --- 1. Variáveis e Event Listeners ---
        const navTokenManagement = document.getElementById('nav-token-management');
        const tokenManagementView = document.getElementById('token-management-view');

        const allTokensLoading = document.getElementById('all-tokens-loading');
        const allTokensError = document.getElementById('all-tokens-error');
        const allTokensTableContainer = document.getElementById('all-tokens-table-container');
        const allTokensTbody = document.getElementById('all-tokens-tbody');

        const applyTokenFiltersBtn = document.getElementById('apply-token-filters-btn');

        // Adiciona listener para o botão de aplicar filtros
        applyTokenFiltersBtn.addEventListener('click', loadAllTokens);

        // --- 2. Função Principal para Carregar Tokens ---
        async function loadAllTokens() {
            allTokensLoading.style.display = 'block';
            allTokensError.style.display = 'none';
            allTokensTableContainer.style.display = 'none';
            document.getElementById('token-pagination-controls').innerHTML = ''; // Limpa a paginação antiga

            try {
                if (!AUTH_TOKEN) {
                    throw new Error("Token de autenticação não encontrado. Por favor, faça o login novamente.");
                }

                // A URL agora é dinâmica e envia a página desejada.
                const response = await fetch(`${API_URL}/api/escolas/tokens/all?page=${currentTokenPage}&size=10`, {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Falha ao buscar os tokens da escola." }));
                    throw new Error(errorData.message || `Ocorreu um erro no servidor: ${response.statusText}`);
                }

                const data = await response.json(); // 'data' agora é o objeto Page do Spring

                // Interpretamos a resposta paginada do backend.
                // A lista de tokens agora está dentro da propriedade 'content'.
                if (data && Array.isArray(data.content)) {
                    renderAllTokens(data.content); // Passamos apenas a lista de tokens para renderizar a tabela.

                    // Chamamos a nova função para renderizar os botões de paginação.
                    renderTokenPagination(data.totalPages, data.number);

                    allTokensTableContainer.style.display = 'block';
                } else {
                    throw new Error('A resposta do servidor não continha um formato de tokens paginado esperado.');
                }

            } catch (error) {
                allTokensError.textContent = `Erro: ${error.message}`;
                allTokensError.style.display = 'block';
            } finally {
                allTokensLoading.style.display = 'none';
            }
        }

        /**
         * Renderiza a tabela de auditoria de tokens (VERSÃO SOMENTE-LEITURA).
         */
        function renderAllTokens(tokens) {
            const allTokensTbody = document.getElementById('all-tokens-tbody');
            allTokensTbody.innerHTML = '';

            // A lógica de filtros continua a mesma e é muito útil para a auditoria
            const searchTerm = document.getElementById('token-search-input').value.toLowerCase();
            const statusFilter = document.getElementById('token-status-filter').value;

            const filteredTokens = tokens.filter(token => {
                const isMatchSearch = !searchTerm ||
                    (token.aluno && token.aluno.nome.toLowerCase().includes(searchTerm)) ||
                    (token.tutor && token.tutor.nome.toLowerCase().includes(searchTerm));

                if (!isMatchSearch) return false;

                const isExpired = new Date(token.dataExpiracao) < new Date();
                let currentStatus = '';
                if (token.utilizado) currentStatus = 'USED';
                else if (!token.valido) currentStatus = 'REVOKED';
                else if (isExpired) currentStatus = 'EXPIRED';
                else currentStatus = 'ACTIVE';

                return statusFilter === 'ALL' || statusFilter === currentStatus;
            });

            if (filteredTokens.length === 0) {
                // A tabela agora tem 7 colunas
                allTokensTbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Nenhum token encontrado para os filtros aplicados.</td></tr>';
                return;
            }

            filteredTokens.sort((a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));

            filteredTokens.forEach(token => {
                let statusBadge;
                const isExpired = new Date(token.dataExpiracao) < new Date();

                if (token.utilizado) {
                    statusBadge = '<span class="token-status token-status-utilizado">Utilizado</span>';
                } else if (!token.valido) {
                    statusBadge = '<span class="token-status token-status-revogado">Revogado</span>';
                } else if (isExpired) {
                    statusBadge = '<span class="token-status token-status-expirado">Expirado</span>';
                } else {
                    statusBadge = '<span class="token-status token-status-ativo">Ativo</span>';
                }

                // Formata as datas para exibição, tratando valores nulos
                const dataCriacaoFmt = new Date(token.dataCriacao).toLocaleString('pt-BR');
                const dataExpiracaoFmt = new Date(token.dataExpiracao).toLocaleString('pt-BR');
                // A data de utilização pode ser nula, então tratamos isso
                const dataUtilizacaoFmt = token.dataUtilizacao
                    ? new Date(token.dataUtilizacao).toLocaleString('pt-BR')
                    : 'N/A';

                // MUDANÇA PRINCIPAL: A nova estrutura da linha da tabela
                const row = `
            <tr>
                <td>${token.aluno?.nome ?? 'N/A'}</td>
                <td>${token.tutor?.nome ?? 'N/A'}</td>
                <td>${token.destinatario?.nome ?? 'N/A'}</td>
                <td>${dataCriacaoFmt}</td>
                <td>${dataExpiracaoFmt}</td>
                <td>${statusBadge}</td>
                <td>${dataUtilizacaoFmt}</td>
            </tr>`;
                allTokensTbody.innerHTML += row;
            });
        }

        //Inicio correções Modal Adicionar Novo Aluno 03/01/26
        //
        //
        //
        //////////////////////////////////////////////////////

        let allFetchedTutors = []; // Armazena todos os tutores buscados para referência

        // Função para renderizar a lista de tutores que já foram adicionados
        function renderSelectedTutors() {
            const listContainer = document.getElementById('tutorSelectedList');
            // Limpa completamente o conteúdo do container
            listContainer.innerHTML = '';

            if (selectedTutors.length === 0) {
                // Se a lista estiver vazia, adiciona a mensagem de "nenhum tutor" de volta
                listContainer.innerHTML = '<p id="noTutorsSelected" style="color: #6B7280;">Nenhum tutor adicionado ainda.</p>';
            } else {
                // Se houver tutores, cria e adiciona cada um como um 'span'
                selectedTutors.forEach(tutor => {
                    const item = document.createElement('span');
                    item.className = 'selected-item'; // Adiciona uma classe para estilização, se necessário
                    item.innerHTML = `${tutor.nome} <strong>(${tutor.parentesco})</strong> <button type="button" class="remove-btn" onclick="handleRemoveTutor(${tutor.id})">&times;</button>`;
                    listContainer.appendChild(item);
                });
            }
        }

        // Função chamada pelo botão "Adicionar Tutor"
        function handleAddTutor() {
            const searchInput = document.getElementById('tutorSearchInput');
            const parentescoSelect = document.getElementById('tutorParentescoSelect');
            const tutorNome = searchInput.value;
            const parentesco = parentescoSelect.value;

            // Validação
            if (!tutorNome || !parentesco) {
                alert('Por favor, selecione um tutor da busca e defina o parentesco antes de adicionar.');
                return;
            }

            const tutorData = allFetchedTutors.find(t => t.nome === tutorNome);
            if (!tutorData) {
                alert('Tutor inválido. Por favor, selecione um nome da lista de sugestões.');
                return;
            }

            // Verifica se já não foi adicionado
            if (selectedTutors.some(t => t.id === tutorData.id)) {
                alert('Este tutor já foi adicionado.');
                return;
            }

            // Adiciona ao array global
            selectedTutors.push({
                id: tutorData.id,
                nome: tutorData.nome,
                parentesco: parentesco
            });

            // Limpa a mensagem de erro customizada, marcando o campo como válido novamente
            document.getElementById('tutorSearchInput').setCustomValidity('');

            // Atualiza a UI
            renderSelectedTutors();

            // Limpa os campos para a próxima adição
            searchInput.value = '';
            parentescoSelect.value = '';
            document.getElementById('tutorSearchResults').innerHTML = '';
        }

        // Função para remover um tutor da lista de selecionados
        function handleRemoveTutor(tutorId) {
            selectedTutors = selectedTutors.filter(t => t.id !== tutorId);
            renderSelectedTutors();
        }

        /**
         * Função de busca chamada pelo botão "Buscar" na PÁGINA DE TUTORES.
         */
        function searchTutorsOnListPage() {
            const searchTerm = document.getElementById('tutorSearch').value;
            loadAllTutors(0, searchTerm); // Sempre busca a partir da primeira página
        }

        // Função que busca tutores na API conforme o usuário digita
        async function searchTutors(searchTerm) {
            const resultsContainer = document.getElementById('tutorSearchResults');
            if (!searchTerm || searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/diretores/tutores?nome=${searchTerm}&page=0&size=10`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!response.ok) throw new Error('Falha na busca de tutores');

                const data = await response.json();
                const tutores = data.content || [];
                allFetchedTutors = tutores; // Atualiza nossa lista de referência

                resultsContainer.innerHTML = '';
                if (tutores.length > 0) {
                    tutores.forEach(tutor => {
                        const item = document.createElement('div');
                        item.textContent = tutor.nome;
                        // Ao clicar, preenche o input e limpa os resultados
                        item.onclick = () => {
                            document.getElementById('tutorSearchInput').value = tutor.nome;
                            resultsContainer.innerHTML = '';
                        };
                        resultsContainer.appendChild(item);
                    });
                } else {
                    resultsContainer.innerHTML = '<div>Nenhum tutor encontrado.</div>';
                }
            } catch (error) {
                console.error("Erro ao buscar tutores:", error);
                resultsContainer.innerHTML = '<div>Erro ao buscar.</div>';
            }
        }

        /**
         * Exibe uma notificação toast na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - 'success' (padrão) ou 'error'.
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toast.className = 'toast'; // Reseta as classes
            toast.classList.add(type); // Adiciona a classe de tipo (success ou error)

            toast.classList.add('show'); // Mostra o toast

            // Esconde o toast após 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        /**
         * Abre o modal de confirmação de exclusão.
         * Esta é a função que o botão "Excluir" na tabela deve chamar.
         * @param {number} id - O ID do aluno a ser excluído.
         * @param {string} nome - O nome do aluno.
         */
        function openDeleteConfirmModal(id, nome) {
            const modal = document.getElementById('deleteConfirmModal');
            const messageElement = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            // Personaliza a mensagem de confirmação
            messageElement.textContent = `Você tem certeza que deseja excluir o aluno "${nome}"? Esta ação não pode ser desfeita.`;

            // Define a ação do botão de confirmação para chamar a função de exclusão real
            confirmBtn.onclick = () => executeDelete(id, nome);

            // Exibe o modal
            modal.style.display = 'flex';
        }

        /**
         * Fecha o modal de confirmação.
         */
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
        }

        /**
         * Função que efetivamente executa a exclusão no backend.
         * Chamada apenas pelo botão de confirmação do modal.
         * @param {number} id - O ID do aluno a ser excluído.
         * @param {string} nome - O nome do aluno (usado para a mensagem de sucesso).
         */
        async function executeDelete(id, nome) {
            // Primeiro, fecha o modal
            closeDeleteConfirmModal();

            try {
                const response = await fetch(`${API_URL}/api/alunos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    // Lança um erro para ser pego pelo bloco catch
                    throw new Error(errorData.message || 'Erro ao excluir o aluno.');
                }

                // Mostra a notificação de sucesso
                showToast(`Aluno "${nome}" excluído com sucesso!`, 'success');

                // Recarrega a lista de alunos para refletir a remoção
                loadAlunos(currentPage);

            } catch (error) {
                console.error('Erro ao excluir aluno:', error);
                // Mostra uma notificação de erro
                showToast(error.message, 'error');
            }
        }

        // A função deleteAluno agora é apenas um atalho para abrir o modal.
        // Isso evita que a lógica antiga seja chamada por engano.
        function deleteAluno(id, nome) {
            openDeleteConfirmModal(id, nome);
        }

        /**
         * Renderiza os controles de paginação para a tabela de tokens, usando o mesmo estilo
         * das outras seções do dashboard.
         */
        function renderTokenPagination(totalPages, pageNumber) {
            const paginationContainer = document.getElementById('token-pagination-controls');
            paginationContainer.innerHTML = ''; // Limpa os controles antigos

            // Não mostra a paginação se houver apenas uma página ou nenhuma
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            // Garante que o container de paginação fique visível
            paginationContainer.className = 'pagination-container';
            paginationContainer.style.display = 'flex';

            const isFirstPage = (pageNumber === 0);
            const isLastPage = (pageNumber === totalPages - 1);

            // O HTML gerado agora é idêntico ao da paginação de Alunos/Tutores
            paginationContainer.innerHTML = `
        <div class="pagination-info">Página ${pageNumber + 1} de ${totalPages}</div>
        <div class="pagination-buttons">
            <button class="btn pagination-btn" onclick="changeTokenPage(0)" ${isFirstPage ? 'disabled' : ''} title="Primeira Página"><i class="fas fa-angle-double-left"></i></button>
            <button class="btn pagination-btn" onclick="changeTokenPage(${pageNumber - 1})" ${isFirstPage ? 'disabled' : ''} title="Página Anterior"><i class="fas fa-angle-left"></i></button>
            <span class="page-info-text">Página ${pageNumber + 1}</span>
            <button class="btn pagination-btn" onclick="changeTokenPage(${pageNumber + 1})" ${isLastPage ? 'disabled' : ''} title="Próxima Página"><i class="fas fa-angle-right"></i></button>
            <button class="btn pagination-btn" onclick="changeTokenPage(${totalPages - 1})" ${isLastPage ? 'disabled' : ''} title="Última Página"><i class="fas fa-angle-double-right"></i></button>
        </div>
    `;
        }

        /**
         * Altera a página atual dos tokens e recarrega a lista.
         */
        function changeTokenPage(page) {
            // event.preventDefault() é importante para impedir que o '#' no link recarregue a página
            if (event) {
                event.preventDefault();
            }
            currentTokenPage = page;
            loadAllTokens();
        }

        //CRUD Transporte //////////////////////////////////////
        //
        //
        ////////////////////////////////////////////////////////

        // Função para carregar e exibir os transportes com paginação
        async function loadTransportes(page = 0) {
            currentPageTransportes = page;
            const tableBody = document.getElementById('transportesTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Carregando transportes...</td></tr>';

            try {
                // ENDPOINT CORRETO: Aponta para a API de GESTÃO com paginação
                const response = await fetch(`${API_URL}/api/management/transportadores?escolaId=${ESCOLA_ID}&page=${page}&size=10&sort=nome,asc`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const pageData = await response.json();
                renderTransportes(pageData.content);
                renderTransportesPagination(pageData);

            } catch (error) {
                console.error('Falha ao carregar transportes:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Erro ao carregar os transportes.</td></tr>';
                document.getElementById('transportesPagination').innerHTML = ''; // Limpa paginação em caso de erro
            }
        }

        // Função para renderizar a paginação de transportes
        function renderTransportesPagination(pageData) {
            const paginationContainer = document.getElementById('transportesPagination');
            paginationContainer.innerHTML = '';

            if (pageData.totalPages <= 1) return;

            // Usando o mesmo estilo de paginação das outras seções
            paginationContainer.className = 'pagination-container';
            paginationContainer.style.display = 'flex';

            const pageNumber = pageData.number;
            const totalPages = pageData.totalPages;
            const isFirstPage = pageData.first;
            const isLastPage = pageData.last;

            paginationContainer.innerHTML = `
                <div class="pagination-info">Página ${pageNumber + 1} de ${totalPages}</div>
                <div class="pagination-buttons">
                    <button class="btn pagination-btn" onclick="loadTransportes(0)" ${isFirstPage ? 'disabled' : ''} title="Primeira Página"><i class="fas fa-angle-double-left"></i></button>
                    <button class="btn pagination-btn" onclick="loadTransportes(${pageNumber - 1})" ${isFirstPage ? 'disabled' : ''} title="Página Anterior"><i class="fas fa-angle-left"></i></button>
                    <button class="btn pagination-btn" onclick="loadTransportes(${pageNumber + 1})" ${isLastPage ? 'disabled' : ''} title="Próxima Página"><i class="fas fa-angle-right"></i></button>
                    <button class="btn pagination-btn" onclick="loadTransportes(${totalPages - 1})" ${isLastPage ? 'disabled' : ''} title="Última Página"><i class="fas fa-angle-double-right"></i></button>
                </div>
            `;
        }

        /**
         * Exibe um alerta customizado na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de alerta ('success', 'info', 'warning', 'error').
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) {
                console.error('Elemento #alert-container não encontrado no DOM.');
                // Fallback para o alert nativo se o contêiner não existir
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert alert-${type}`;
            alertDiv.innerHTML = `<span>${message}</span><button class="close-btn">×</button>`;

            alertContainer.appendChild(alertDiv);

            // Animação de entrada
            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 10);

            const closeBtn = alertDiv.querySelector('.close-btn');
            const timer = setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000); // Alerta desaparece após 5 segundos

            closeBtn.addEventListener('click', () => {
                clearTimeout(timer);
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            });
        }


    </script>

</body>

</html>