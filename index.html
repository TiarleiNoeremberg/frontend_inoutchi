<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>INOUTCHI - Login</title>

  <style>
    :root{
      --primary-color:#4a6fa5;
      --secondary-color:#166088;
      --accent-color:#4cb5f5;
      --text-color:#333;
      --error-color:#e74c3c;
      --success-color:#2ecc71;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial}

    body{
      background:#f5f5f5;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:20px;
    }

    .login-container{
      background:#fff;
      width:100%;
      max-width:420px;
      padding:30px;
      border-radius:10px;
      box-shadow:0 5px 15px rgba(0,0,0,.08);
    }

    .logo{text-align:center;margin-bottom:22px}
    .logo h1{color:var(--primary-color);font-size:28px;margin-bottom:6px}
    .logo p{color:#666;font-size:14px}

    .form-group{position:relative;margin-bottom:18px}
    .form-group label{display:block;margin-bottom:8px;color:var(--text-color);font-weight:500}
    .form-group input{
      width:100%;
      padding:12px 44px 12px 14px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:16px;
    }
    .form-group input:focus{outline:none;border-color:var(--accent-color)}

    .toggle-password{
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      width:18px;
      height:15px;
      cursor:pointer;
      opacity:.75;
      user-select:none;
      transition:opacity .15s ease;
    }
    .toggle-password:hover{opacity:1}

    .btn{
      width:100%;
      padding:12px;
      background:var(--primary-color);
      color:#fff;
      border:0;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }
    .btn:disabled{background:#cfcfcf;cursor:not-allowed}
    .btn:hover:not(:disabled){background:var(--secondary-color)}

    .alert{
      display:none;
      margin-bottom:14px;
      padding:10px 12px;
      border-radius:6px;
    }
    .alert-error{background:#fff0f0;color:var(--error-color);border:1px solid #ffd7d7}
    .alert-success{background:#f0fff4;color:var(--success-color);border:1px solid #c8efd0}

    .loading{display:none;text-align:center;margin-top:14px}
    .loading-spinner{
      width:20px;height:20px;border-radius:50%;
      border:3px solid #eee;border-top-color:var(--primary-color);
      animation:spin 1s linear infinite;margin:6px auto 0;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .debug-info{margin-top:16px;font-size:12px;color:#666;text-align:center;border-top:1px solid #eee;padding-top:12px}

    @media(max-width:480px){.login-container{padding:20px}}
  </style>
</head>

<body>
  <div class="login-container">
    <div class="logo">
      <h1>INOUTCHI</h1>
      <p>Sistema de Gestão Escolar Segura</p>
    </div>

    <div id="alertBox" class="alert" role="alert" aria-live="polite"></div>

    <form id="loginForm" novalidate>
      <div class="form-group">
        <label for="email">E‑mail</label>
        <input id="email" type="email" required autocomplete="username" />
      </div>

      <div class="form-group">
        <label for="password">Senha</label>
        <input id="password" type="password" required autocomplete="current-password" />
        <img id="togglePassword" class="toggle-password" src="img/eye-closed.png" alt="Mostrar senha" />
      </div>

      <button id="loginBtn" class="btn" type="submit">Entrar</button>
    </form>

    <div id="loading" class="loading" aria-hidden="true">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p style="text-align:center;margin-top:6px;font-size:13px;color:#444">Autenticando…</p>
    </div>

    <div class="debug-info">
      Backend: <strong id="backendUrl"></strong> — Client ID: <strong id="clientId"></strong>
    </div>
  </div>

  <script>
    (function () {
      // Configuração - CLIENT_SECRET FOI REMOVIDO DAQUI
      const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
      const CLIENT_ID = 'myclientid';

      // Elementos
      const alertBox = document.getElementById('alertBox');
      const loginForm = document.getElementById('loginForm');
      const loadingEl = document.getElementById('loading');
      const loginBtn = document.getElementById('loginBtn');
      const passwordInput = document.getElementById('password');
      const togglePassword = document.getElementById('togglePassword');

      document.getElementById('backendUrl').textContent = BACKEND_URL;
      document.getElementById('clientId').textContent = CLIENT_ID;

      // Helpers
      function showAlert(message, type = 'error') {
        alertBox.textContent = message;
        alertBox.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
        alertBox.style.display = 'block';
      }
      function hideAlert() {
        alertBox.style.display = 'none';
      }

      togglePassword.addEventListener('click', function () {
        const isVisible = passwordInput.type === 'text';
        passwordInput.type = isVisible ? 'password' : 'text';
        togglePassword.src = isVisible ? 'img/eye-closed.png' : 'img/eye-open.png';
        togglePassword.alt = isVisible ? 'Mostrar senha' : 'Ocultar senha';
      });

      async function postForm(url, params = {}) {
        return fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(params)
        });
      }

      // Função de login simplificada e mais segura
      async function loginRequest(email, password) {
        const commonParams = {
            grant_type: 'password',
            username: email,
            password: password,
            scope: 'read write',
            client_id: CLIENT_ID // Enviamos o client_id no corpo
        };

        // 1ª Tentativa: Endpoint padrão /oauth2/token
        let res = await postForm(`${BACKEND_URL}/oauth2/token`, commonParams);

        // 2ª Tentativa (Fallback): Endpoint legado /oauth/token, se o primeiro falhar
        if (!res.ok) {
            res = await postForm(`${BACKEND_URL}/oauth/token`, commonParams);
        }

        return res;
      }

      async function parseJsonOrThrow(response) {
        const ctype = response.headers.get('content-type') || '';
        const text = await response.text();
        if (ctype.includes('application/json')) {
          try {
            const parsedJson = JSON.parse(text);
            // OAuth erros geralmente vêm com 'error_description'
            if (parsedJson.error_description) {
                throw new Error(parsedJson.error_description);
            }
            return parsedJson;
          } catch (e) {
            // Se o parse falhar ou já tivermos lançado o erro, usa a mensagem do erro
            throw e;
          }
        }
        throw new Error(text || `Erro ${response.status}: Falha na autenticação`);
      }

      async function getUserRoles(accessToken) {
        try {
          const r = await fetch(`${BACKEND_URL}/api/users/me`, {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (!r.ok) return [];
          const d = await r.json();
          return d.roles || d.authorities || [];
        } catch (e) {
          console.error('Erro ao buscar roles:', e);
          return [];
        }
      }

      function redirectByRole(roles) {
        if (roles.includes('ROLE_TUTOR')) window.location.href = 'dashboard-tutor.html';
        else if (roles.includes('ROLE_DIRETOR')) window.location.href = 'dashboard-diretor.html';
        else if (roles.includes('ROLE_ESCOLA')) window.location.href = 'dashboard-escola.html';
        else window.location.href = 'dashboard.html'; // Fallback
      }
      
      const savedToken = localStorage.getItem('access_token');
      const savedExpiry = parseInt(localStorage.getItem('token_expiry') || '0', 10);
      if (savedToken && Date.now() < savedExpiry) {
        getUserRoles(savedToken).then(redirectByRole);
      }

      loginForm.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        hideAlert();
        loadingEl.style.display = 'block';
        loginBtn.disabled = true;

        const email = (document.getElementById('email').value || '').trim();
        const pwd = passwordInput.value || '';

        if (!email || !pwd) {
          showAlert('Preencha todos os campos');
          loadingEl.style.display = 'none';
          loginBtn.disabled = false;
          return;
        }

        try {
          const response = await loginRequest(email, pwd);

          if (!response.ok) {
            // A função parseJsonOrThrow já está preparada para lançar o erro correto
            await parseJsonOrThrow(response);
          }

          const data = await response.json();

          if (!data.access_token) {
            throw new Error('Resposta inválida do servidor.');
          }

          const expiry = Date.now() + (data.expires_in || 0) * 1000;
          localStorage.setItem('access_token', data.access_token);
          if (data.refresh_token) localStorage.setItem('refresh_token', data.refresh_token);
          localStorage.setItem('token_expiry', String(expiry));

          const roles = await getUserRoles(data.access_token);
          showAlert('Login realizado!', 'success');
          setTimeout(() => redirectByRole(roles), 900);

        } catch (err) {
          console.error('Erro no login:', err);
          showAlert(err.message || 'Credenciais inválidas');
        } finally {
          loadingEl.style.display = 'none';
          loginBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
