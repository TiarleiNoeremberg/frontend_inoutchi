<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INOUTCHI - Dashboard Diretor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5f5;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #333;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            color: var(--primary-color);
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .btn-logout {
            background-color: var(--danger-color);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-section {
            margin-bottom: 30px;
        }

        .welcome-section h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .card-header i {
            font-size: 24px;
            margin-right: 10px;
        }

        .card-header h3 {
            font-size: 18px;
        }

        .student-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            display: flex;
            flex-direction: column;
        }

        .student-name {
            font-weight: 600;
        }

        .student-class {
            font-size: 14px;
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-present {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
        }

        .status-absent {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* History Section */
        .history-section {
            margin-top: 30px;
        }

        .history-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background-color: var(--light-color);
            font-weight: 600;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        /* Modal Customizado */
        .custom-modal { /* <<-- RENOMEADO AQUI */
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Loading and Messages */
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-error {
            background-color: #ffebee;
            color: var(--danger-color);
            border: 1px solid #ffcdd2;
        }

        .alert-success {
            background-color: #e8f5e9;
            color: var(--success-color);
            border: 1px solid #c8e6c9;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .history-table {
                font-size: 14px;
            }
            
            .history-table th,
            .history-table td {
                padding: 8px 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                font-size: 12px;
                padding: 6px 8px;
            }
        }

        /* Novos estilos para a localização automática */
        .location-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .location-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .location-error {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .location-loading {
            background-color: rgba(74, 111, 165, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(74, 111, 165, 0.3);
        }
        
        .coordinates-display {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            text-align: center;
        }

        /* Ajustar a tabela para 6 colunas */
        .history-table th:nth-child(4),
        .history-table td:nth-child(4) {
            width: 15%;
        }

        .history-table th:nth-child(5),
        .history-table td:nth-child(5) {
            width: 15%;
        }

        .history-table th:nth-child(6),
        .history-table td:nth-child(6) {
            width: 10%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .history-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Estilos para a paginação */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .pagination-info {
            font-size: 14px;
            color: 666;
            font-weight: 500;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-info {
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 10px;
        }

        .pagination-btn {
            padding: 6px 12px;
            font-size: 14px;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .pagination-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .pagination-btn {
                font-size: 12px;
                padding: 5px 8px;
            }
        }

        /* Estilos para abas */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Estilos para formulários de busca */
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        /* Estilos para seções específicas */
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title h3 {
            color: var(--primary-color);
        }

        /* Estilos para cards de estatísticas */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-present {
            color: var(--success-color);
        }

        .stat-absent {
            color: var(--danger-color);
        }

        .stat-total {
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        /* Estilo para quando há apenas um botão na célula */
        .action-buttons.single-button {
            justify-content: center;
        }

        /* Ou ajuste o botão individualmente */
        .btn-wide {
            width: 100%;
            justify-content: center;
        }

        /* Estilo para a paginação do histórico */
        #studentHistoryPagination {
            margin: 15px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        /* Ajuste responsivo */
        @media (max-width: 768px) {
            #studentHistoryPagination {
                flex-direction: column;
                gap: 10px;
            }
            
            #studentHistoryPagination .pagination-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .status-badge {
            display: inline-block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #directorPersonalHistory .student-list {
            max-height: 300px;
            overflow-y: auto;
        }

        #directorPersonalHistory .student-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        #directorPersonalHistory .student-item:last-child {
            border-bottom: none;
        }

        #directorPersonalHistory .student-item .student-info {
            margin-bottom: 5px;
        }

        #directorPersonalHistory .student-item .student-name {
            font-size: 0.9em;
            color: #333;
        }

        #directorPersonalHistory .student-item .student-class {
            font-size: 0.85em;
            color: #666;
        }

        /* Animação de pulse para chamar atenção */
        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        .coordinates-display {
            transition: all 0.3s ease;
        }

        #presentStudentsList {
            min-height: 200px; /* Altura mínima fixa para evitar pulos */
            max-height: 400px; /* Altura máxima para scroll */
            overflow-y: auto;
        }

        /* Estilo para o status 'Aguardando' */
        .status-badge.status-awaiting {
            background-color: #fff3cd; /* Amarelo pastel claro */
            color: #856404;           /* Texto escuro para bom contraste */
            border: 1px solid #ffeeba;
        }

    </style>
</head>
<body>
    <script>
    // =================================================================================
    // ||                                                                             ||
    // ||         CONTEÚDO COMPLETO E REFATORADO PARA DASHBOARD-DIRETOR.HTML          ||
    // ||                                                                             ||
    // =================================================================================

    // ---------------------------------------------------------------------------------
    // CONFIGURAÇÃO E ESTADO GLOBAL
    // ---------------------------------------------------------------------------------
    const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
    const REFRESH_INTERVAL = 30000; // 30 segundos para atualizações automáticas

    let currentUser = null;
    let currentSchoolId = null;
    let autoRefreshIntervalId = null;

    // Estado centralizado para o diretor
    const directorState = {
        id: null,
        status: 'AUSENTE',
        hasActiveSession: false,
        location: {
            latitude: null,
            longitude: null,
            isValid: false
        }
    };

    // Estado para a gestão de alunos
    const studentState = {
        currentPage: 0,
        pageSize: 10,
        totalPages: 1,
        totalElements: 0,
        currentSearchTerm: ''
    };
    
    // Elementos do DOM
    let domElements = {};

    // ---------------------------------------------------------------------------------
    // INICIALIZAÇÃO
    // ---------------------------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', initializeDashboard);

    /**
     * Orquestra a inicialização completa do dashboard.
     */
    async function initializeDashboard() {
        mapDOMElements();
        
        const isAuthenticated = await getValidAccessToken();
        if (!isAuthenticated) {
            redirectToLogin("Sessão inválida ou expirada. Por favor, faça o login novamente.");
            return;
        }

        try {
            showLoading(true);
            await loadUserInfo();
            
            setupEventListeners();
            setupTabs();
            
            // Carga inicial dos dados essenciais
            await loadDirectorData();
            await loadOverviewData();
            
            startAutoRefresh();
            showLoading(false);
            console.log("Dashboard do Diretor inicializado com sucesso.");

        } catch (error) {
            console.error('Erro fatal na inicialização do dashboard:', error);
            showAlert('Não foi possível carregar os dados essenciais. Tente recarregar a página.', 'error');
            showLoading(false);
        }
    }

    /**
     * Mapeia todos os elementos do DOM para um objeto central para fácil acesso.
     */
    function mapDOMElements() {
        domElements = {
            loading: document.getElementById('loading'),
            content: document.getElementById('content'),
            alertBox: document.getElementById('alertBox'),
            userFullName: document.getElementById('userFullName'),
            userAvatar: document.getElementById('userAvatar'),
            // Abas
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            // Status do Diretor
            directorStatus: document.getElementById('directorStatus'),
            directorEntryBtn: document.getElementById('directorEntryBtn'),
            directorExitBtn: document.getElementById('directorExitBtn'),
            // Modal de Ação do Diretor
            actionModal: document.getElementById('actionModal'),
            directorActionTitle: document.getElementById('directorActionTitle'),
            directorGetLocationBtn: document.getElementById('directorGetLocationBtn'),
            directorLocationStatus: document.getElementById('directorLocationStatus'),
            directorCoordinatesDisplay: document.getElementById('directorCoordinatesDisplay'),
            directorDisplayLatitude: document.getElementById('directorDisplayLatitude'),
            directorDisplayLongitude: document.getElementById('directorDisplayLongitude'),
            confirmDirectorActionButton: document.getElementById('confirmDirectorActionButton'),
            // Alunos
            studentsTableBody: document.getElementById('studentsTableBody'),
            studentSearchInput: document.getElementById('studentSearch'),
            studentsPagination: document.getElementById('studentsPagination'),
            // Visão Geral
            totalStudents: document.getElementById('totalStudents'),
            presentStudents: document.getElementById('presentStudents'),
            absentStudents: document.getElementById('absentStudents'),
            totalTutors: document.getElementById('totalTutors'),
            presentStudentsList: document.getElementById('presentStudentsList'),
            // Histórico
            historyTableBody: document.getElementById('historyTableBody'),
            historyPagination: document.getElementById('historyPagination')
        };
    }

    /**
     * Configura todos os event listeners da aplicação.
     */
    function setupEventListeners() {
        // Ações do Diretor
        domElements.directorEntryBtn.addEventListener('click', () => openDirectorActionModal('entrada'));
        domElements.directorExitBtn.addEventListener('click', () => openDirectorActionModal('saida'));
        domElements.directorGetLocationBtn.addEventListener('click', getDirectorLocation);
        domElements.confirmDirectorActionButton.addEventListener('click', () => {
            const action = domElements.confirmDirectorActionButton.dataset.action;
            confirmDirectorAction(action);
        });

        // Busca de Alunos
        domElements.studentSearchInput.addEventListener('input', (e) => {
            studentState.currentSearchTerm = e.target.value;
            studentState.currentPage = 0; // Reseta a página ao buscar
            loadAllStudents();
        });
    }

    // ---------------------------------------------------------------------------------
    // AUTENTICAÇÃO E GESTÃO DE USUÁRIO
    // ---------------------------------------------------------------------------------

    /**
     * Redireciona para a página de login com uma mensagem.
     */
    function redirectToLogin(message) {
        if (message) alert(message);
        localStorage.clear();
        window.location.href = 'index.html';
    }

    /**
     * Valida o token atual e o renova se necessário.
     * @returns {Promise<string|null>} O token de acesso válido ou nulo.
     */
    async function getValidAccessToken() {
        const accessToken = localStorage.getItem('access_token');
        const expiry = localStorage.getItem('token_expiry');

        if (!accessToken || !expiry || new Date().getTime() > parseInt(expiry)) {
            // Tenta renovar o token
            try {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) return null;

                const response = await fetch(`${BACKEND_URL}/api/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const tokenData = await response.json();
                    localStorage.setItem('access_token', tokenData.access_token);
                    localStorage.setItem('token_expiry', new Date().getTime() + tokenData.expires_in * 1000);
                    console.log("Token renovado com sucesso.");
                    return tokenData.access_token;
                }
                return null;
            } catch (error) {
                console.error('Falha ao renovar token:', error);
                return null;
            }
        }
        return accessToken;
    }

    /**
     * Carrega as informações do usuário logado (diretor).
     */
    async function loadUserInfo() {
        const accessToken = await getValidAccessToken();
        if (!accessToken) return redirectToLogin("Sessão expirada.");

        try {
            const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) throw new Error(`Erro ${response.status} ao buscar dados do usuário.`);
            
            currentUser = await response.json();
            directorState.id = currentUser.id;
            currentSchoolId = currentUser.escolaId;

            if (domElements.userFullName) domElements.userFullName.textContent = currentUser.nome || 'Diretor';
            // Lógica para avatar, se aplicável.

        } catch (error) {
            console.error("Erro em loadUserInfo:", error);
            throw error; // Propaga para o inicializador tratar
        }
    }
    
    // ---------------------------------------------------------------------------------
    // FUNCIONALIDADES DO DIRETOR
    // ---------------------------------------------------------------------------------

    /**
     * Carrega o status atual do diretor do backend.
     */
    async function loadDirectorData() {
        if (!directorState.id || !currentSchoolId) return;
        const accessToken = await getValidAccessToken();
        if (!accessToken) return;

        try {
            const response = await fetch(`${BACKEND_URL}/api/diretores/${directorState.id}/escola/${currentSchoolId}/status`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) throw new Error('Falha ao buscar status do diretor.');

            const data = await response.json();
            directorState.status = data.status || 'AUSENTE';
            directorState.hasActiveSession = data.sessaoAtiva || false;
            
            updateDirectorUI();

        } catch (error) {
            console.warn('Não foi possível carregar dados do diretor, assumindo "AUSENTE":', error);
            directorState.status = 'AUSENTE';
            directorState.hasActiveSession = false;
            updateDirectorUI();
        }
    }

    /**
     * Atualiza a interface do diretor (status e botões).
     */
    function updateDirectorUI() {
        const { directorStatus, directorEntryBtn, directorExitBtn } = domElements;
        if (!directorStatus || !directorEntryBtn || !directorExitBtn) return;

        directorStatus.textContent = directorState.status.replace('_', ' ');
        
        if (directorState.status === 'PRESENTE') {
            directorStatus.className = 'status-badge status-present';
            directorEntryBtn.style.display = 'none';
            directorExitBtn.style.display = 'inline-block';
        } else {
            directorStatus.className = 'status-badge status-absent';
            directorEntryBtn.style.display = 'inline-block';
            directorExitBtn.style.display = 'none';
        }
    }
    
    /**
     * Abre o modal para registro de entrada ou saída do diretor.
     * @param {string} action - 'entrada' ou 'saida'.
     */
    function openDirectorActionModal(action) {
        resetDirectorLocationState();
        domElements.directorActionTitle.textContent = `Registrar ${action}`;
        domElements.confirmDirectorActionButton.dataset.action = action;
        new bootstrap.Modal(domElements.actionModal).show();
    }

    /**
     * Obtém a geolocalização do navegador.
     */
    function getDirectorLocation() {
        const { directorGetLocationBtn, directorLocationStatus } = domElements;
        directorGetLocationBtn.disabled = true;
        directorGetLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo...';
        directorLocationStatus.style.display = 'block';
        directorLocationStatus.textContent = 'Solicitando permissão de localização...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                directorState.location = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    isValid: true
                };
                updateDirectorLocationUI('success', 'Localização obtida com sucesso!');
            },
            (error) => {
                directorState.location.isValid = false;
                let message = 'Erro ao obter localização: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED: message += "Permissão negada."; break;
                    case error.POSITION_UNAVAILABLE: message += "Localização indisponível."; break;
                    case error.TIMEOUT: message += "Tempo esgotado."; break;
                    default: message += "Erro desconhecido."; break;
                }
                updateDirectorLocationUI('error', message);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }
    
    /**
     * Atualiza a UI relacionada à geolocalização no modal.
     */
    function updateDirectorLocationUI(status, message) {
        const { directorGetLocationBtn, directorLocationStatus, directorCoordinatesDisplay, directorDisplayLatitude, directorDisplayLongitude } = domElements;

        directorLocationStatus.textContent = message;
        directorLocationStatus.className = `location-status ${status}`;

        if (status === 'success') {
            directorGetLocationBtn.innerHTML = '<i class="fas fa-check"></i> Localização Obtida';
            directorCoordinatesDisplay.style.display = 'block';
            directorDisplayLatitude.textContent = directorState.location.latitude.toFixed(6);
            directorDisplayLongitude.textContent = directorState.location.longitude.toFixed(6);
        } else {
            directorGetLocationBtn.disabled = false;
            directorGetLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Tentar Novamente';
        }
    }

    /**
     * Reseta o estado e a UI de localização do diretor.
     */
    function resetDirectorLocationState() {
        directorState.location = { latitude: null, longitude: null, isValid: false };
        const { directorGetLocationBtn, directorLocationStatus, directorCoordinatesDisplay, directorDisplayLatitude, directorDisplayLongitude } = domElements;
        
        if(directorLocationStatus) directorLocationStatus.style.display = 'none';
        if(directorCoordinatesDisplay) directorCoordinatesDisplay.style.display = 'none';
        if(directorDisplayLatitude) directorDisplayLatitude.textContent = '-';
        if(directorDisplayLongitude) directorDisplayLongitude.textContent = '-';
        
        if(directorGetLocationBtn) {
            directorGetLocationBtn.disabled = false;
            directorGetLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Obter Localização';
        }
    }

    /**
     * Envia a confirmação de entrada/saída para o backend.
     * @param {string} action - 'entrada' ou 'saida'.
     */
    async function confirmDirectorAction(action) {
        if (!directorState.location.isValid) {
            return showAlert('Por favor, obtenha a localização primeiro.', 'error');
        }

        const accessToken = await getValidAccessToken();
        if (!accessToken) return;

        const payload = {
            diretorId: directorState.id,
            escolaId: currentSchoolId,
            latitude: directorState.location.latitude,
            longitude: directorState.location.longitude,
            responsavelNome: currentUser.nome,
            responsavelTipo: 'DIRETOR'
        };

        try {
            domElements.confirmDirectorActionButton.disabled = true;
            const endpoint = (action === 'entrada') ? '/api/presencas/diretor/entrada' : '/api/presencas/diretor/saida';
            
            const response = await fetch(BACKEND_URL + endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(payload)
            });

            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.mensagem || `Erro ao registrar ${action}.`);

            showAlert(`Registro de ${action} realizado com sucesso!`, 'success');
            bootstrap.Modal.getInstance(domElements.actionModal).hide();
            
            // Força atualização imediata do status
            await loadDirectorData();

        } catch (error) {
            showAlert(error.message, 'error');
        } finally {
            domElements.confirmDirectorActionButton.disabled = false;
        }
    }
    
    // ---------------------------------------------------------------------------------
    // GESTÃO DE ABAS E ATUALIZAÇÕES AUTOMÁTICAS
    // ---------------------------------------------------------------------------------
    
    /**
     * Configura a navegação por abas e o carregamento de dados correspondente.
     */
    function setupTabs() {
        domElements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                switchToTab(tabName);
            });
        });
    }

    /**
     * Alterna para uma aba específica e carrega seus dados.
     * @param {string} tabName - O nome da aba (ex: 'overview', 'students').
     */
    function switchToTab(tabName) {
        domElements.tabs.forEach(t => t.classList.remove('active'));
        domElements.tabContents.forEach(tc => tc.classList.remove('active'));

        const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        const activeContent = document.getElementById(`${tabName}-tab`);

        if (activeTab) activeTab.classList.add('active');
        if (activeContent) activeContent.classList.add('active');

        // Carrega os dados da aba selecionada
        switch (tabName) {
            case 'overview': loadOverviewData(); break;
            case 'students': loadAllStudents(); break;
            case 'tutors': /* loadAllTutors(); */ break; // Implementar se necessário
            case 'classrooms': /* loadClassrooms(); */ break; // Implementar se necessário
            case 'history': /* loadHistory(); */ break; // Implementar se necessário
        }
    }

    /**
     * Inicia o ciclo de atualização automática para dados críticos.
     */
    function startAutoRefresh() {
        if (autoRefreshIntervalId) clearInterval(autoRefreshIntervalId);
        
        autoRefreshIntervalId = setInterval(() => {
            console.log("Executando atualização automática periódica...");
            const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
            
            // Sempre atualiza o status do diretor, pois é exibido globalmente
            loadDirectorData();

            // Atualiza dados da aba ativa
            if (activeTab === 'overview') {
                loadOverviewData();
            } else if (activeTab === 'students') {
                loadAllStudents();
            }

        }, REFRESH_INTERVAL);
    }

    // ---------------------------------------------------------------------------------
    // VISÃO GERAL (OVERVIEW)
    // ---------------------------------------------------------------------------------

    async function loadOverviewData() {
        await loadStatistics();
        await loadPresentStudents();
    }

    async function loadStatistics() {
        const accessToken = await getValidAccessToken();
        if (!accessToken || !currentSchoolId) return;

        try {
            const response = await fetch(`${BACKEND_URL}/api/escolas/${currentSchoolId}/estatisticas`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) return;
            const stats = await response.json();
            
            domElements.totalStudents.textContent = stats.totalAlunos || 0;
            domElements.presentStudents.textContent = stats.alunosPresentes || 0;
            domElements.absentStudents.textContent = stats.alunosAusentes || 0;
            domElements.totalTutors.textContent = stats.totalTutores || 0;

        } catch (error) {
            console.warn("Não foi possível carregar estatísticas:", error);
        }
    }

    async function loadPresentStudents() {
        const accessToken = await getValidAccessToken();
        if (!accessToken || !currentSchoolId) return;

        try {
            const response = await fetch(`${BACKEND_URL}/api/escolas/${currentSchoolId}/alunos/presentes`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) return;
            const students = await response.json();
            
            const list = domElements.presentStudentsList;
            list.innerHTML = '';
            if (students.length === 0) {
                list.innerHTML = '<li>Nenhum aluno presente no momento.</li>';
                return;
            }
            
            students.forEach(student => {
                const item = document.createElement('li');
                item.innerHTML = `<span>${student.nome}</span> <span class="class-name">${student.salaNome || 'Sem sala'}</span>`;
                list.appendChild(item);
            });

        } catch (error) {
            console.warn("Não foi possível carregar alunos presentes:", error);
        }
    }

    // ---------------------------------------------------------------------------------
    // GESTÃO DE ALUNOS
    // ---------------------------------------------------------------------------------

    async function loadAllStudents() {
        const accessToken = await getValidAccessToken();
        if (!accessToken || !currentSchoolId) return;

        const { currentPage, pageSize, currentSearchTerm } = studentState;
        const url = new URL(`${BACKEND_URL}/api/escolas/${currentSchoolId}/alunos`);
        url.searchParams.append('page', currentPage);
        url.searchParams.append('size', pageSize);
        if (currentSearchTerm) {
            url.searchParams.append('nome', currentSearchTerm);
        }
        
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
            if (!response.ok) throw new Error('Falha ao carregar lista de alunos.');
            
            const data = await response.json();
            renderStudentsTable(data.content);
            
            // Atualiza estado da paginação
            studentState.totalPages = data.totalPages;
            studentState.totalElements = data.totalElements;
            // setupStudentsPagination(data); // Implementar renderização da paginação

        } catch (error) {
            console.error('Erro ao carregar alunos:', error);
            domElements.studentsTableBody.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`;
        }
    }

    function renderStudentsTable(students) {
        const tbody = domElements.studentsTableBody;
        tbody.innerHTML = '';
        if (!students || students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum aluno encontrado.</td></tr>';
            return;
        }

        students.forEach(student => {
            const tr = document.createElement('tr');
            const status = student.status || 'AUSENTE';
            const statusClass = status === 'PRESENTE' ? 'status-present' : 'status-absent';

            tr.innerHTML = `
                <td>${student.nome || 'N/A'}</td>
                <td>${student.salaNome || 'N/A'}</td>
                <td>${formatTutorsForDisplay(student.tutores)}</td>
                <td><span class="status-badge ${statusClass}">${status.replace('_', ' ')}</span></td>
                <td>
                    <button class="btn-action" title="Ver Histórico"><i class="fas fa-history"></i></button>
                    <button class="btn-action" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    /**
     * Formata a lista de tutores de um aluno para exibição.
     * Lida com estruturas de dados inconsistentes.
     */
    function formatTutorsForDisplay(tutores) {
        if (!tutores || !Array.isArray(tutores) || tutores.length === 0) {
            return '<span style="color: #888;">Sem tutores</span>';
        }
        
        return tutores.map(tutor => {
            const nome = tutor.nome || 'Tutor';
            const parentesco = tutor.parentesco ? `(${tutor.parentesco})` : '';
            return `<div>${nome} ${parentesco}</div>`;
        }).join('');
    }

    // ---------------------------------------------------------------------------------
    // UTILITÁRIOS
    // ---------------------------------------------------------------------------------

    /**
     * Exibe ou oculta a tela de loading.
     */
    function showLoading(isLoading) {
        domElements.loading.style.display = isLoading ? 'flex' : 'none';
        domElements.content.style.display = isLoading ? 'none' : 'block';
    }

    /**
     * Mostra uma mensagem de alerta temporária.
     */
    function showAlert(message, type = 'info') {
        const alertBox = domElements.alertBox;
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type}`;
        alertBox.style.display = 'block';
        setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
    }
    
    /**
     * Função de logout do usuário.
     */
    window.logout = function() {
        redirectToLogin();
    };

</script>

</body>
</html>