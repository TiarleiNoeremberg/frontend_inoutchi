<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Diretor | INOUTCHI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .card-icon.blue { background: #e3f2fd; color: #2196f3; }
        .card-icon.green { background: #e8f5e9; color: #4caf50; }
        .card-icon.orange { background: #fff3e0; color: #ff9800; }
        .card-icon.purple { background: #f3e5f5; color: #9c27b0; }
        .card-icon.red { background: #ffebee; color: #f44336; }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #2196f3; color: white; }

        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
        }

        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none; 
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-badge.present { background: #e8f5e9; color: #2e7d32; }
        .status-badge.absent { background: #ffebee; color: #c62828; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body { padding: 25px; }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
        }

        /* Location Status */
        .location-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .location-loading { background: #e3f2fd; color: #1976d2; }
        .location-success { background: #e8f5e9; color: #2e7d32; }
        .location-error { background: #ffebee; color: #c62828; }
        .location-warning { background: #fff3e0; color: #f57c00; }
        .location-info { background: #f3e5f5; color: #6a1b9a; }

        .coordinates-display {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            margin-bottom: 15px;
        }

        .geofence-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }

        .geofence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .geofence-item:last-child { border-bottom: none; }

        .geofence-valid { color: #2e7d32; }
        .geofence-invalid { color: #f57c00; }

        .director-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .director-present { background: #e8f5e9; color: #2e7d32; }
        .director-absent { background: #ffebee; color: #c62828; }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 2000;
            animation: slideInRight 0.3s;
        }

        .alert-success { background: #4caf50; color: white; }
        .alert-error { background: #f44336; color: white; }
        .alert-warning { background: #ff9800; color: white; }
        .alert-info { background: #2196f3; color: white; }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h1 style="color: #333; font-size: 1.5rem;">
                    <i class="fas fa-school"></i> Dashboard Diretor
                </h1>
                <div id="directorStatusBadge" class="director-status director-absent">
                    <i class="fas fa-user-tie"></i>
                    <span id="directorStatusText">Ausente</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="registerDirectorEntry()">
                    <i class="fas fa-sign-in-alt"></i> Minha Entrada
                </button>
                <button class="btn btn-warning" onclick="registerDirectorExit()">
                    <i class="fas fa-sign-out-alt"></i> Minha Saída
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-power-off"></i> Sair
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">
                <i class="fas fa-chart-line"></i> Visão Geral
            </button>
            <button class="tab" onclick="switchTab('students')">
                <i class="fas fa-graduation-cap"></i> Alunos
            </button>
            <button class="tab" onclick="switchTab('tutors')">
                <i class="fas fa-users"></i> Tutores
            </button>
            <button class="tab" onclick="switchTab('history')">
                <i class="fas fa-history"></i> Histórico
            </button>
        </div>

        <!-- Tab Contents -->
        <div id="overview-content" class="tab-content active">
            <div class="cards-grid">
                <div class="card">
                    <div class="card-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 style="color: #666; font-size: 0.9rem;">Total de Alunos</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: #333;" id="totalStudents">0</p>
                </div>

                <div class="card">
                    <div class="card-icon green">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <h3 style="color: #666; font-size: 0.9rem;">Presentes Agora</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="presentStudents">0</p>
                </div>

                <div class="card">
                    <div class="card-icon orange">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <h3 style="color: #666; font-size: 0.9rem;">Ausentes</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="absentStudents">0</p>
                </div>

                <div class="card">
                    <div class="card-icon purple">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <h3 style="color: #666; font-size: 0.9rem;">Total de Tutores</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: #9c27b0;" id="totalTutors">0</p>
                </div>

                <div class="card">
                    <div class="card-icon red">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 style="color: #666; font-size: 0.9rem;">Registros Hoje</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: #f44336;" id="todayRecords">0</p>
                </div>
            </div>
        </div>

        <div id="students-content" class="tab-content">
            <div class="table-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="studentSearch" 
                           placeholder="Buscar aluno por nome ou matrícula...">
                    <button class="btn btn-primary" onclick="searchStudents()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Matrícula</th>
                            <th>Tutor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- Students will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tutors-content" class="tab-content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Alunos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tutorsTableBody">
                        <!-- Tutors will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="history-content" class="tab-content">
            <div class="table-container">
                <div style="margin-bottom: 20px;">
                    <input type="date" id="historyDate" onchange="loadHistory()" 
                           style="padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Aluno</th>
                            <th>Tipo</th>
                            <th>Responsável</th>
                            <th>Localização</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Student Action Modal -->
    <div class="modal" id="studentActionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="studentModalTitle">Registrar Ação</h3>
                <button class="close-modal" onclick="closeStudentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="studentModalMessage" style="margin-bottom: 20px;"></p>

                <!-- Location Section -->
                <div>
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                        <i class="fas fa-map-marker-alt"></i> Localização Atual
                    </label>

                    <div id="studentLocationStatus" class="location-status" style="display: none;"></div>

                    <div id="studentCoordinatesDisplay" class="coordinates-display" style="display: none;">
                        <div><strong>Latitude:</strong> <span id="studentLatitude">-</span></div>
                        <div><strong>Longitude:</strong> <span id="studentLongitude">-</span></div>
                    </div>

                    <div id="studentGeofenceResults" class="geofence-info" style="display: none;">
                        <h4 style="margin-bottom: 10px; color: #555;">Validação de Perímetro:</h4>
                        <div id="studentGeofenceList"></div>
                    </div>

                    <button class="btn btn-primary" onclick="getStudentLocation()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-location-arrow"></i> Obter Localização
                    </button>

                    <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center; 
                                padding: 10px; background: #f3e5f5; border-radius: 6px;">
                        <i class="fas fa-info-circle"></i> 
                        Como diretor, você pode registrar presenças independente da localização
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeStudentModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmStudentActionBtn" onclick="confirmStudentAction()" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Director Action Modal -->
    <div class="modal" id="directorActionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="directorModalTitle">Registrar Minha Presença</h3>
                <button class="close-modal" onclick="closeDirectorModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="directorModalMessage" style="margin-bottom: 20px;"></p>

                <div>
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                        <i class="fas fa-map-marker-alt"></i> Minha Localização
                    </label>

                    <div id="directorLocationStatus" class="location-status" style="display: none;"></div>

                    <div id="directorCoordinatesDisplay" class="coordinates-display" style="display: none;">
                        <div><strong>Latitude:</strong> <span id="directorLatitude">-</span></div>
                        <div><strong>Longitude:</strong> <span id="directorLongitude">-</span></div>
                    </div>

                    <div id="directorGeofenceResults" class="geofence-info" style="display: none;">
                        <h4 style="margin-bottom: 10px; color: #555;">Validação de Perímetro:</h4>
                        <div id="directorGeofenceList"></div>
                    </div>

                    <button class="btn btn-primary" onclick="getDirectorLocation()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-location-arrow"></i> Obter Localização
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeDirectorModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmDirectorActionBtn" onclick="confirmDirectorAction()" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';

        // State Management
        let currentUser = null;
        let currentSchoolId = 1;
        let schoolGeofences = [];
        let students = [];
        let tutors = [];
        let selectedStudent = null;
        let selectedActionType = null;
        let directorActionType = null;
        let studentLocation = null;
        let directorLocation = null;

        // ========== INITIALIZATION ==========
        async function initializeDashboard() {
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    window.location.href = 'index.html';
                    return;
                }

                await loadUserInfo();
                await loadGeofences();
                await loadOverview();
                await checkDirectorStatus();

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Erro ao inicializar dashboard', 'error');
            }
        }

        async function loadUserInfo() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    currentSchoolId = currentUser.escolaId || 1;
                } else {
                    throw new Error('Failed to load user info');
                }
            } catch (error) {
                console.error('Error loading user:', error);
                logout();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // ========== GEOFENCE MANAGEMENT ==========
        async function loadGeofences() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/geofences/escola/${currentSchoolId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    schoolGeofences = await response.json();
                    console.log('School geofences:', schoolGeofences);
                } else {
                    schoolGeofences = [];
                }
            } catch (error) {
                console.error('Error loading geofences:', error);
                schoolGeofences = [];
            }
        }

        function validateWithGeofences(latitude, longitude) {
            const validations = [];

            for (const geofence of schoolGeofences) {
                if (!geofence.ativo) continue;

                const distance = calculateDistance(
                    latitude, longitude,
                    geofence.latitude, geofence.longitude
                );

                const isValid = distance <= geofence.raioMetros;

                validations.push({
                    nome: geofence.nome,
                    tipo: geofence.tipo,
                    distancia: Math.round(distance),
                    raio: geofence.raioMetros,
                    valido: isValid
                });
            }

            return validations;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function showGeofenceValidation(validations, elementId) {
            const container = document.getElementById(elementId + 'Results');
            const list = document.getElementById(elementId + 'List');

            list.innerHTML = '';

            let hasValidLocation = false;

            for (const validation of validations) {
                if (validation.valido) hasValidLocation = true;

                const item = document.createElement('div');
                item.className = 'geofence-item';

                const statusClass = validation.valido ? 'geofence-valid' : 'geofence-invalid';
                const statusIcon = validation.valido ? 'check-circle' : 'info-circle';
                const statusText = validation.valido 
                    ? 'Dentro do perímetro' 
                    : `${validation.distancia}m de distância`;

                item.innerHTML = `
                    <div>
                        <strong>${validation.nome}</strong>
                        <div style="font-size: 0.85rem; color: #666;">
                            ${validation.tipo} | Raio: ${validation.raio}m
                        </div>
                    </div>
                    <div class="${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        ${statusText}
                    </div>
                `;

                list.appendChild(item);
            }

            // Add note for director permissions
            if (elementId.includes('student') || elementId.includes('director')) {
                const note = document.createElement('div');
                note.style.cssText = 'margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 0.85rem; color: #6a1b9a;';

                if (elementId.includes('student')) {
                    note.innerHTML = '<i class="fas fa-shield-alt"></i> Diretor pode registrar independente da localização';
                } else {
                    note.innerHTML = hasValidLocation 
                        ? '<i class="fas fa-check"></i> Você está no perímetro da escola'
                        : '<i class="fas fa-info-circle"></i> Registro será marcado como fora do perímetro';
                }

                list.appendChild(note);
            }

            container.style.display = 'block';
        }

        // ========== TAB MANAGEMENT ==========
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-content').classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'overview':
                    loadOverview();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'tutors':
                    loadTutors();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // ========== DATA LOADING ==========
        async function loadOverview() {
            try {
                const accessToken = localStorage.getItem('access_token');

                // Load students count
                const studentsResponse = await fetch(`${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (studentsResponse.ok) {
                    const studentsData = await studentsResponse.json();
                    const total = studentsData.totalElements || 0;
                    const present = studentsData.content?.filter(s => s.presente).length || 0;

                    document.getElementById('totalStudents').textContent = total;
                    document.getElementById('presentStudents').textContent = present;
                    document.getElementById('absentStudents').textContent = total - present;
                }

                // Load tutors count
                const tutorsResponse = await fetch(`${BACKEND_URL}/api/diretores/tutores`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (tutorsResponse.ok) {
                    const tutorsData = await tutorsResponse.json();
                    document.getElementById('totalTutors').textContent = tutorsData.totalElements || 0;
                }

                // Load today's records
                const today = new Date().toISOString().split('T')[0];
                const historyResponse = await fetch(`${BACKEND_URL}/api/presencas/historico?data=${today}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    document.getElementById('todayRecords').textContent = historyData.length || 0;
                }

            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        async function loadStudents() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    students = data.content || [];
                    renderStudents();
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum aluno encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.nome}</td>
                    <td>${student.matricula || 'N/A'}</td>
                    <td>${student.tutorNome || 'Sem tutor'}</td>
                    <td>
                        <span class="status-badge ${student.presente ? 'present' : 'absent'}">
                            ${student.presente ? 'Presente' : 'Ausente'}
                        </span>
                    </td>
                    <td>
                        ${!student.presente ? `
                            <button class="btn btn-success btn-sm" 
                                    onclick="openStudentActionModal(${student.id}, 'entrada', '${student.nome}')">
                                <i class="fas fa-sign-in-alt"></i> Entrada
                            </button>
                        ` : `
                            <button class="btn btn-warning btn-sm" 
                                    onclick="openStudentActionModal(${student.id}, 'saida', '${student.nome}')">
                                <i class="fas fa-sign-out-alt"></i> Saída
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        async function loadTutors() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/diretores/tutores`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    tutors = data.content || [];
                    renderTutors();
                }
            } catch (error) {
                console.error('Error loading tutors:', error);
            }
        }

        function renderTutors() {
            const tbody = document.getElementById('tutorsTableBody');

            if (tutors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum tutor encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = tutors.map(tutor => `
                <tr>
                    <td>${tutor.nome}</td>
                    <td>${tutor.email}</td>
                    <td>${tutor.telefone || 'N/A'}</td>
                    <td>${tutor.quantidadeAlunos || 0}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewTutorDetails(${tutor.id})">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadHistory() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const date = document.getElementById('historyDate').value || new Date().toISOString().split('T')[0];

                const response = await fetch(`${BACKEND_URL}/api/presencas/historico?data=${date}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const history = await response.json();
                    renderHistory(history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function renderHistory(history) {
            const tbody = document.getElementById('historyTableBody');

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = history.map(record => `
                <tr>
                    <td>${new Date(record.dataHora).toLocaleTimeString('pt-BR')}</td>
                    <td>${record.alunoNome}</td>
                    <td>
                        <span class="status-badge ${record.tipo === 'ENTRADA' ? 'present' : 'absent'}">
                            ${record.tipo}
                        </span>
                    </td>
                    <td>${record.responsavelNome}</td>
                    <td>
                        ${record.dentroGeofence 
                            ? '<i class="fas fa-map-marker-alt" style="color: #4caf50;"></i> Dentro' 
                            : '<i class="fas fa-map-marker-alt" style="color: #ff9800;"></i> Fora'}
                    </td>
                </tr>
            `).join('');
        }

        // ========== DIRECTOR STATUS ==========
        async function checkDirectorStatus() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/presencas/diretores/status`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const status = await response.json();
                    updateDirectorStatus(status.presente);
                }
            } catch (error) {
                console.error('Error checking director status:', error);
            }
        }

        function updateDirectorStatus(isPresent) {
            const badge = document.getElementById('directorStatusBadge');
            const text = document.getElementById('directorStatusText');

            if (isPresent) {
                badge.className = 'director-status director-present';
                text.textContent = 'Presente';
            } else {
                badge.className = 'director-status director-absent';
                text.textContent = 'Ausente';
            }
        }

        // ========== STUDENT ACTION MODAL ==========
        function openStudentActionModal(studentId, type, studentName) {
            selectedStudent = { id: studentId, name: studentName };
            selectedActionType = type;

            document.getElementById('studentModalTitle').textContent = 
                `Registrar ${type === 'entrada' ? 'Entrada' : 'Saída'}`;
            document.getElementById('studentModalMessage').innerHTML = 
                `Confirmar <strong>${type === 'entrada' ? 'entrada' : 'saída'}</strong> do aluno <strong>${studentName}</strong>?`;

            resetStudentLocationState();
            document.getElementById('studentActionModal').style.display = 'block';
        }

        function closeStudentModal() {
            document.getElementById('studentActionModal').style.display = 'none';
            selectedStudent = null;
            selectedActionType = null;
            studentLocation = null;
            resetStudentLocationState();
        }

        async function getStudentLocation() {
            if (!navigator.geolocation) {
                showStudentLocationError('Geolocalização não suportada');
                return;
            }

            showStudentLocationLoading();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    studentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    showStudentLocationSuccess(studentLocation);

                    const validations = validateWithGeofences(
                        studentLocation.latitude,
                        studentLocation.longitude
                    );

                    showGeofenceValidation(validations, 'studentGeofence');

                    // Director can always confirm
                    document.getElementById('confirmStudentActionBtn').disabled = false;
                },
                (error) => {
                    showStudentLocationError(getLocationErrorMessage(error));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function confirmStudentAction() {
            if (!selectedStudent || !selectedActionType || !studentLocation) {
                showAlert('Dados incompletos', 'error');
                return;
            }

            try {
                const accessToken = localStorage.getItem('access_token');
                const endpoint = selectedActionType === 'entrada' ? 'entrada' : 'saida';

                const response = await fetch(`${BACKEND_URL}/api/presencas/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        alunoId: selectedStudent.id,
                        responsavelNome: currentUser.nome,
                        responsavelTipo: 'DIRETOR',
                        responsavelId: currentUser.id,
                        latitude: studentLocation.latitude,
                        longitude: studentLocation.longitude
                    })
                });

                if (response.ok) {
                    showAlert(`${selectedActionType === 'entrada' ? 'Entrada' : 'Saída'} registrada com sucesso!`, 'success');
                    closeStudentModal();
                    loadStudents();
                    loadOverview();
                } else {
                    throw new Error('Erro ao registrar ação');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Erro ao registrar ação', 'error');
            }
        }

        // ========== DIRECTOR ACTION MODAL ==========
        function registerDirectorEntry() {
            directorActionType = 'entrada';
            openDirectorActionModal();
        }

        function registerDirectorExit() {
            directorActionType = 'saida';
            openDirectorActionModal();
        }

        function openDirectorActionModal() {
            const type = directorActionType;
            document.getElementById('directorModalTitle').textContent = 
                `Registrar Minha ${type === 'entrada' ? 'Entrada' : 'Saída'}`;
            document.getElementById('directorModalMessage').innerHTML = 
                `Confirmar sua <strong>${type === 'entrada' ? 'entrada' : 'saída'}</strong> no sistema?`;

            resetDirectorLocationState();
            document.getElementById('directorActionModal').style.display = 'block';
        }

        function closeDirectorModal() {
            document.getElementById('directorActionModal').style.display = 'none';
            directorActionType = null;
            directorLocation = null;
            resetDirectorLocationState();
        }

        async function getDirectorLocation() {
            if (!navigator.geolocation) {
                showDirectorLocationError('Geolocalização não suportada');
                return;
            }

            showDirectorLocationLoading();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    directorLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    showDirectorLocationSuccess(directorLocation);

                    const validations = validateWithGeofences(
                        directorLocation.latitude,
                        directorLocation.longitude
                    );

                    showGeofenceValidation(validations, 'directorGeofence');

                    document.getElementById('confirmDirectorActionBtn').disabled = false;
                },
                (error) => {
                    showDirectorLocationError(getLocationErrorMessage(error));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function confirmDirectorAction() {
            if (!directorActionType || !directorLocation) {
                showAlert('Dados incompletos', 'error');
                return;
            }

            try {
                const accessToken = localStorage.getItem('access_token');
                const endpoint = directorActionType === 'entrada' 
                    ? '/api/presencas/diretores/entrada' 
                    : '/api/presencas/diretores/saida';

                const response = await fetch(BACKEND_URL + endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        responsavelId: currentUser.id,
                        responsavelNome: currentUser.nome,
                        responsavelTipo: 'DIRETOR',
                        latitude: directorLocation.latitude,
                        longitude: directorLocation.longitude
                    })
                });

                if (response.ok) {
                    showAlert(`Sua ${directorActionType === 'entrada' ? 'entrada' : 'saída'} foi registrada!`, 'success');
                    closeDirectorModal();
                    updateDirectorStatus(directorActionType === 'entrada');
                } else {
                    throw new Error('Erro ao registrar presença');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Erro ao registrar presença', 'error');
            }
        }

        // ========== LOCATION UI HELPERS ==========
        function showStudentLocationLoading() {
            const status = document.getElementById('studentLocationStatus');
            status.className = 'location-status location-loading';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
            status.style.display = 'flex';
        }

        function showStudentLocationSuccess(coords) {
            const status = document.getElementById('studentLocationStatus');
            status.className = 'location-status location-success';
            status.innerHTML = '<i class="fas fa-check-circle"></i> Localização obtida!';
            status.style.display = 'flex';

            const display = document.getElementById('studentCoordinatesDisplay');
            document.getElementById('studentLatitude').textContent = coords.latitude.toFixed(6);
            document.getElementById('studentLongitude').textContent = coords.longitude.toFixed(6);
            display.style.display = 'block';
        }

        function showStudentLocationError(message) {
            const status = document.getElementById('studentLocationStatus');
            status.className = 'location-status location-error';
            status.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            status.style.display = 'flex';
        }

        function showDirectorLocationLoading() {
            const status = document.getElementById('directorLocationStatus');
            status.className = 'location-status location-loading';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
            status.style.display = 'flex';
        }

        function showDirectorLocationSuccess(coords) {
            const status = document.getElementById('directorLocationStatus');
            status.className = 'location-status location-success';
            status.innerHTML = '<i class="fas fa-check-circle"></i> Localização obtida!';
            status.style.display = 'flex';

            const display = document.getElementById('directorCoordinatesDisplay');
            document.getElementById('directorLatitude').textContent = coords.latitude.toFixed(6);
            document.getElementById('directorLongitude').textContent = coords.longitude.toFixed(6);
            display.style.display = 'block';
        }

        function showDirectorLocationError(message) {
            const status = document.getElementById('directorLocationStatus');
            status.className = 'location-status location-error';
            status.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            status.style.display = 'flex';
        }

        function resetStudentLocationState() {
            document.getElementById('studentLocationStatus').style.display = 'none';
            document.getElementById('studentCoordinatesDisplay').style.display = 'none';
            document.getElementById('studentGeofenceResults').style.display = 'none';
            document.getElementById('confirmStudentActionBtn').disabled = true;
        }

        function resetDirectorLocationState() {
            document.getElementById('directorLocationStatus').style.display = 'none';
            document.getElementById('directorCoordinatesDisplay').style.display = 'none';
            document.getElementById('directorGeofenceResults').style.display = 'none';
            document.getElementById('confirmDirectorActionBtn').disabled = true;
        }

        function getLocationErrorMessage(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return 'Permissão negada';
                case error.POSITION_UNAVAILABLE:
                    return 'Localização indisponível';
                case error.TIMEOUT:
                    return 'Tempo esgotado';
                default:
                    return 'Erro desconhecido';
            }
        }

        // ========== UTILITIES ==========
        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => 
                s.nome.toLowerCase().includes(searchTerm) || 
                (s.matricula && s.matricula.toLowerCase().includes(searchTerm))
            );
            students = filtered;
            renderStudents();
        }

        function viewTutorDetails(tutorId) {
            showAlert('Detalhes do tutor em desenvolvimento', 'info');
        }

        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => alert.remove(), 4000);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();

            // Set today's date in history filter
            document.getElementById('historyDate').value = new Date().toISOString().split('T')[0];
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                if (event.target.id === 'studentActionModal') {
                    closeStudentModal();
                } else if (event.target.id === 'directorActionModal') {
                    closeDirectorModal();
                }
            }
        }
    </script>
</body>
</html>