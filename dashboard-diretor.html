<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Diretor - InOutchi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <div class="alert-box" id="alertBox"></div>

    <div id="content" style="display: none;">
        <header class="header">
            <div class="logo">InOutchi</div>
            <div class="user-menu">
                <img id="userAvatar" src="assets/images/avatar.png" alt="Avatar" class="avatar">
                <span id="userName"></span>
                <button onclick="logout()" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <main class="main-container">
            <div class="sidebar">
                <h3>Menu</h3>
                <div class="tab">
                    <button class="tab-link active" onclick="openTab(event, 'overview')"><i class="fas fa-tachometer-alt"></i> Visão Geral</button>
                    <button class="tab-link" onclick="openTab(event, 'students')"><i class="fas fa-user-graduate"></i> Alunos</button>
                    <button class="tab-link" onclick="openTab(event, 'classrooms')"><i class="fas fa-chalkboard-teacher"></i> Salas</button>
                    <button class="tab-link" onclick="openTab(event, 'tutors')"><i class="fas fa-user-shield"></i> Tutores</button>
                    <button class="tab-link" onclick="openTab(event, 'history')"><i class="fas fa-history"></i> Histórico</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Visão Geral -->
                <div id="overview" class="tab-content" style="display: block;">
                    <h2>Visão Geral</h2>
                    <div class="director-status-card">
                         <div class="card-header">
                            <h4>Status do Diretor</h4>
                            <span id="directorStatusBadge" class="status-badge status-absent">Ausente</span>
                        </div>
                        <div class="card-body">
                             <p>Olá, <strong id="userFullName"></strong>!</p>
                             <p>Seu status atual é: <strong id="directorStatusText">Ausente</strong>.</p>
                             <button id="directorEntryBtn" class="btn btn-success" onclick="openDirectorActionModal('entrada')">
                                <i class="fas fa-sign-in-alt"></i> Registrar Entrada
                            </button>
                             <button id="directorExitBtn" class="btn btn-danger" style="display: none;" onclick="openDirectorActionModal('saida')">
                                <i class="fas fa-sign-out-alt"></i> Registrar Saída
                            </button>
                        </div>
                    </div>
                    <div class="overview-cards">
                        <div class="card">
                            <h3>Alunos Presentes Agora</h3>
                            <div id="presentStudentsList">Carregando...</div>
                        </div>
                        <div class="card">
                            <h3>Total de Alunos</h3>
                            <p id="totalStudents">...</p>
                        </div>
                    </div>
                </div>

                <!-- Alunos -->
                <div id="students" class="tab-content">
                    <h2>Alunos</h2>
                    <div class="table-controls">
                        <input type="text" id="studentSearch" placeholder="Buscar aluno por nome...">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Sala</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="studentsPagination"></div>
                </div>

                <!-- Salas -->
                <div id="classrooms" class="tab-content">
                    <h2>Salas</h2>
                    <p>Funcionalidade em desenvolvimento.</p>
                </div>

                <!-- Tutores -->
                <div id="tutors" class="tab-content">
                     <h2>Tutores</h2>
                     <p>Funcionalidade em desenvolvimento.</p>
                </div>

                <!-- Histórico -->
                <div id="history" class="tab-content">
                    <h2>Histórico de Presença</h2>
                    <p>Funcionalidade em desenvolvimento.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Ação do Diretor -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <div class="location-section">
                    <div id="locationStatus" class="location-status"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // =================================================================================
        // CONFIGURAÇÕES GLOBAIS E INICIALIZAÇÃO
        // =================================================================================
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
        let currentUser = null;
        let currentSchoolId = null;
        let currentDirectorId = null;
        let directorLocationData = { latitude: null, longitude: null, isValid: false };
        let domElements = {};

        document.addEventListener('DOMContentLoaded', initializeDashboard);

        async function initializeDashboard() {
            initializeDOMElements();
            showLoading();

            try {
                const accessToken = await getValidToken();
                if (!accessToken) {
                    redirectToLogin("Sessão inválida ou expirada. Faça login novamente.");
                    return;
                }

                // Fluxo de inicialização corrigido
                await loadUserInfo(accessToken); // Carrega dados do usuário e da escola
                await loadDirectorStatus(accessToken); // Carrega status de presença do diretor
                await loadOverviewData(accessToken); // Carrega dados da visão geral
                
                loadAllStudents(accessToken); // Carga inicial dos alunos
                
                setupEventListeners();
                showContent();
                startAutoRefresh();

            } catch (error) {
                console.error('❌ Erro fatal na inicialização do dashboard:', error);
                showAlert(`Erro crítico ao carregar: ${error.message}. Verifique o console e tente recarregar.`, 'error');
                hideLoading();
            }
        }

        function initializeDOMElements() {
            const ids = [
                'loading', 'content', 'alertBox', 'userAvatar', 'userName', 'userFullName',
                'directorStatusBadge', 'directorStatusText', 'directorEntryBtn', 'directorExitBtn',
                'presentStudentsList', 'totalStudents', 'studentsTableBody', 'studentsPagination',
                'studentSearch', 'actionModal', 'modalTitle', 'modalMessage', 'locationStatus',
                'confirmActionBtn'
            ];
            ids.forEach(id => domElements[id] = document.getElementById(id));
        }

        function setupEventListeners() {
            domElements.studentSearch.addEventListener('input', (e) => {
                getValidToken().then(token => loadAllStudents(token, 0, e.target.value));
            });
        }

        // =================================================================================
        // AUTENTICAÇÃO E DADOS DO USUÁRIO
        // =================================================================================

        async function getValidToken() {
            const accessToken = localStorage.getItem('access_token');
            const expiry = localStorage.getItem('token_expiry');

            if (!accessToken || !expiry || new Date().getTime() > parseInt(expiry)) {
                return null;
            }
            return accessToken;
        }

        function redirectToLogin(message) {
            alert(message);
            logout();
        }

        window.logout = function() {
            localStorage.clear();
            window.location.href = 'index.html';
        };

        async function loadUserInfo(accessToken) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) {
                    throw new Error(`Falha ao buscar dados do usuário (Status: ${response.status})`);
                }

                currentUser = await response.json();
                
                // **PONTO CRÍTICO CORRIGIDO**
                // Captura o ID do diretor e o ID da escola a partir da resposta do /me
                currentDirectorId = currentUser.id;
                currentSchoolId = currentUser.escolaId;

                if (!currentDirectorId || !currentSchoolId) {
                    throw new Error("Dados essenciais (ID do diretor ou da escola) não foram retornados. O usuário pode não ser um diretor ou não estar configurado corretamente.");
                }

                domElements.userName.textContent = currentUser.nome.split(' ')[0];
                domElements.userFullName.textContent = currentUser.nome;

            } catch (error) {
                console.error('❌ Erro em loadUserInfo:', error);
                throw error; // Propaga o erro para ser pego pelo bloco catch principal
            }
        }

        // =================================================================================
        // LÓGICA DO DIRETOR (STATUS E AÇÕES)
        // =================================================================================

        async function loadDirectorStatus(accessToken) {
            try {
                // Utiliza o currentDirectorId obtido do /me
                const response = await fetch(`${BACKEND_URL}/api/presencas/diretores/${currentDirectorId}/status`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                let isPresent = false;
                if (response.ok) {
                    const data = await response.json();
                    isPresent = data === 'PRESENTE';
                }
                
                updateDirectorUI(isPresent);

            } catch (error) {
                console.warn('⚠️ Aviso em loadDirectorStatus:', error.message);
                updateDirectorUI(false); // Assume ausente em caso de erro
            }
        }
        
        function updateDirectorUI(isPresent) {
            const statusText = isPresent ? 'Presente' : 'Ausente';
            domElements.directorStatusBadge.textContent = statusText;
            domElements.directorStatusText.textContent = statusText;

            domElements.directorStatusBadge.className = `status-badge ${isPresent ? 'status-present' : 'status-absent'}`;
            domElements.directorEntryBtn.style.display = isPresent ? 'none' : 'block';
            domElements.directorExitBtn.style.display = isPresent ? 'block' : 'none';
        }

        window.openDirectorActionModal = async function(action) {
            const isEntry = action === 'entrada';
            domElements.modalTitle.textContent = isEntry ? 'Registrar Entrada' : 'Registrar Saída';
            domElements.modalMessage.textContent = isEntry 
                ? 'Para confirmar a entrada, precisamos obter sua localização.'
                : 'Você confirma o registro da sua saída da escola?';
            
            domElements.actionModal.style.display = 'flex';
            domElements.confirmActionBtn.disabled = true;

            if (isEntry) {
                await getDirectorLocation();
            } else {
                domElements.locationStatus.style.display = 'none';
                domElements.confirmActionBtn.disabled = false; // Para saída, não precisa de localização
            }

            domElements.confirmActionBtn.onclick = () => confirmDirectorAction(action);
        }

        async function confirmDirectorAction(action) {
            const isEntry = action === 'entrada';

            if (isEntry && !directorLocationData.isValid) {
                showAlert('Localização inválida. A entrada não pode ser registrada.', 'warning');
                return;
            }

            domElements.confirmActionBtn.disabled = true;
            domElements.confirmActionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';

            try {
                const accessToken = await getValidToken();
                const endpoint = isEntry ? '/api/presencas/diretores/entrada' : '/api/presencas/diretores/saida';
                
                const payload = {
                    responsavelId: currentDirectorId,
                    responsavelNome: currentUser.nome,
                    responsavelTipo: 'DIRETOR'
                };
                
                if (isEntry) {
                    payload.latitude = directorLocationData.latitude;
                    payload.longitude = directorLocationData.longitude;
                }
                
                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.mensagem || `Erro ${response.status}`);
                }

                showAlert(`✅ ${isEntry ? 'Entrada' : 'Saída'} registrada com sucesso!`, 'success');
                
                closeModal();
                await loadDirectorStatus(accessToken);
                await loadOverviewData(accessToken);
                
            } catch (error) {
                console.error(`❌ Erro ao confirmar ${action} do diretor:`, error);
                showAlert(`Erro: ${error.message}`, 'error');
            } finally {
                closeModal();
            }
        }

        // =================================================================================
        // LÓGICA DE ALUNOS E VISÃO GERAL
        // =================================================================================

        async function loadAllStudents(accessToken, page = 0, searchTerm = '') {
            try {
                // Utiliza o currentSchoolId obtido do /me
                let url = `${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos?page=${page}&size=10`;
                if (searchTerm) {
                    url += `&nome=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (!response.ok) throw new Error('Falha ao carregar alunos.');

                const data = await response.json();
                renderStudentsTable(data.content || []);
                // setupPagination(domElements.studentsPagination, data, 'loadAllStudents', searchTerm);
                
            } catch (error) {
                console.error('❌ Erro em loadAllStudents:', error);
                domElements.studentsTableBody.innerHTML = `<tr><td colspan="4">Erro ao carregar alunos.</td></tr>`;
            }
        }
        
        function renderStudentsTable(students) {
            const tbody = domElements.studentsTableBody;
            tbody.innerHTML = '';
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum aluno encontrado.</td></tr>';
                return;
            }
            students.forEach(student => {
                const statusClass = student.status === 'PRESENTE' ? 'status-present' : 'status-absent';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.nome}</td>
                    <td>${student.salaNome || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${student.status || 'INDEFINIDO'}</span></td>
                    <td><button class="btn btn-sm btn-info">Detalhes</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadOverviewData(accessToken) {
            try {
                // Alunos presentes
                const presResponse = await fetch(`${BACKEND_URL}/api/alunos/${currentSchoolId}/presentes?size=5`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (presResponse.ok) {
                    const presData = await presResponse.json();
                    const list = domElements.presentStudentsList;
                    list.innerHTML = presData.content && presData.content.length > 0
                        ? presData.content.map(s => `<div>${s.nome}</div>`).join('')
                        : 'Nenhum aluno presente.';
                }
                // Total de alunos
                const totalResponse = await fetch(`${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos?size=1`, {
                     headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (totalResponse.ok) {
                    const totalData = await totalResponse.json();
                    domElements.totalStudents.textContent = totalData.totalElements || 0;
                }
            } catch (error) {
                console.error("Erro ao carregar dados da visão geral:", error);
            }
        }

        function startAutoRefresh() {
            setInterval(async () => {
                const token = await getValidToken();
                if (!token) return;

                if (document.getElementById('overview').style.display === 'block') {
                    loadOverviewData(token);
                    loadDirectorStatus(token);
                }
            }, 30000); // 30 segundos
        }

        // =================================================================================
        // FUNÇÕES AUXILIARES (UI, MODAIS, LOCALIZAÇÃO)
        // =================================================================================

        function showLoading() { domElements.loading.style.display = 'flex'; }
        function hideLoading() { domElements.loading.style.display = 'none'; }
        function showContent() { hideLoading(); domElements.content.style.display = 'block'; }

        function showAlert(message, type = 'info') {
            const alertBox = domElements.alertBox;
            alertBox.textContent = message;
            alertBox.className = `alert-box alert-${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => alertBox.style.display = 'none', 5000);
        }

        window.openTab = function(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        window.closeModal = function() {
            domElements.actionModal.style.display = 'none';
            domElements.confirmActionBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar';
        }

        async function getDirectorLocation() {
            domElements.locationStatus.className = 'location-status location-loading';
            domElements.locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
            domElements.locationStatus.style.display = 'block';

            if (!navigator.geolocation) {
                return showLocationError('Geolocalização não é suportada.');
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                });
                
                directorLocationData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    isValid: true
                };

                domElements.locationStatus.className = 'location-status location-success';
                domElements.locationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Localização obtida!';
                domElements.confirmActionBtn.disabled = false;

            } catch (error) {
                showLocationError(`Falha ao obter localização: ${error.message}`);
            }
        }
        
        function showLocationError(message) {
            domElements.locationStatus.className = 'location-status location-error';
            domElements.locationStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            directorLocationData.isValid = false;
            domElements.confirmActionBtn.disabled = true;
        }
    </script>
</body>
</html>
