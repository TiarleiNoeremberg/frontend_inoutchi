<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Diretor - InOutchi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <div class="alert-box" id="alertBox"></div>

    <div id="content" style="display: none;">
        <header class="header">
            <div class="logo">InOutchi</div>
            <div class="user-menu">
                <img id="userAvatar" src="assets/images/avatar.png" alt="Avatar" class="avatar">
                <span id="userName"></span>
                <button onclick="logout()" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </header>

        <main class="main-container">
            <div class="sidebar">
                <h3>Menu</h3>
                <div class="tab">
                    <button class="tab-link active" onclick="openTab(event, 'overview')"><i class="fas fa-tachometer-alt"></i> Visão Geral</button>
                    <button class="tab-link" onclick="openTab(event, 'students')"><i class="fas fa-user-graduate"></i> Alunos</button>
                    <button class="tab-link" onclick="openTab(event, 'classrooms')"><i class="fas fa-chalkboard-teacher"></i> Salas</button>
                    <button class="tab-link" onclick="openTab(event, 'tutors')"><i class="fas fa-user-shield"></i> Tutores</button>
                    <button class="tab-link" onclick="openTab(event, 'history')"><i class="fas fa-history"></i> Histórico</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Visão Geral -->
                <div id="overview" class="tab-content" style="display: block;">
                    <h2>Visão Geral</h2>
                    <div class="director-status-card">
                         <div class="card-header">
                            <h4>Status do Diretor</h4>
                            <span id="directorStatusBadge" class="status-badge status-absent">Ausente</span>
                        </div>
                        <div class="card-body">
                             <p>Olá, <strong id="userFullName"></strong>!</p>
                             <p>Seu status atual é: <strong id="directorStatusText">Ausente</strong>.</p>
                             <button id="directorEntryBtn" class="btn btn-success" onclick="openDirectorActionModal('entrada')">
                                <i class="fas fa-sign-in-alt"></i> Registrar Entrada
                            </button>
                             <button id="directorExitBtn" class="btn btn-danger" style="display: none;" onclick="openDirectorActionModal('saida')">
                                <i class="fas fa-sign-out-alt"></i> Registrar Saída
                            </button>
                        </div>
                    </div>
                    <div class="overview-cards">
                        <div class="card">
                            <h3>Alunos Presentes Agora</h3>
                            <div id="presentStudentsList">Carregando...</div>
                        </div>
                        <div class="card">
                            <h3>Total de Alunos</h3>
                            <p id="totalStudents">...</p>
                        </div>
                    </div>
                </div>

                <!-- Alunos -->
                <div id="students" class="tab-content">
                    <h2>Alunos</h2>
                    <div class="table-controls">
                        <input type="text" id="studentSearch" placeholder="Buscar aluno por nome...">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Sala</th>
                                    <th>Tutores</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="studentsPagination"></div>
                </div>

                <!-- Salas (Nova) -->
                <div id="classrooms" class="tab-content">
                    <h2>Salas</h2>
                    <div id="classroomsList"></div>
                </div>

                <!-- Tutores (Nova) -->
                <div id="tutors" class="tab-content">
                     <h2>Tutores</h2>
                     <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Alunos Vinculados</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tutorsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="tutorsPagination"></div>
                </div>

                <!-- Histórico -->
                <div id="history" class="tab-content">
                    <h2>Histórico de Presença</h2>
                    <div id="historyContent"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Ação do Diretor -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <div class="location-section">
                    <div id="locationStatus" class="location-status"></div>
                    <div id="coordinatesDisplay" style="display: none;">
                        <p><strong>Latitude:</strong> <span id="latitude"></span></p>
                        <p><strong>Longitude:</strong> <span id="longitude"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailsModalTitle">Detalhes</h3>
                <button class="close-modal" onclick="closeDetailsModal()">×</button>
            </div>
            <div class="modal-body" id="detailsModalBody"></div>
            <div class="modal-footer">
                <button class="btn" onclick="closeDetailsModal()">Fechar</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =================================================================================
        // INICIALIZAÇÃO E CONFIGURAÇÕES GLOBAIS
        // =================================================================================
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
        const pageSize = 20;

        let currentUser = null;
        let currentSchoolId = null;
        let currentDirectorId = null;

        let currentStudentsPage = 0;
        let currentTutorsPage = 0;

        // Cache de elementos DOM
        let domElements = {};

        // Cache de localização
        let directorLocationData = { latitude: null, longitude: null, isValid: false };

        // Adiciona o listener que garante que o DOM está carregado antes de rodar o script
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        async function initializeDashboard() {
            console.log('Inicializando dashboard do diretor...');
            initializeDOMElements();
            showLoading();

            try {
                const accessToken = await getValidToken();
                if (!accessToken) {
                    redirectToLogin("Sessão inválida ou expirada. Faça login novamente.");
                    return;
                }

                await loadUserInfo();
                await loadDirectorData();
                await loadOverviewData();
                loadAllStudents(); // Carga inicial
                
                setupEventListeners();
                showContent();
                startAutoRefresh();

                console.log('✅ Dashboard inicializado com sucesso!');

            } catch (error) {
                console.error('❌ Erro fatal na inicialização do dashboard:', error);
                showAlert(`Erro crítico ao carregar o dashboard: ${error.message}. Tente recarregar a página.`, 'error');
                hideLoading(); // Esconde o loading para mostrar a mensagem de erro
            }
        }

        function initializeDOMElements() {
            const ids = [
                'loading', 'content', 'alertBox', 'userAvatar', 'userName', 'userFullName',
                'directorStatusBadge', 'directorStatusText', 'directorEntryBtn', 'directorExitBtn',
                'presentStudentsList', 'totalStudents', 'studentsTableBody', 'studentsPagination',
                'studentSearch', 'actionModal', 'modalTitle', 'modalMessage', 'locationStatus',
                'coordinatesDisplay', 'latitude', 'longitude', 'confirmActionBtn', 'detailsModal',
                'detailsModalTitle', 'detailsModalBody', 'classroomsList', 'tutorsTableBody', 'tutorsPagination'
            ];
            ids.forEach(id => domElements[id] = document.getElementById(id));
        }

        function setupEventListeners() {
            domElements.studentSearch.addEventListener('input', (e) => {
                loadAllStudents(0, e.target.value);
            });
        }

        // =================================================================================
        // AUTENTICAÇÃO E DADOS DO USUÁRIO
        // =================================================================================

        async function getValidToken() {
            let accessToken = localStorage.getItem('access_token');
            const expiry = localStorage.getItem('token_expiry');

            if (!accessToken || !expiry || new Date().getTime() > parseInt(expiry)) {
                console.log('Token expirado ou inválido, redirecionando para login.');
                return null;
            }
            return accessToken;
        }

        function redirectToLogin(message) {
            alert(message);
            logout();
        }

        window.logout = function() {
            localStorage.clear();
            window.location.href = 'index.html';
        };

        async function loadUserInfo() {
            try {
                const accessToken = await getValidToken();
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) throw new Error('Falha ao buscar dados do usuário.');

                currentUser = await response.json();
                currentDirectorId = currentUser.id;
                currentSchoolId = currentUser.escolaId;

                if (!currentSchoolId) {
                    throw new Error("ID da escola não encontrado para este diretor. Acesso negado.");
                }

                domElements.userName.textContent = currentUser.nome.split(' ')[0];
                domElements.userFullName.textContent = currentUser.nome;

            } catch (error) {
                console.error('❌ Erro em loadUserInfo:', error);
                throw error;
            }
        }

        // =================================================================================
        // LÓGICA DO DIRETOR (STATUS E AÇÕES)
        // =================================================================================

        async function loadDirectorData() {
            try {
                const accessToken = await getValidToken();
                const response = await fetch(`${BACKEND_URL}/api/presencas/diretores/${currentDirectorId}/status`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Não foi possível verificar o status do diretor.');
                
                const data = await response.json();
                updateDirectorUI(data.status, data.status === 'PRESENTE');

            } catch (error) {
                console.warn('⚠️ Aviso em loadDirectorData:', error.message);
                updateDirectorUI('AUSENTE', false);
            }
        }
        
        function updateDirectorUI(status, isPresent) {
            const statusText = status ? status.replace('_', ' ') : 'Indefinido';
            domElements.directorStatusBadge.textContent = statusText;
            domElements.directorStatusText.textContent = statusText;

            domElements.directorStatusBadge.className = `status-badge ${isPresent ? 'status-present' : 'status-absent'}`;
            domElements.directorEntryBtn.style.display = isPresent ? 'none' : 'block';
            domElements.directorExitBtn.style.display = isPresent ? 'block' : 'none';
        }

        window.openDirectorActionModal = async function(action) {
            resetDirectorLocationState();
            const isEntry = action === 'entrada';
            domElements.modalTitle.textContent = isEntry ? 'Registrar Entrada' : 'Registrar Saída';
            domElements.modalMessage.textContent = isEntry 
                ? 'Para confirmar a entrada, precisamos da sua localização.'
                : 'Você confirma o registro da sua saída da escola?';
            
            domElements.actionModal.style.display = 'flex';

            if (isEntry) {
                await getDirectorLocation();
            } else {
                // Para saída, não precisa de localização, então habilita o botão direto.
                domElements.confirmActionBtn.disabled = false;
                domElements.locationStatus.style.display = 'none';
                domElements.coordinatesDisplay.style.display = 'none';
            }

            domElements.confirmActionBtn.onclick = () => confirmDirectorAction(action);
        }

        async function confirmDirectorAction(action) {
            const isEntry = action === 'entrada';

            if (isEntry && !directorLocationData.isValid) {
                showAlert('Localização inválida ou não obtida. Tente novamente.', 'warning');
                return;
            }

            try {
                const accessToken = await getValidToken();
                
                // CORREÇÃO DEFINITIVA: Payload alinhado com o backend de 22/10
                const requestData = {
                    responsavelId: currentDirectorId,
                    responsavelNome: currentUser.nome,
                    responsavelTipo: 'DIRETOR'
                };
                
                if (isEntry) {
                    requestData.latitude = directorLocationData.latitude;
                    requestData.longitude = directorLocationData.longitude;
                }
                
                console.log(`📦 Enviando dados para ${action} do diretor:`, requestData);
                
                const endpoint = isEntry ? '/api/presencas/diretores/entrada' : '/api/presencas/diretores/saida';
                
                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.mensagem || `Erro ${response.status}`);
                }

                showAlert(`✅ ${isEntry ? 'Entrada' : 'Saída'} registrada com sucesso!`, 'success');
                
                closeModal();
                await loadDirectorData(); // Atualiza o status do diretor na UI
                await loadOverviewData(); // Atualiza a visão geral
                
            } catch (error) {
                console.error(`❌ Erro ao confirmar ${action} do diretor:`, error);
                showAlert(`Erro: ${error.message}`, 'error');
                closeModal();
            }
        }

        // =================================================================================
        // LÓGICA DE ALUNOS
        // =================================================================================

        async function loadAllStudents(page = 0, searchTerm = '') {
            try {
                const accessToken = await getValidToken();
                let url = `${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos?page=${page}&size=${pageSize}`;
                if (searchTerm) {
                    url += `&nome=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (!response.ok) throw new Error('Falha ao carregar alunos.');

                const data = await response.json();
                
                if (data.content && data.content.length > 0) {
                    const studentsWithStatus = await checkAllStudentsStatus(data.content);
                    renderStudentsTable(studentsWithStatus);
                } else {
                    domElements.studentsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum aluno encontrado.</td></tr>';
                }
                setupPagination(domElements.studentsPagination, data, 'loadAllStudents', searchTerm);
                
            } catch (error) {
                console.error('❌ Erro em loadAllStudents:', error);
                domElements.studentsTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Erro ao carregar alunos: ${error.message}</td></tr>`;
            }
        }
        
        async function checkAllStudentsStatus(alunos) {
            try {
                const accessToken = await getValidToken();
                const response = await fetch(`${BACKEND_URL}/api/alunos/${currentSchoolId}/presentes?size=1000`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) return alunos.map(a => ({ ...a, status: 'INDEFINIDO' }));

                const data = await response.json();
                const presentesIds = new Set(data.content?.map(aluno => aluno.id) || []);
                
                return alunos.map(aluno => ({
                    ...aluno,
                    status: presentesIds.has(aluno.id) ? 'PRESENTE' : 'AUSENTE'
                }));
            } catch (error) {
                console.error("Erro ao verificar status dos alunos:", error);
                return alunos.map(a => ({ ...a, status: 'INDEFINIDO' }));
            }
        }

        function renderStudentsTable(students) {
            domElements.studentsTableBody.innerHTML = '';
            students.forEach(student => {
                const statusClass = student.status === 'PRESENTE' ? 'status-present' : 'status-absent';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.nome}</td>
                    <td>${student.salaNome || 'N/A'}</td>
                    <td>Carregando...</td>
                    <td><span class="status-badge ${statusClass}">${student.status}</span></td>
                    <td><button class="btn btn-sm btn-info">Detalhes</button></td>
                `;
                domElements.studentsTableBody.appendChild(tr);
            });
        }


        // =================================================================================
        // VISÃO GERAL E ATUALIZAÇÃO AUTOMÁTICA
        // =================================================================================

        async function loadOverviewData() {
            try {
                const accessToken = await getValidToken();
                // Alunos presentes
                const presResponse = await fetch(`${BACKEND_URL}/api/alunos/${currentSchoolId}/presentes?size=5`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (presResponse.ok) {
                    const presData = await presResponse.json();
                    const list = domElements.presentStudentsList;
                    list.innerHTML = '';
                    if (presData.content && presData.content.length > 0) {
                        presData.content.forEach(s => {
                            list.innerHTML += `<div>${s.nome}</div>`;
                        });
                    } else {
                        list.innerHTML = 'Nenhum aluno presente no momento.';
                    }
                }
                // Total de alunos
                const totalResponse = await fetch(`${BACKEND_URL}/api/diretores/${currentSchoolId}/alunos?size=1`, {
                     headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (totalResponse.ok) {
                    const totalData = await totalResponse.json();
                    domElements.totalStudents.textContent = totalData.totalElements || 0;
                }
            } catch (error) {
                console.error("Erro ao carregar dados da visão geral:", error);
                domElements.presentStudentsList.innerHTML = 'Erro ao carregar.';
            }
        }

        function startAutoRefresh() {
            setInterval(() => {
                if (document.getElementById('overview').style.display === 'block') {
                    loadOverviewData();
                    loadDirectorData();
                }
                if (document.getElementById('students').style.display === 'block') {
                    loadAllStudents(currentStudentsPage, domElements.studentSearch.value);
                }
            }, 30000);
        }


        // =================================================================================
        // FUNÇÕES AUXILIARES (UI, MODAIS, LOCALIZAÇÃO, ETC.)
        // =================================================================================

        function showLoading() { if(domElements.loading) domElements.loading.style.display = 'flex'; }
        function hideLoading() { if(domElements.loading) domElements.loading.style.display = 'none'; }
        function showContent() { hideLoading(); if(domElements.content) domElements.content.style.display = 'block'; }

        function showAlert(message, type = 'info') {
            const alertBox = domElements.alertBox;
            if (!alertBox) return;
            alertBox.textContent = message;
            alertBox.className = `alert-box alert-${type}`;
            alertBox.style.display = 'block';
            setTimeout(() => alertBox.style.display = 'none', 5000);
        }

        window.openTab = function(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        window.closeModal = function() { domElements.actionModal.style.display = 'none'; }
        window.closeDetailsModal = function() { domElements.detailsModal.style.display = 'none'; }

        function resetDirectorLocationState() {
            directorLocationData = { latitude: null, longitude: null, isValid: false };
            domElements.locationStatus.style.display = 'none';
            domElements.coordinatesDisplay.style.display = 'none';
            domElements.confirmActionBtn.disabled = true;
        }

        async function getDirectorLocation() {
            domElements.locationStatus.className = 'location-status location-loading';
            domElements.locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
            domElements.locationStatus.style.display = 'block';

            if (!navigator.geolocation) {
                showLocationError('Geolocalização não é suportada por este navegador.');
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                });
                
                directorLocationData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    isValid: true
                };
                showLocationSuccess(position.coords);

            } catch (error) {
                showLocationError(`Erro ao obter localização: ${error.message}`);
            }
        }
        
        function showLocationSuccess(coords) {
            domElements.locationStatus.className = 'location-status location-success';
            domElements.locationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Localização obtida com sucesso!';
            domElements.latitude.textContent = coords.latitude.toFixed(6);
            domElements.longitude.textContent = coords.longitude.toFixed(6);
            domElements.coordinatesDisplay.style.display = 'block';
            domElements.confirmActionBtn.disabled = false;
        }

        function showLocationError(message) {
            domElements.locationStatus.className = 'location-status location-error';
            domElements.locationStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            directorLocationData.isValid = false;
            domElements.confirmActionBtn.disabled = true;
        }

        function setupPagination(element, data, loadFunctionName, searchTerm = '') {
            element.innerHTML = '';
            if (data.totalPages > 1) {
                if (!data.first) {
                    element.innerHTML += `<button class="btn btn-secondary" onclick="${loadFunctionName}(${data.number - 1}, '${searchTerm}')">Anterior</button>`;
                }
                element.innerHTML += `<span class="page-info">Página ${data.number + 1} de ${data.totalPages}</span>`;
                if (!data.last) {
                    element.innerHTML += `<button class="btn btn-secondary" onclick="${loadFunctionName}(${data.number + 1}, '${searchTerm}')">Próxima</button>`;
                }
            }
        }
    </script>
</body>
</html>
