<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INOUTCHI - Painel do Transportador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS Reset e Variáveis de Cor */
        :root {
            --primary-color: #005f73; /* Azul escuro para transporte */
            --secondary-color: #0a9396; /* Azul-petróleo */
            --accent-color: #94d2bd;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #333;
            --border-color: #dee2e6;
            --card-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        /* Conteúdo Principal (Mobile-First) */
        main {
            padding: 15px;
        }

        .students-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .container-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .container-header h2 {
            color: var(--primary-color);
            font-size: 1.2em;
        }

        /* Barra de Ações */
        .actions-bar {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn {
            padding: 12px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1em;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-entry {
            background-color: var(--success-color);
            color: white;
        }
        .btn-entry:hover:not(:disabled) { background-color: #27ae60; }

        .btn-exit {
            background-color: var(--warning-color);
            color: white;
        }
        .btn-exit:hover:not(:disabled) { background-color: #e67e22; }

        /* Tabela de Alunos */
        .table-wrapper {
            overflow-x: auto; /* Permite scroll horizontal em telas pequenas */
        }
        
        .student-table {
            width: 100%;
            border-collapse: collapse;
        }

        .student-table th, .student-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .student-table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        .student-table tr:last-child td {
            border-bottom: none;
        }
        
        .student-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 700;
            color: white;
        }
        .status-present { background-color: var(--success-color); }
        .status-absent { background-color: var(--danger-color); }
        .status-pending { background-color: var(--warning-color); }

        /* Checkbox customizado */
        .custom-checkbox {
            transform: scale(1.3);
            accent-color: var(--primary-color);
        }
        
        /* Modal (Overlay) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .modal-content p {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 20px;
        }

        .btn-secondary {
            background-color: #ccc;
            color: #333;
        }

        .location-status {
            font-size: 0.9em;
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            border: 1px solid;
        }
        .location-loading { border-color: #f0ad4e; color: #f0ad4e; background: #fcf8e3;}
        .location-error { border-color: #d9534f; color: #d9534f; background: #f2dede;}

        /* Media Queries para telas maiores */
        @media (min-width: 576px) {
            .actions-bar {
                grid-template-columns: 1fr 1fr; /* Botões lado a lado */
            }
        }

        @media (min-width: 768px) {
            body {
                font-size: 16px;
            }
            main {
                max-width: 800px;
                margin: 20px auto;
            }
        }

    </style>
</head>
<body>

    <header>
        <h1>Painel do Transportador</h1>
        <p>Bem-vindo(a), <span id="transportador-nome">carregando...</span></p>
    </header>

    <main>
        <div class="students-container">
            <div class="container-header">
                <h2><i class="fa-solid fa-bus-simple"></i> Meus Alunos</h2>
            </div>

            <div class="actions-bar">
                <button class="btn btn-entry" id="btn-registrar-entrada" disabled>
                    <i class="fa-solid fa-right-to-bracket"></i> Registrar Entrada
                </button>
                <button class="btn btn-exit" id="btn-solicitar-saida" disabled>
                    <i class="fa-solid fa-person-walking-arrow-right"></i> Solicitar Saída
                </button>
            </div>

            <div class="table-wrapper">
                <table class="student-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selecionar-todos" class="custom-checkbox"></th>
                            <th>Aluno</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body">
                        <!-- Linhas de alunos serão injetadas aqui via JS -->
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando alunos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Confirmação -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar Ação</h3>
            <p id="modalMessage">Você confirma esta ação?</p>
            <div id="locationStatus" class="location-status location-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Obtendo sua localização...
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary modal-btn" id="cancelAction">Cancelar</button>
                <button class="btn btn-primary modal-btn" id="confirmAction" disabled>Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Feedback (Sucesso/Erro) -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal-content">
            <h3 id="feedbackTitle"></h3>
            <p id="feedbackMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-primary modal-btn" id="closeFeedback">OK</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // === CONFIGURAÇÕES E VARIÁVEIS GLOBAIS ===
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
        let currentUser = null;
        let studentsData = [];
        let currentAction = null; // 'entrada' ou 'saida'
        let currentActionPayload = null;
        
        // === REFERÊNCIAS DE ELEMENTOS DOM ===
        const transportadorNomeEl = document.getElementById('transportador-nome');
        const studentListBody = document.getElementById('student-list-body');
        const btnRegistrarEntrada = document.getElementById('btn-registrar-entrada');
        const btnSolicitarSaida = document.getElementById('btn-solicitar-saida');
        const selecionarTodosCheckbox = document.getElementById('selecionar-todos');
        
        // Modal de Confirmação
        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const locationStatusEl = document.getElementById('locationStatus');
        const confirmActionBtn = document.getElementById('confirmAction');
        const cancelActionBtn = document.getElementById('cancelAction');

        // Modal de Feedback
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackTitle = document.getElementById('feedbackTitle');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const closeFeedbackBtn = document.getElementById('closeFeedback');

        // === INICIALIZAÇÃO ===
        async function initializeApp() {
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    window.location.href = 'index.html';
                    return;
                }

                await loadUserData(accessToken);
                await loadStudents(accessToken);
                setupEventListeners();

            } catch (error) {
                console.error('Erro na inicialização:', error);
                showFeedback('Erro Crítico', 'Não foi possível carregar os dados. Por favor, tente fazer login novamente.');
            }
        }

        // === CARREGAMENTO DE DADOS ===
        async function loadUserData(token) {
            const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Falha ao carregar dados do usuário');
            
            currentUser = await response.json();
            transportadorNomeEl.textContent = currentUser.nome.split(' ')[0]; // Mostra só o primeiro nome
        }

        async function loadStudents(token) {
            showLoadingState();
            try {
                const response = await fetch(`${BACKEND_URL}/api/transporte/meus-alunos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Falha ao carregar lista de alunos');

                const data = await response.json();
                studentsData = data.dados || [];
                renderStudents();

            } catch (error) {
                console.error(error);
                studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger-color); padding: 20px;">${error.message}</td></tr>`;
            }
        }

        // === RENDERIZAÇÃO NA TELA ===
        function renderStudents() {
            studentListBody.innerHTML = '';

            if (studentsData.length === 0) {
                studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">Nenhum aluno associado a você.</td></tr>`;
                disableAllActions();
                return;
            }

            studentsData.forEach(aluno => {
                const tr = document.createElement('tr');
                
                // Definir status e se o checkbox deve estar habilitado
                let statusText, statusClass, checkboxDisabled = false;
                if (aluno.saidaPendente) {
                    statusText = 'Saída Pendente';
                    statusClass = 'status-pending';
                    checkboxDisabled = true;
                } else if (aluno.status === 'PRESENTE') {
                    statusText = 'Presente';
                    statusClass = 'status-present';
                } else {
                    statusText = 'Ausente';
                    statusClass = 'status-absent';
                    checkboxDisabled = true;
                }
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="custom-checkbox student-checkbox" value="${aluno.id}" ${checkboxDisabled ? 'disabled' : ''}>
                    </td>
                    <td>${aluno.nome}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                studentListBody.appendChild(tr);
            });
            updateActionButtonsState();
        }

        function showLoadingState() {
             studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>`;
        }

        // === LÓGICA DE EVENTOS ===
        function setupEventListeners() {
            selecionarTodosCheckbox.addEventListener('change', handleSelectAll);
            studentListBody.addEventListener('change', handleStudentSelection);
            
            btnRegistrarEntrada.addEventListener('click', () => preareBatchAction('entrada'));
            btnSolicitarSaida.addEventListener('click', () => preareBatchAction('saida'));

            cancelActionBtn.addEventListener('click', closeConfirmationModal);
            confirmActionBtn.addEventListener('click', executeBatchAction);
            closeFeedbackBtn.addEventListener('click', closeFeedbackModal);
        }

        function handleSelectAll(event) {
            const isChecked = event.target.checked;
            document.querySelectorAll('.student-checkbox:not(:disabled)').forEach(cb => {
                cb.checked = isChecked;
            });
            updateActionButtonsState();
        }

        function handleStudentSelection() {
            const allCheckboxes = document.querySelectorAll('.student-checkbox:not(:disabled)');
            const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
            
            selecionarTodosCheckbox.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
            updateActionButtonsState();
        }
        
        function updateActionButtonsState() {
            const selectedStudents = getSelectedStudentIds();
            const canRegisterEntry = selectedStudents.some(id => {
                const student = studentsData.find(s => s.id == id);
                return student && student.status === 'AUSENTE' && !student.saidaPendente;
            });

            const canRequestExit = selectedStudents.some(id => {
                 const student = studentsData.find(s => s.id == id);
                return student && student.status === 'PRESENTE' && !student.saidaPendente;
            });

            // Lógica original para habilitar/desabilitar botões de ação em lote
            const anySelected = selectedStudents.length > 0;
            btnRegistrarEntrada.disabled = !anySelected;
            btnSolicitarSaida.disabled = !anySelected;
        }

        function disableAllActions() {
            btnRegistrarEntrada.disabled = true;
            btnSolicitarSaida.disabled = true;
            selecionarTodosCheckbox.disabled = true;
        }

        // === LÓGICA DAS AÇÕES EM LOTE ===
        function getSelectedStudentIds() {
            return Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
        }

        function preareBatchAction(action) {
            currentAction = action;
            const studentIds = getSelectedStudentIds();

            if (studentIds.length === 0) {
                showFeedback('Nenhum Aluno', 'Por favor, selecione pelo menos um aluno.');
                return;
            }

            // Filtrar IDs com base na ação
            const validStudentIds = studentIds.filter(id => {
                const student = studentsData.find(s => s.id == id);
                if (action === 'entrada') return student.status === 'AUSENTE' && !student.saidaPendente;
                if (action === 'saida') return student.status === 'PRESENTE' && !student.saidaPendente;
                return false;
            });

            if (validStudentIds.length === 0) {
                const message = action === 'entrada'
                    ? 'Todos os alunos selecionados já estão presentes ou com saída pendente.'
                    : 'Todos os alunos selecionados já estão ausentes ou com saída pendente.';
                showFeedback('Ação Inválida', message);
                return;
            }

            currentActionPayload = { alunoIds: validStudentIds };
            
            // Abrir modal de confirmação
            const actionText = action === 'entrada' ? 'Registrar Entrada' : 'Solicitar Saída';
            modalTitle.textContent = `Confirmar ${actionText}`;
            modalMessage.textContent = `Você confirma esta ação para ${validStudentIds.length} aluno(s)? A sua localização será registrada.`;
            openConfirmationModal();
        }

        async function executeBatchAction() {
            if (!currentAction || !currentActionPayload) return;

            const endpoint = currentAction === 'entrada' ? '/api/transporte/entrada-em-lote' : '/api/transporte/solicitar-saida-em-lote';
            const payload = { ...currentActionPayload, ...currentActionPayload.location };

            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                closeConfirmationModal();

                if (!response.ok) {
                    throw new Error(result.erros ? result.erros[0] : 'Erro desconhecido do servidor.');
                }
                
                showFeedback('Sucesso!', `Ação de ${currentAction} foi processada com sucesso. A lista será atualizada.`);
                await loadStudents(accessToken); // Recarrega a lista

            } catch (error) {
                console.error(`Erro ao executar ${currentAction}:`, error);
                closeConfirmationModal();
                showFeedback('Erro na Ação', error.message);
            } finally {
                currentAction = null;
                currentActionPayload = null;
            }
        }
        
        // === GEOLOCALIZAÇÃO ===
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocalização não é suportada pelo seu navegador."));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        let message = "Não foi possível obter a localização. ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: message += "Você negou a permissão."; break;
                            case error.POSITION_UNAVAILABLE: message += "Informação de localização indisponível."; break;
                            case error.TIMEOUT: message += "A requisição expirou."; break;
                            default: message += "Ocorreu um erro desconhecido."; break;
                        }
                        reject(new Error(message));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        // === CONTROLE DE MODAIS ===
        async function openConfirmationModal() {
            confirmationModal.style.display = 'flex';
            locationStatusEl.className = 'location-status location-loading';
            locationStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo sua localização...';
            locationStatusEl.style.display = 'block';
            confirmActionBtn.disabled = true;

            try {
                const location = await getLocation();
                currentActionPayload.location = location;
                locationStatusEl.style.display = 'none';
                confirmActionBtn.disabled = false;
            } catch (error) {
                locationStatusEl.className = 'location-status location-error';
                locationStatusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${error.message}`;
            }
        }
        
        function closeConfirmationModal() {
            confirmationModal.style.display = 'none';
            confirmActionBtn.disabled = true;
            locationStatusEl.style.display = 'none';
        }

        function showFeedback(title, message) {
            feedbackTitle.textContent = title;
            feedbackMessage.textContent = message;
            feedbackModal.style.display = 'flex';
        }

        function closeFeedbackModal() {
            feedbackModal.style.display = 'none';
        }

        // --- Inicia a aplicação ---
        initializeApp();
    });

    async function fetchWithAuth(endpoint, options = {}) {
        const headers = { 'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        'Content-Type': 'application/json', ...options.headers };
        const response = await fetch(BACKEND_URL + endpoint,
        { ...options, headers });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.mensagem || `Erro ${response.status}: ${response.statusText}`);
        }
        return response;
    }
    </script>

</body>
</html>