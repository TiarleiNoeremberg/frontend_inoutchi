<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INOUTCHI - Painel do Transportador</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #4a6fa5; /* Azul escuro para transporte */
      --secondary-color: #166088; /* Azul-petróleo */
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-color: #f8f9fa;
      --text-color: #333;
      --border-color: #dee2e6;
      --transition: all 0.3s ease;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f5f5f5;
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.5;
    }
    /* ===== HEADER ===== */
    header {
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      padding: 12px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      position: sticky;
      top: 0;
      z-index: 1020;
    }
    .header-left,
    .header-center,
    .header-right {
      flex: 1;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .header-center {
      text-align: center;
    }
    .header-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .header-logo {
      height: 35px;
      width: auto;
      vertical-align: middle;
    }
    .header-center h1 {
      color: var(--primary-color);
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #logout-button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    @media (max-width: 767px) {
      header {
        padding: 12px 10px;
        width: 100%;
      }
    }
    /* ===== CARD MEUS ALUNOS ===== */
    .students-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
      margin: 20px auto;
      width: 90%;
      max-width: 800px;
      box-sizing: border-box;
    }
    .container-header {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      text-align: center;
    }
    .container-header h2 {
      color: var(--primary-color);
      font-size: 1.2em;
      margin: 0;
    }
    /* ===== ACTIONS BAR ===== */
    .actions-bar {
      padding: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .btn {
      padding: 12px 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 1em;
    }
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .btn-entry {
      background-color: var(--success-color);
      color: white;
    }
    .btn-exit {
      background-color: var(--warning-color);
      color: white;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    .student-table {
      width: 100%;
      border-collapse: collapse;
    }
    .student-table th,
    .student-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    .student-table th {
      background-color: var(--light-color);
      font-weight: 600;
    }
    .student-table tbody tr:hover {
      background-color: #f5f5f5;
    }
    @media (max-width: 767px) {
      .students-container {
        margin: 10px auto;
        width: 95%;
      }
    }
    /* ===== STATUS BADGES ===== */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 700;
    }
    .status-absent {
      background-color: #f8d7da;  /* fundo vermelho claro */
      color: #e74c3c;            /* texto vermelho vivo */
    }
    .status-present {
      background-color: #d4edda;  /* fundo verde claro */
      color: #28a745;            /* texto verde vivo */
    }
    /* Novo estilo para Saída Pendente */
    .status-pending {
        background-color: #fff3cd; /* fundo amarelado */
        color: #FFC107;           /* texto em ambar */
        border: 1px solid #FFC107; /* contorno em ambar */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 700;
    }

    .custom-checkbox {
      transform: scale(1.3);
      accent-color: var(--primary-color);
    }
    /* ===== MODAL (Exemplo simples) ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-left">
      <img src="https://tiarleinoeremberg.github.io/frontend_inoutchi/img/LogoInoutchi.png" class="header-logo" alt="Logotipo Transportador" />
    </div>
    <div class="header-center">
      <h1>Painel do Transportador</h1>
    </div>
    <div class="header-right">
      <div class="user-info">
        <p>Bem-vindo(a), <span id="transportador-nome">carregando...</span></p>
        <button id="logout-button" class="btn btn-danger btn-sm" onclick="logout()">Sair</button>
      </div>
    </div>
  </header>

  <!-- Card Meus Alunos -->
  <div class="students-container">
    <div class="container-header">
      <h2><i class="fa-solid fa-bus-simple"></i> Meus Alunos</h2>
    </div>
    <!-- Actions Bar para ações em lote -->
    <div class="actions-bar">
      <button class="btn btn-entry" id="btn-registrar-entrada" disabled>
        <i class="fa-solid fa-right-to-bracket"></i> Registrar Entrada
      </button>
      <button class="btn btn-exit" id="btn-solicitar-saida" disabled>
        <i class="fa-solid fa-person-walking-arrow-right"></i> Solicitar Saída
      </button>
    </div>
    <div class="table-wrapper">
      <table class="student-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selecionar-todos" class="custom-checkbox"></th>
            <th>Aluno</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="student-list-body">
          <!-- As linhas serão injetadas via JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal-overlay" id="confirmationModal">
    <div class="modal-content">
      <h3 id="modalTitle">Confirmar Ação</h3>
      <p id="modalMessage">Você confirma esta ação?</p>
      <div id="locationStatus" class="location-status" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Obtendo sua localização...
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary modal-btn" id="cancelAction">Cancelar</button>
        <button class="btn btn-primary modal-btn" id="confirmAction" disabled>Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Feedback -->
  <div class="modal-overlay" id="feedbackModal">
    <div class="modal-content">
      <h3 id="feedbackTitle"></h3>
      <p id="feedbackMessage"></p>
      <div class="modal-actions">
        <button class="btn btn-primary modal-btn" id="closeFeedback">OK</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Referência dos elementos
      const btnRegistrarEntrada = document.getElementById('btn-registrar-entrada');
      const btnSolicitarSaida = document.getElementById('btn-solicitar-saida');
      const selecionarTodosCheckbox = document.getElementById('selecionar-todos');
      const studentListBody = document.getElementById('student-list-body');
      const cancelActionBtn = document.getElementById('cancelAction');
      const confirmActionBtn = document.getElementById('confirmAction');
      const closeFeedbackBtn = document.getElementById('closeFeedback');

      // Variáveis globais
      let currentUser = null;
      let studentsData = [];
      let currentAction = null; // 'entrada' ou 'saida'
      let currentActionPayload = null;

      async function initializeApp() {
        try {
          const accessToken = localStorage.getItem('access_token');
          if (!accessToken) {
            window.location.href = 'index.html';
            return;
          }
          await loadUserData(accessToken);
          await loadStudents(accessToken);
          setupEventListeners();
        } catch (error) {
          console.error('Erro na inicialização:', error);
          showFeedback('Erro Crítico', 'Não foi possível carregar os dados. Por favor, tente fazer login novamente.');
        }
      }

      async function loadUserData(token) {
        const response = await fetch(`https://inoutchi-cd92743c8443.herokuapp.com/api/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha ao carregar dados do usuário');
        currentUser = await response.json();
        document.getElementById('transportador-nome').textContent = currentUser.nome.split(' ')[0];
      }

      async function loadStudents(token) {
        studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 40px;">
          <i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>`;
        try {
          const response = await fetch(`https://inoutchi-cd92743c8443.herokuapp.com/api/transporte/meus-alunos`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Falha ao carregar lista de alunos');
          const data = await response.json();
          studentsData = data || [];
          renderStudents();
        } catch (error) {
          console.error(error);
          studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--danger-color); padding: 20px;">
            ${error.message}</td></tr>`;
        }
      }

      function renderStudents() {
        // Ordena os alunos por nome (ordem alfabética)
        studentsData.sort((a, b) => a.nome.toLowerCase().localeCompare(b.nome.toLowerCase()));
        
        studentListBody.innerHTML = '';
        if (studentsData.length === 0) {
          studentListBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">
            Nenhum aluno associado a você.</td></tr>`;
          disableAllActions();
          return;
        }

        studentsData.forEach(aluno => {
            const tr = document.createElement('tr');
            let statusText, statusClass, checkboxDisabled = false;
            
            // Se o aluno tiver a flag de saída pendente, use o novo estilo
            if (aluno.saidaPendente) {
                statusText = 'Saída Pendente';
                statusClass = 'status-pending';
                checkboxDisabled = true;
            } else if (aluno.status === 'PRESENTE') {
                statusText = 'Presente';
                statusClass = 'status-present';
            } else {
                statusText = 'Ausente';
                statusClass = 'status-absent';
            }
            
            tr.innerHTML = `
                <td>
                <input type="checkbox" class="custom-checkbox student-checkbox" value="${aluno.id}" ${checkboxDisabled ? 'disabled' : ''}>
                </td>
                <td>${aluno.nome}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            `;
            studentListBody.appendChild(tr);
        });


        updateActionButtonsState();
      }

      function getSelectedStudentIds() {
        return Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
      }

      function updateActionButtonsState() {
        const selectedStudents = getSelectedStudentIds();
        const anySelected = selectedStudents.length > 0;
        if (btnRegistrarEntrada) btnRegistrarEntrada.disabled = !anySelected;
        if (btnSolicitarSaida) btnSolicitarSaida.disabled = !anySelected;
      }

      function disableAllActions() {
        if (btnRegistrarEntrada) btnRegistrarEntrada.disabled = true;
        if (btnSolicitarSaida) btnSolicitarSaida.disabled = true;
        if (selecionarTodosCheckbox) selecionarTodosCheckbox.disabled = true;
      }

      function setupEventListeners() {
        if (selecionarTodosCheckbox) selecionarTodosCheckbox.addEventListener('change', handleSelectAll);
        if (studentListBody) studentListBody.addEventListener('change', handleStudentSelection);
        if (btnRegistrarEntrada) btnRegistrarEntrada.addEventListener('click', () => preareBatchAction('entrada'));
        if (btnSolicitarSaida) btnSolicitarSaida.addEventListener('click', () => preareBatchAction('saida'));
        if (cancelActionBtn) cancelActionBtn.addEventListener('click', closeConfirmationModal);
        if (confirmActionBtn) confirmActionBtn.addEventListener('click', executeBatchAction);
        if (closeFeedbackBtn) closeFeedbackBtn.addEventListener('click', closeFeedbackModal);
      }

      function handleSelectAll(event) {
        const isChecked = event.target.checked;
        document.querySelectorAll('.student-checkbox:not(:disabled)').forEach(cb => { cb.checked = isChecked; });
        updateActionButtonsState();
      }

      function handleStudentSelection() {
        const allCheckboxes = document.querySelectorAll('.student-checkbox:not(:disabled)');
        const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
        if (selecionarTodosCheckbox) {
          selecionarTodosCheckbox.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
        }
        updateActionButtonsState();
      }

      function preareBatchAction(action) {
        currentAction = action;
        const studentIds = getSelectedStudentIds();
        if (studentIds.length === 0) {
          showFeedback('Nenhum Aluno', 'Por favor, selecione pelo menos um aluno.');
          return;
        }
        const validStudentIds = studentIds.filter(id => {
          const student = studentsData.find(s => s.id == id);
          if (action === 'entrada') return student.status === 'AUSENTE' && !student.saidaPendente;
          if (action === 'saida') return student.status === 'PRESENTE' && !student.saidaPendente;
          return false;
        });
        if (validStudentIds.length === 0) {
          const message = action === 'entrada'
            ? 'Todos os alunos selecionados já estão presentes ou com saída pendente.'
            : 'Todos os alunos selecionados já estão ausentes ou com saída pendente.';
          showFeedback('Ação Inválida', message);
          return;
        }
        currentActionPayload = { alunoIds: validStudentIds };
        const actionText = action === 'entrada' ? 'Registrar Entrada' : 'Solicitar Saída';
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        if (modalTitle) modalTitle.textContent = `Confirmar ${actionText}`;
        if (modalMessage) modalMessage.textContent = `Você confirma esta ação para ${validStudentIds.length} aluno(s)? A sua localização será registrada.`;
        openConfirmationModal();
      }

      async function executeBatchAction() {
        if (!currentAction || !currentActionPayload) return;
        const endpoint = currentAction === 'entrada' ? '/api/transporte/entrada-em-lote' : '/api/transporte/solicitar-saida-em-lote';
        const payload = { ...currentActionPayload, ...currentActionPayload.location };
        try {
          const accessToken = localStorage.getItem('access_token');
          const response = await fetch(`https://inoutchi-cd92743c8443.herokuapp.com${endpoint}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          closeConfirmationModal();
          if (!response.ok) {
            throw new Error(result.erros ? result.erros[0] : 'Erro desconhecido do servidor.');
          }
          showFeedback('Sucesso!', `Ação de ${currentAction} foi processada com sucesso. A lista será atualizada.`);
          await loadStudents(accessToken);
        } catch (error) {
          console.error(`Erro ao executar ${currentAction}:`, error);
          closeConfirmationModal();
          showFeedback('Erro na Ação', error.message);
        } finally {
          currentAction = null;
          currentActionPayload = null;
        }
      }

      function openConfirmationModal() {
        const confirmationModal = document.getElementById('confirmationModal');
        const locationStatusEl = document.getElementById('locationStatus');
        if (confirmationModal) confirmationModal.style.display = 'flex';
        if (locationStatusEl) {
          locationStatusEl.className = 'location-status location-loading';
          locationStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo sua localização...';
          locationStatusEl.style.display = 'block';
        }
        if (confirmActionBtn) confirmActionBtn.disabled = true;
        getLocation().then(location => {
          currentActionPayload.location = location;
          if (locationStatusEl) locationStatusEl.style.display = 'none';
          if (confirmActionBtn) confirmActionBtn.disabled = false;
        }).catch(error => {
          if (locationStatusEl) {
            locationStatusEl.className = 'location-status location-error';
            locationStatusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${error.message}`;
          }
        });
      }

      function closeConfirmationModal() {
        const confirmationModal = document.getElementById('confirmationModal');
        const locationStatusEl = document.getElementById('locationStatus');
        if (confirmationModal) confirmationModal.style.display = 'none';
        if (confirmActionBtn) confirmActionBtn.disabled = true;
        if (locationStatusEl) locationStatusEl.style.display = 'none';
      }

      function showFeedback(title, message) {
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackTitle = document.getElementById('feedbackTitle');
        const feedbackMessage = document.getElementById('feedbackMessage');
        if (feedbackTitle) feedbackTitle.textContent = title;
        if (feedbackMessage) feedbackMessage.textContent = message;
        if (feedbackModal) feedbackModal.style.display = 'flex';
      }

      function closeFeedbackModal() {
        const feedbackModal = document.getElementById('feedbackModal');
        if (feedbackModal) feedbackModal.style.display = 'none';
      }

      function getLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocalização não é suportada pelo seu navegador."));
            return;
          }
          navigator.geolocation.getCurrentPosition(
            position => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
              });
            },
            error => {
              let message = "Não foi possível obter a localização. ";
              switch (error.code) {
                case error.PERMISSION_DENIED: message += "Você negou a permissão."; break;
                case error.POSITION_UNAVAILABLE: message += "Informação de localização indisponível."; break;
                case error.TIMEOUT: message += "A requisição expirou."; break;
                default: message += "Ocorreu um erro desconhecido."; break;
              }
              reject(new Error(message));
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        });
      }

      // Inicia a aplicação
      initializeApp();

      // Configura o botão de logout com confirmação
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          if (confirm("Você tem certeza que deseja sair do sistema?")) {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('token_expiry');
            window.location.href = 'index.html';
          }
        });
      }
    });
  </script>
</body>
</html>
