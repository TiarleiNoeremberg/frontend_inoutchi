<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - INOUTCHI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #4a6fa5;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        main {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .btn-logout {
            background-color: #e74c3c;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        .api-result {
            margin-top: 20px;
            padding: 10px;
            background: #eef6ff;
            border: 1px solid #cce4ff;
            border-radius: 5px;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6fa5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h2>INOUTCHI - Dashboard</h2>
        <button class="btn-logout" onclick="logout()">Sair</button>
    </header>

    <main>
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Verificando autentica칞칚o...</p>
        </div>

        <div id="content" style="display: none;">
            <h3>Bem-vindo, <span id="username">Usu치rio</span> 游녦</h3>
            <button onclick="loadProtectedData()">Carregar dados protegidos</button>
            <div id="apiResult" class="api-result" style="display:none;"></div>
        </div>

        <div id="error" style="display: none; text-align: center; color: #e74c3c;">
            <h3>Erro de autentica칞칚o</h3>
            <p>Redirecionando para login...</p>
        </div>
    </main>

    <script>
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
        const CLIENT_ID = 'myclientid';
        const CLIENT_SECRET = 'myclientsecret';

        // Elementos DOM
        const loadingElement = document.getElementById('loading');
        const contentElement = document.getElementById('content');
        const errorElement = document.getElementById('error');

        // Fun칞칚o principal de inicializa칞칚o
        async function initializeDashboard() {
            console.log('Inicializando dashboard...');
            
            const accessToken = localStorage.getItem('access_token');
const refreshToken = localStorage.getItem('refresh_token'); 
const expiry = localStorage.getItem('token_expiry');

console.log('Access Token:', accessToken ? 'PRESENTE' : 'AUSENTE');
console.log('Refresh Token:', refreshToken ? 'PRESENTE' : 'AUSENTE');
console.log('Expiry:', expiry);

// Permite proceed mesmo sem refresh token v치lido
if (!accessToken || !expiry) {
    console.log('REDIRECIONANDO: Access token ou expiry ausentes');
    alert("Sess칚o expirada ou inexistente. Fa칞a login novamente.");
    window.location.href = "index.html";
} else if (new Date().getTime() > parseInt(expiry)) {
    console.log('REDIRECIONANDO: Token expirado');
    alert("Sess칚o expirada. Fa칞a login novamente.");
    window.location.href = "index.html";
} else {
    console.log('TOKEN V츼LIDO - Carregando dashboard');
    // Continua mesmo sem refresh token
    showContent();
    updateUserInfo();
}

            // Verifica se o token est치 expirado
            const isExpired = new Date().getTime() > parseInt(expiry);
            console.log('Token expirado?', isExpired);

            if (isExpired) {
                console.log('Token expirado - tentando renovar...');
                const refreshed = await refreshAccessToken(refreshToken);
                if (!refreshed) {
                    showError();
                    return;
                }
            }

            // Se chegou aqui, est치 autenticado
            showContent();
            updateUserInfo();
        }

        // Fun칞칚o para renovar o token
        async function refreshAccessToken(refreshToken) {
            try {
                const response = await fetch(`${BACKEND_URL}/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(`${CLIENT_ID}:${CLIENT_SECRET}`)
                    },
                    body: new URLSearchParams({
                        'grant_type': 'refresh_token',
                        'refresh_token': refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Token renovado com sucesso');

                    // Salva os novos tokens
                    const expiryTime = new Date().getTime() + (data.expires_in * 1000);
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token || refreshToken);
                    localStorage.setItem('token_expiry', expiryTime.toString());

                    return true;
                } else {
                    console.error('Erro ao renovar token:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Erro na renova칞칚o:', error);
                return false;
            }
        }

        // Atualiza informa칞칫es do usu치rio
        function updateUserInfo() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const payload = parseJwt(accessToken);
                const username = payload.username || payload.sub || 'Usu치rio';
                document.getElementById('username').textContent = username;
            } catch (error) {
                console.error('Erro ao decodificar token:', error);
            }
        }

        // Decodifica JWT
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Erro ao decodificar JWT:', e);
                return {};
            }
        }

        // Mostra conte칰do principal
        function showContent() {
            loadingElement.style.display = 'none';
            contentElement.style.display = 'block';
            errorElement.style.display = 'none';
        }

        // Mostra erro
        function showError() {
            loadingElement.style.display = 'none';
            contentElement.style.display = 'none';
            errorElement.style.display = 'block';
            
            // Redireciona ap칩s breve delay
            setTimeout(() => {
                logout();
            }, 2000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('token_expiry');
            window.location.href = 'index.html';
        }

        // Carrega dados protegidos
        async function loadProtectedData() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/alunos`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const apiResult = document.getElementById('apiResult');
                apiResult.style.display = 'block';

                if (response.ok) {
                    const data = await response.json();
                    apiResult.textContent = JSON.stringify(data, null, 2);
                } else {
                    apiResult.textContent = `Erro ${response.status}: ${response.statusText}`;
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao conectar ao servidor');
            }
        }

        // Inicializa a dashboard quando o documento carregar
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>