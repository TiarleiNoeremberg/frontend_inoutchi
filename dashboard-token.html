<!DOCTYPE html>
<!-- saved from url=(0109)https://pareto-workflows.storage.googleapis.com/8a7867510aff20526d31a9aa95b89ad4e50126d2/dashboard-token.html -->
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso por Token - inoutchi</title>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
                :root {
            --primary-color: #2f86eb;
            --secondary-color: #4A6FA5;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --body-bg: #f4f7f6;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-color: #e9ecef;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--body-bg);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        .logo img {
            max-width: 250px;
            height: auto;
            margin-bottom: 25px;
        }
        .card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 30px;
        }
        .card-header h2 {
            margin: 0 0 10px;
            font-size: 1.5rem;
            color: var(--secondary-color);
        }
        .card-header .text-muted {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 20px;
        }
        .loading, .error-message, .final-message {
            padding: 40px 20px;
            text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
        .success-text .fa-check-circle {
            color: var(--success-color);
            margin-right: 8px;
        }
        .error-message, .final-message.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border-radius: 8px;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        .error-message i, .final-message i {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        #content, #finalMessage, #loading, #errorMessage {
            display: none;
        }
        .info-group {
            text-align: left;
            margin-bottom: 25px;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
        }
        .info-group p {
            margin: 8px 0;
            font-size: 1rem;
        }
        .info-group strong {
            color: var(--secondary-color);
        }
        .btn {
            display: inline-block;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn .btn-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        .location-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 0.9rem;
            display: none;
        }
        .location-loading {
            background-color: rgba(74, 111, 165, 0.1);
            color: var(--primary-color);
        }
        .location-error {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        .final-message.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }
        .final-message i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

    </style>

<body>
    <div class="container">
        <div class="logo">
        <img src="./img/inoutchi2.png" alt="Logotipo INOUTCHI" style="max-width: 250px;">
        </div>
    <div class="card" id="mainCard">
        <!-- SEÇÃO 1: MENSAGENS DE ESTADO GLOBAL (CARREGANDO E ERRO INICIAL) -->
        <!-- Esta parte permanece a mesma, para validação inicial do token -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Validando acesso, por favor aguarde...</p>
        </div>
        <div class="error-message" id="errorMessage" style="display: block;">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 id="errorTitle">Token não encontrado</h3>
            <p id="errorDetails">O link de acesso parece estar incompleto ou é inválido. Por favor, verifique o link que você recebeu.</p>
            <button class="btn" id="fechar-erro-btn" style="margin-top: 20px;">Fechar</button>
        </div>

        <!-- SEÇÃO 2: VISÃO DE SOLICITAÇÃO (ETAPA 1) -->
        <!-- Substitui o #content original. Fica visível após a validação do token -->
        <div id="initial-view" style="display: none;">
            <div class="card-header">
                <h2>Confirmação de Acesso</h2>
                <p class="text-muted">Olá, <strong id="destinatario"></strong>!</p>
            </div>
            <div class="info-group">
                <p>Você recebeu permissão para realizar a seguinte operação:</p>
                <p><strong>Aluno:</strong> <span id="alunoNome"></span></p>
                <p><strong>Operação:</strong> <span id="operacaoTipo"></span></p>
                <p><strong>Observação:</strong> <span id="observacao"></span></p>
            </div>
            <div class="location-status" id="locationStatus"></div>
            <button class="btn" id="solicitar-saida-btn">
                <span class="btn-spinner" id="solicitarSpinner" style="display: none;"></span>
                <span id="solicitarBtnText">Solicitar Saída</span>
            </button>
        </div>

        <!-- SEÇÃO 3: VISÃO DE CONFIRMAÇÃO (ETAPA 2) -->
        <!-- Esta é a nova tela que aparece após a solicitação ser bem-sucedida -->
        <div id="confirmation-view" style="display: none;">
             <div class="card-header">
                <h2>Aguardando no Portão</h2>
            </div>
            <div class="info-group-confirm">
                <p class="success-text"><i class="fas fa-check-circle"></i> Solicitação enviada! O aluno foi notificado.</p>
                <p>Por favor, dirija-se ao portão para encontrá-lo(a).</p>
                <p class="highlight"><strong>Apenas clique no botão abaixo quando o aluno estiver com você.</strong></p>
            </div>
            <button class="btn confirm" id="confirmar-saida-btn">
                 <span class="btn-spinner" id="confirmarSpinner" style="display: none;"></span>
                <span id="confirmarBtnText">Confirmar posse do Aluno</span>
            </button>
        </div>
        
        <!-- SEÇÃO 4: MENSAGEM DE SUCESSO FINAL -->
        <!-- Seu `finalMessage` original, que será usado após a Etapa 2 ser concluída -->
        <div class="final-message" id="finalMessage" style="display: none;">
            <i id="finalIcon"></i>
            <h3 id="finalTitle"></h3>
            <p id="finalDetails"></p>
            <button class="btn" id="fechar-final-btn" style="margin-top: 20px;">Fechar</button>
        </div>
    </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BACKEND_URL = 'https://inoutchi-backend.onrender.com';

            let currentToken = '';
            let locationData = { latitude: null, longitude: null };
            let currentOperationType = '';
            

            // Elementos da UI
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const finalMessage = document.getElementById('finalMessage');
            const content = document.getElementById('content');

            const loadingView = document.getElementById('loading');
            const initialView = document.getElementById('initial-view');
            const confirmationView = document.getElementById('confirmation-view');
            const finalMessageView = document.getElementById('finalMessage');
            const errorMessageView = document.getElementById('errorMessage');

            const actionButton = document.getElementById('actionButton');
            const buttonSpinner = document.getElementById('buttonSpinner');
            const buttonText = document.getElementById('buttonText');
            const locationStatus = document.getElementById('locationStatus');

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
                        
            const finalView = document.getElementById('final-view');
            const errorView = document.getElementById('error-view');

            // Elementos da tela de erro
            const errorTitle = document.getElementById('errorTitle');
            const errorDetails = document.getElementById('errorDetails');

            // Elementos da tela final
            const finalIcon = document.getElementById('finalIcon');
            const finalTitle = document.getElementById('finalTitle');
            const finalDetails = document.getElementById('finalDetails');
            
            // Elementos da tela inicial
            const destinatarioNome = document.getElementById('destinatario');
            const alunoNome = document.getElementById('alunoNome');
            const operacaoTipo = document.getElementById('operacaoTipo');
            const observacao = document.getElementById('observacao');

            // Botões e seus componentes
            const solicitarBtn = document.getElementById('solicitar-saida-btn');
            const solicitarSpinner = document.getElementById('solicitarSpinner');
            const solicitarBtnText = document.getElementById('solicitarBtnText');
            
            const confirmarBtn = document.getElementById('confirmar-saida-btn');
            const confirmarSpinner = document.getElementById('confirmarSpinner');
            const confirmarBtnText = document.getElementById('confirmarBtnText');

            const fecharFinalBtn = document.getElementById('fechar-final-btn');
            const fecharErroBtn = document.getElementById('fechar-erro-btn');
            
            function showFeedback(message, type = 'info') {
                const feedbackElement = document.getElementById('feedback');
                if (feedbackElement) {
                    feedbackElement.textContent = message;
                    // Limpa classes antigas e adiciona as novas
                    feedbackElement.className = `feedback feedback-${type}`;
                    feedbackElement.style.display = 'block';
                }
            }

            function showState(state) {
                loading.style.display = 'none';
                errorMessage.style.display = 'none';
                finalMessage.style.display = 'none';
                content.style.display = 'none';
                if (state) state.style.display = 'block';
            }

            /**
             * Exibe a tela de erro com títulos e detalhes personalizados.
             * @param {string} title - O título do erro.
             * @param {string} details - A descrição do erro.
             */
            function showError(title, details) {
                errorTitle.textContent = title;
                errorDetails.textContent = details;
                showView(errorMessageView);
            }

            /**
             * Exibe a mensagem final de sucesso ou erro.
             * @param {'success'|'error'} type - O tipo de mensagem.
             * @param {string} title - O título da mensagem.
             * @param {string} message - O corpo da mensagem.
             */
            function showFinalMessage(type, title, message) {
                finalIcon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-times-circle';
                finalTitle.textContent = title;
                finalDetails.textContent = message;
                finalMessageView.className = `final-message ${type}`; // Adiciona classe para estilização
                showView(finalMessageView);
            }

            /**
             * Alterna o estado de carregamento de um botão.
             * @param {HTMLButtonElement} button - O botão a ser controlado.
             * @param {HTMLElement} spinner - O elemento do spinner.
             * @param {HTMLElement} textElement - O elemento de texto do botão.
             * @param {boolean} isLoading - Define se o estado é "carregando".
             */
            function toggleButtonLoading(button, spinner, textElement, isLoading) {
                button.disabled = isLoading;
                spinner.style.display = isLoading ? 'inline-block' : 'none';
                textElement.style.display = isLoading ? 'inline-block' : 'none';
            }

            /**
             * Inicializa a página, valida o token e prepara a interface.
             */
            async function initialize() {
                showView(loadingView);
                const token = new URLSearchParams(window.location.search).get('token');

                if (!token) {
                    showError('Token não encontrado',
                    'O link de acesso parece estar incompleto ou é inválido. Por favor, verifique o link que você recebeu.');
                    return;
                }

                try {
                    const response = await fetch(`${BACKEND_URL}/api/tokens/validar/${token}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.mensagem || `Erro no servidor (Status: ${response.status}).`);
                    }

                    if (data.status === 'UTILIZADO') {
                        showFinalMessage('error', 'Token Já Utilizado', `Este link para ${data.alunoNome || 'o aluno'} já foi usado em ${new Date(data.utilizadoEm).toLocaleString('pt-BR')}.`);
                        return;
                    }
                    
                    // Popula a interface com os dados da validação
                    destinatarioNome.textContent = data.destinatario || 'Não informado';
                    alunoNome.textContent = data.alunoNome || 'Não informado';
                    operacaoTipo.textContent = data.operacoesPermitidas || 'Não informada';
                    observacao.textContent = data.observacao || 'Nenhuma.';

                    currentOperationType = data.operacoesPermitidas;

                    // --- LÓGICA DINÂMICA BASEADA NA OPERAÇÃO ---
                    if (currentOperationType === 'ENTRADA') {
                        // Configura para fluxo de ENTRADA (1 etapa)
                        solicitarBtnText.textContent = "Confirmar Entrada do Aluno";
                        solicitarBtn.addEventListener('click', () => executarEntrada(token));
                        showView(initialView);

                    } else if (currentOperationType === 'SAIDA') {
                        // Configura para fluxo de SAÍDA (2 etapas)
                        solicitarBtnText.textContent = "Solicitar Saída";
                        solicitarBtn.addEventListener('click', () => solicitarSaida(token));
                        confirmarBtn.addEventListener('click', () => confirmarSaida(token));
                        showView(initialView);

                    } else {
                        throw new Error('O tipo de operação recebido do servidor não é válido.');
                    }

                } catch (error) {
                    showError('Falha na Validação', error.message);
                }
            }

            /**
             * Exibe uma mensagem de status durante o processo.
             * @param {string} message - A mensagem a ser exibida.
             * @param {boolean} isError - Se a mensagem é de erro.
             */
            function showStatus(message, isError = false) {
                const statusContainer = document.getElementById('statusContainer'); // Garanta que este elemento exista no seu HTML
                if (statusContainer) {
                    statusContainer.innerHTML = `<div class="alert ${isError ? 'alert-danger' : 'alert-info'}">${message}</div>`;
                    statusContainer.style.display = 'block';
                }
            }

            /**
             * Controla qual "tela" (div) é exibida para o usuário.
             * @param {HTMLElement} viewToShow - O elemento da tela a ser exibido.
             */
            function showView(viewToShow) {
                // Esconde todas as telas primeiro
                loadingView.style.display = 'none';
                initialView.style.display = 'none';
                confirmationView.style.display = 'none';
                finalMessageView.style.display = 'none';
                errorMessageView.style.display = 'none';
                
                // Exibe a tela desejada
                if (viewToShow) {
                    viewToShow.style.display = 'block';
                }
            }

            function fecharPagina() {
                // Esta função tenta fechar a janela ou aba do navegador.
                // AVISO: Por motivos de segurança, navegadores modernos podem impedir que scripts fechem
                // uma janela que não foi aberta pelo próprio script. No entanto, para páginas abertas
                // a partir de links (como em um e-mail ou app), isso geralmente funciona.
                window.close();
            }

            /**
             * Obtém a geolocalização do usuário, exibindo feedback na tela durante o processo.
             * @returns {Promise<GeolocationPosition>} Retorna a posição em caso de sucesso.
             * @throws {Error} Lança um erro com mensagem amigável em caso de falha.
             */
            async function obterGeolocalizacaoComFeedback() {
                const locationStatus = document.getElementById('locationStatus');
                
                // Mostra o feedback de carregamento
                locationStatus.innerHTML = '<i class="fas fa-map-marker-alt"></i> Obtendo sua localização para validação...';
                locationStatus.className = 'location-status location-loading';
                locationStatus.style.display = 'block';

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000, // 15 segundos de timeout
                            maximumAge: 0
                        });
                    });
                    
                    // Exibe as coordenadas obtidas antes de esconder
                    const { latitude, longitude } = position.coords;
                    locationStatus.innerHTML = `<i class="fas fa-check"></i> Coordenadas obtidas: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    
                    // Aguarda um instante para o usuário ver as coordenadas
                    await new Promise(resolve => setTimeout(resolve, 1500)); 
                    
                    locationStatus.style.display = 'none'; // Esconde após o sucesso
                    return position;

                } catch (error) {
                    locationStatus.style.display = 'none'; // Esconde também em caso de erro
                    let msg = '';
                    if (error.code === 1) msg = "Acesso à localização negado. Você precisa permitir o uso da sua localização para continuar.";
                    else if (error.code === 2) msg = "Não foi possível obter sua localização. Verifique sua conexão de rede ou sinal de GPS.";
                    else if (error.code === 3) msg = "A obtenção de localização demorou demais. Por favor, tente novamente.";
                    else msg = "Ocorreu um erro desconhecido ao obter a localização.";
                    
                    // Lança um novo erro que será capturado pelo bloco catch da função chamadora
                    throw new Error(msg);
                }
            }

            /**
             * ETAPA 1: Notifica o aluno para sair, validando a geolocalização.
             * @param {string} token - O token de acesso.
             */
            async function solicitarSaida(token) {
                toggleButtonLoading(solicitarBtn, solicitarSpinner, solicitarBtnText, true);

                try {
                    // 1. Obter geolocalização com feedback visual para o usuário
                    const position = await obterGeolocalizacaoComFeedback();
                    const { latitude, longitude } = position.coords;

                    // 2. Enviar para o backend para validação de geofence e execução da operação
                    const response = await fetch(`${BACKEND_URL}/api/tokens/executar-operacao`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            token, 
                            tipo: "SAIDA", 
                            latitude, 
                            longitude 
                        })
                    });

                    const data = await response.json();
                    
                    // Se a resposta não for OK, o backend deve ter enviado a razão (ex: fora do geofence)
                    if (!response.ok) {
                        throw new Error(data.mensagem || 'Falha ao solicitar a saída. Tente novamente.');
                    }
                    
                    // 3. Se tudo deu certo, avança para a próxima etapa
                    showView(confirmationView);

                } catch (error) {
                    // Captura erros tanto da geolocalização quanto do backend
                    showError('Procedimento Abortado', error.message);
                } finally {
                    // Garante que o botão seja reativado em caso de erro
                    toggleButtonLoading(solicitarBtn, solicitarSpinner, solicitarBtnText, false);
                }
            }

            /**
             * ETAPA 2: Confirma a retirada do aluno.
             * @param {string} token - O token de acesso.
             */
            async function confirmarSaida(token) {
                toggleButtonLoading(confirmarBtn, confirmarSpinner, confirmarBtnText, true);

                try {
                    const response = await fetch(`${BACKEND_URL}/api/presencas/confirmar-saida/token`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });

                    const data = await response.json();
                    if (!response.ok || !data.sucesso) {
                        throw new Error(data.mensagem || 'Falha ao confirmar a retirada.');
                    }

                    showFinalMessage('success', 'Operação Concluída!', data.mensagem);

                } catch (error) {
                    alert(`Erro ao confirmar: ${error.message}\n\nVocê pode tentar confirmar novamente.`);
                    toggleButtonLoading(confirmarBtn, confirmarSpinner, confirmarBtnText, false);
                }
            }

            /**
             * ETAPA ÚNICA: Confirma a entrada do aluno, validando a geolocalização.
             * @param {string} token - O token de acesso.
             */
            async function executarEntrada(token) {
                toggleButtonLoading(solicitarBtn, solicitarSpinner, solicitarBtnText, true);

                try {
                    // 1. Obter geolocalização com feedback visual para o usuário
                    const position = await obterGeolocalizacaoComFeedback();
                    const { latitude, longitude } = position.coords;

                    // 2. Enviar para o backend com tipo ENTRADA para validação do geofence
                    const response = await fetch(`${BACKEND_URL}/api/tokens/executar-operacao`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            token, 
                            tipo: "ENTRADA",
                            latitude, 
                            longitude 
                        })
                    });

                    const data = await response.json();
                    
                    // Se a resposta não for OK, o backend indica o motivo (ex: fora do geofence)
                    if (!response.ok) {
                        throw new Error(data.mensagem || 'Falha ao registrar a entrada.');
                    }
                    
                    // 3. Mostrar mensagem final de sucesso
                    showFinalMessage('success', 'Entrada Confirmada!', data.mensagem);

                } catch (error) {
                    // Exibe o erro (de geolocalização ou do backend)
                    showFinalMessage('error', 'Procedimento Abortado', error.message);
                }
                // O botão não precisa ser reativado pois já estamos na tela final (sucesso ou erro).
            }

            fecharFinalBtn.addEventListener('click', fecharPagina);
            fecharErroBtn.addEventListener('click', fecharPagina);

            initialize();

        });
    </script>


</body></html>