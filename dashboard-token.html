<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmação de Saída - Inoutchi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Corrigindo o caminho do CSS. Ajuste se a sua estrutura de pastas for diferente. -->
    <link rel="stylesheet" href="../assets/css/token.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="https://inoutchi.com.br/wp-content/uploads/2024/05/logo-inoutchi.png" alt="Logo Inoutchi" class="logo">
        </header>

        <div id="loadingState">
            <div class="spinner"></div>
            <p>Validando token...</p>
        </div>

        <div id="errorState" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h1 id="errorTitle"></h1>
            <p id="errorMessage"></p>
            <a href="https://inoutchi.com.br" class="btn btn-primary">Voltar ao Início</a>
        </div>
        
        <div id="successState" style="display: none;">
            <div id="initialContent">
                <i class="fas fa-user-check fa-3x"></i>
                <h1>Saída de Aluno</h1>
                <p>Você foi autorizado a retirar o(a) aluno(a) <strong id="studentName"></strong>.</p>
                <div class="info-box">
                    <p><strong>Responsável pela Retirada:</strong> <span id="tutorName"></span></p>
                    <p><strong>Escola:</strong> <span id="schoolName"></span></p>
                </div>
                <!-- Este botão inicia o processo e abre o modal de localização -->
                <button id="startRequestBtn" class="btn btn-primary">
                    <i class="fas fa-walking"></i> Solicitar Saída do Aluno
                </button>
            </div>

            <div id="awaitingPickupContent" style="display: none;">
                <i class="fas fa-hourglass-half fa-3x"></i>
                <h1>Aguardando o Aluno</h1>
                <p>A sala foi notificada. Por favor, dirija-se ao ponto de encontro para retirar o(a) aluno(a) <strong id="studentName2"></strong>.</p>
                <!-- Este botão finaliza o processo -->
                <button id="confirmPickupBtn" class="btn btn-success">
                    <i class="fas fa-check-circle"></i> Confirmar Retirada do Aluno
                </button>
            </div>
            
            <div id="finalMessage" style="display: none;">
                <i class="fas fa-shield-alt fa-3x"></i>
                <h1>Operação Concluída!</h1>
                <p id="finalMessageText"></p>
            </div>
        </div>
    </div>

    <!-- Modal de Geolocalização -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Verificação de Segurança</h2>
            <p>Para prosseguir, precisamos confirmar sua localização. Isso garante que a solicitação está sendo feita de dentro da área segura da escola.</p>
            
            <div id="locationStatus" class="location-status" style="display: none;"></div>

            <div class="modal-actions">
                <button id="getLocationBtn" class="btn btn-primary">
                    <i class="fas fa-map-marker-alt"></i> Obter Localização
                </button>
                <button id="sendRequestBtn" class="btn btn-success" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar Solicitação
                </button>
                 <button id="cancelModalBtn" class="btn btn-secondary">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';
        let currentToken = '';
        let locationData = { latitude: null, longitude: null };

        // Elementos da UI
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const successState = document.getElementById('successState');
        const initialContent = document.getElementById('initialContent');
        const awaitingPickupContent = document.getElementById('awaitingPickupContent');
        const finalMessage = document.getElementById('finalMessage');

        // Botões
        const startRequestBtn = document.getElementById('startRequestBtn');
        const confirmPickupBtn = document.getElementById('confirmPickupBtn');

        // Modal de Localização
        const locationModal = document.getElementById('locationModal');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const sendRequestBtn = document.getElementById('sendRequestBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const locationStatus = document.getElementById('locationStatus');

        /**
         * Lida com a exibição de erros genéricos
         */
        function showError(title, message) {
            loadingState.style.display = 'none';
            successState.style.display = 'none';
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            errorState.style.display = 'block';
        }

        /**
         * Controla o modal de localização
         */
        function openLocationModal() {
            locationModal.style.display = 'flex';
        }

        function closeLocationModal() {
            locationModal.style.display = 'none';
            // Reseta o estado do modal
            locationStatus.style.display = 'none';
            sendRequestBtn.disabled = true;
            getLocationBtn.disabled = false;
            getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Obter Localização';
        }

        /**
         * Obtém a geolocalização do usuário
         */
        async function getLocation() {
            getLocationBtn.disabled = true;
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo...';
            locationStatus.style.display = 'block';
            locationStatus.className = 'location-status';
            locationStatus.textContent = 'Solicitando permissão de localização...';

            if (!navigator.geolocation) {
                showLocationError('Geolocalização não é suportada por este navegador.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    locationData.latitude = position.coords.latitude;
                    locationData.longitude = position.coords.longitude;
                    locationStatus.className = 'location-status success';
                    locationStatus.innerHTML = `<i class="fas fa-check-circle"></i> Localização obtida com sucesso!`;
                    sendRequestBtn.disabled = false;
                    getLocationBtn.style.display = 'none';
                },
                (error) => {
                    let errorMessage = 'Ocorreu um erro ao obter a localização.';
                    if (error.code === 1) errorMessage = 'Permissão de localização negada.';
                    if (error.code === 2) errorMessage = 'Não foi possível determinar a localização.';
                    showLocationError(errorMessage);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function showLocationError(message) {
            locationStatus.className = 'location-status error';
            locationStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            sendRequestBtn.disabled = true;
            getLocationBtn.disabled = false;
            getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Tentar Novamente';
        }

        /**
         * Envia a solicitação de saída para o backend
         */
        async function sendExitRequest() {
            sendRequestBtn.disabled = true;
            sendRequestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/presencas/saida/solicitar-por-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: currentToken,
                        latitude: locationData.latitude,
                        longitude: locationData.longitude
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Falha ao enviar solicitação.');
                }
                
                // Sucesso!
                closeLocationModal();
                initialContent.style.display = 'none';
                awaitingPickupContent.style.display = 'block';

            } catch (error) {
                alert(`Erro ao solicitar saída: ${error.message}`);
                closeLocationModal(); // Fecha o modal em caso de erro também
            } finally {
                sendRequestBtn.disabled = false;
                 sendRequestBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitação';
            }
        }


        /**
         * Confirma a retirada final do aluno
         */
        async function confirmPickup() {
            confirmPickupBtn.disabled = true;
            confirmPickupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';
            try {
                const response = await fetch(`${BACKEND_URL}/api/presencas/confirmar-saida/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });

                if (!response.ok) {
                    // Tenta ler como texto, pois um 401 pode não ter corpo JSON
                    const errorText = await response.text();
                    console.error("Erro na resposta do servidor:", errorText);
                    throw new Error(`Erro ${response.status}: Falha na comunicação com o servidor.`);
                }
                
                const result = await response.json();
                
                const studentName = document.getElementById('studentName').textContent;
                document.getElementById('finalMessageText').textContent = `A retirada do(a) aluno(a) '${studentName}' foi processada com sucesso.`;
                
                awaitingPickupContent.style.display = 'none';
                finalMessage.style.display = 'block';

            } catch (error) {
                console.error('Erro de rede na confirmação:', error);
                alert(`Erro ao confirmar: ${error.message}`);
            } finally {
                confirmPickupBtn.disabled = false;
                confirmPickupBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Retirada do Aluno';
            }
        }


        /**
         * Inicialização da página
         */
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            currentToken = params.get('token');

            if (!currentToken) {
                showError('Token Inválido', 'O link de acesso utilizado é inválido ou expirou.');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/tokens/validar/${currentToken}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Token inválido ou expirado.');
                }
                const data = await response.json();

                // Preenche os dados na tela
                document.getElementById('studentName').textContent = data.alunoNome;
                document.getElementById('studentName2').textContent = data.alunoNome;
                document.getElementById('tutorName').textContent = data.destinatarioNome;
                document.getElementById('schoolName').textContent = data.escolaNome;
                
                // Exibe o conteúdo correto
                loadingState.style.display = 'none';
                successState.style.display = 'block';

            } catch (error) {
                showError('Falha na Validação', error.message);
            }
        });
        
        // Listeners dos botões
        startRequestBtn.addEventListener('click', openLocationModal);
        confirmPickupBtn.addEventListener('click', confirmPickup);
        
        // Listeners do Modal
        cancelModalBtn.addEventListener('click', closeLocationModal);
        getLocationBtn.addEventListener('click', getLocation);
        sendRequestBtn.addEventListener('click', sendExitRequest);

    </script>
</body>
</html>
