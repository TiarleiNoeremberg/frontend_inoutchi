<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmação de Operação - InOutchi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/token.css">
</head>
<body>

    <div class="container">
        <!-- Cabeçalho com Logo -->
        <header class="header">
            <img src="https://tess-cdn.pareto.io/assets/uploads/45e738a3-d1f9-47db-9a48-22417bb5490d.png" alt="Logo InOutchi" class="logo">
        </header>
        
        <!-- 1. Estado de Carregamento Inicial -->
        <div id="loading" class="card">
            <div class="spinner"></div>
            <p>Validando acesso...</p>
        </div>

        <!-- 2. Estado de Erro -->
        <div id="errorMessage" class="card final-message error" style="display: none;">
            <i id="finalIconError" class="fas fa-times-circle"></i>
            <h2 id="errorTitle">Link Inválido</h2>
            <p id="errorDetails">O link de acesso parece estar incorreto, expirou ou já foi utilizado.</p>
        </div>

        <!-- 3. Etapa 1: Solicitar Saída -->
        <div id="initialStep" class="card" style="display: none;">
            <h2>Solicitação de Saída</h2>
            <div class="info-grid">
                <div><span>Aluno(a):</span> <strong id="alunoNome"></strong></div>
                <div><span>Responsável:</span> <strong id="destinatarioNome"></strong></div>
                <div><span>Operação:</span> <strong id="operacaoTipo"></strong></div>
            </div>
            <p class="observacao"><strong>Observação:</strong> <span id="observacao"></span></p>
            
            <div id="locationStatus" class="location-status" style="display: none;"></div>
            
            <button id="requestExitButton" class="btn">
                <i class="fas fa-walking"></i>
                <span id="requestButtonText">Solicitar Saída do Aluno</span>
            </button>
        </div>

        <!-- 4. Etapa 2: Confirmar Retirada -->
        <div id="confirmationStep" class="card" style="display: none;">
            <i class="fas fa-user-clock icon-header"></i>
            <h2>Aguardando Aluno</h2>
            <p id="confirmationMessage" class="status-info"></p>
            <p>Quando o aluno(a) estiver com você no ponto de encontro, clique no botão abaixo para finalizar a retirada.</p>
            
            <button id="confirmPickupButton" class="btn btn-success">
                <i class="fas fa-check-double"></i>
                <span id="confirmButtonText">Confirmar Retirada do Aluno</span>
            </button>
        </div>

        <!-- 5. Mensagem Final (Sucesso ou Falha) -->
        <div id="finalMessage" class="card final-message" style="display: none;">
            <i id="finalIcon" class=""></i>
            <h2 id="finalTitle"></h2>
            <p id="finalDetails"></p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';

        // Mapeamento de todos os elementos da UI
        const ui = {
            loading: document.getElementById('loading'),
            errorMessage: document.getElementById('errorMessage'),
            errorTitle: document.getElementById('errorTitle'),
            errorDetails: document.getElementById('errorDetails'),
            finalMessage: document.getElementById('finalMessage'),
            finalIcon: document.getElementById('finalIcon'),
            finalTitle: document.getElementById('finalTitle'),
            finalDetails: document.getElementById('finalDetails'),
            
            initialStep: document.getElementById('initialStep'),
            alunoNome: document.getElementById('alunoNome'),
            destinatarioNome: document.getElementById('destinatarioNome'),
            operacaoTipo: document.getElementById('operacaoTipo'),
            observacao: document.getElementById('observacao'),
            locationStatus: document.getElementById('locationStatus'),
            requestExitButton: document.getElementById('requestExitButton'),
            requestButtonText: document.getElementById('requestButtonText'),
            
            confirmationStep: document.getElementById('confirmationStep'),
            confirmationMessage: document.getElementById('confirmationMessage'),
            confirmPickupButton: document.getElementById('confirmPickupButton'),
            confirmButtonText: document.getElementById('confirmButtonText'),
        };

        let currentToken = null;

        // Funções de controle da UI
        const showState = (state) => {
            const allStates = [ui.loading, ui.errorMessage, ui.initialStep, ui.confirmationStep, ui.finalMessage];
            allStates.forEach(s => s.style.display = 'none');
            if (state) state.style.display = 'block';
        };

        const showFinalState = (type, title, details) => {
            showState(ui.finalMessage);
            ui.finalMessage.className = `card final-message ${type}`;
            ui.finalIcon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-times-circle';
            ui.finalTitle.textContent = title;
            ui.finalDetails.textContent = details;
        };
        
        const showLocationStatus = (type, message) => {
            ui.locationStatus.className = `location-status location-${type}`;
            ui.locationStatus.innerHTML = message;
            ui.locationStatus.style.display = 'block';
        };

        // ETAPA 0: Inicialização e Validação do Token
        const init = async () => {
            showState(ui.loading);
            const params = new URLSearchParams(window.location.search);
            currentToken = params.get('token');

            if (!currentToken) {
                showFinalState('error', 'Link Inválido', 'Nenhum token de acesso foi encontrado no link.');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/tokens/acesso-token?token=${currentToken}`);
                const data = await response.json();

                if (!response.ok) {
                    showFinalState('error', `Erro: ${data.erro || 'Falha'}`, data.mensagem || 'Não foi possível validar seu acesso.');
                    return;
                }

                // Preenche os dados da UI e mostra a primeira etapa
                ui.alunoNome.textContent = data.aluno?.nome || 'N/A';
                ui.destinatarioNome.textContent = data.destinatario?.nome || 'N/A';
                const operacao = data.operacoesPermitidas?.toLowerCase() || '';
                ui.operacaoTipo.textContent = operacao.charAt(0).toUpperCase() + operacao.slice(1);
                ui.observacao.textContent = data.observacao || 'Nenhuma.';
                
                showState(ui.initialStep);

            } catch (error) {
                console.error("Erro de rede na validação:", error);
                showFinalState('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor. Verifique sua internet.');
            }
        };

        // ETAPA 1: Solicitar Saída (Primeiro clique)
        const requestExit = async () => {
            ui.requestExitButton.disabled = true;
            ui.requestButtonText.innerHTML = '<span class="btn-spinner"></span> Obtendo localização...';
            showLocationStatus('loading', '<i class="fas fa-map-marker-alt"></i> Obtendo sua localização...');

            let userCoordinates;
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
                });
                userCoordinates = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                
                ui.requestButtonText.innerHTML = '<span class="btn-spinner"></span> Verificando área...';
                showLocationStatus('success', '<i class="fas fa-check-circle"></i> Localização obtida. Verificando área permitida...');
            } catch (error) {
                const message = error.code === 1 ? "Acesso à localização negado." : "Não foi possível obter a localização.";
                showFinalState('error', 'Falha na Localização', `${message} Habilite a permissão no seu navegador e recarregue a página.`);
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/tokens/executar-operacao`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken, latitude: userCoordinates.latitude, longitude: userCoordinates.longitude })
                });

                const data = await response.json();

                if (response.ok) {
                    // SUCESSO! Transição para a Etapa 2
                    ui.confirmationMessage.textContent = data.mensagem;
                    showState(ui.confirmationStep);
                } else {
                    // Erro (ex: fora da geofence)
                    showFinalState('error', `Falha na Solicitação (${response.status})`, data.mensagem || 'Ocorreu um erro ao processar a solicitação.');
                }
            } catch (error) {
                console.error("Erro de rede na solicitação:", error);
                showFinalState('error', 'Erro de Conexão', 'Não foi possível enviar a solicitação. Verifique sua internet.');
            }
        };

        // ETAPA 2: Confirmar Retirada (Segundo clique)
        const confirmPickup = async () => {
            ui.confirmPickupButton.disabled = true;
            ui.confirmButtonText.innerHTML = '<span class="btn-spinner"></span> Confirmando...';
            
            try {
                // **ATENÇÃO: Este endpoint precisa ser criado no seu backend!**
                const response = await fetch(`${BACKEND_URL}/api/presencas/confirmar-saida/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken }) // Enviando o token para o backend
                });

                const data = await response.json();
                
                if (response.ok) {
                    showFinalState('success', 'Retirada Confirmada!', data.mensagem || 'O aluno foi liberado com sucesso.');
                } else {
                    showFinalState('error', `Falha na Confirmação (${response.status})`, data.mensagem || 'Não foi possível confirmar a retirada.');
                }
            } catch (error) {
                console.error("Erro de rede na confirmação:", error);
                showFinalState('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor para confirmar a retirada.');
            }
        };

        // Adicionar eventos aos botões
        ui.requestExitButton.addEventListener('click', requestExit);
        ui.confirmPickupButton.addEventListener('click', confirmPickup);

        // Iniciar o processo
        init();
    });
    </script>
</body>
</html>
