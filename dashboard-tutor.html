<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tutor | INOUTCHI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .card-icon.blue { background: #e3f2fd; color: #2196f3; }
        .card-icon.green { background: #e8f5e9; color: #4caf50; }
        .card-icon.orange { background: #fff3e0; color: #ff9800; }
        .card-icon.purple { background: #f3e5f5; color: #9c27b0; }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-badge.present { background: #e8f5e9; color: #2e7d32; }
        .status-badge.absent { background: #ffebee; color: #c62828; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-info { background: #2196f3; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        /* Location Status Styles */
        .location-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .location-loading { background-color: #e3f2fd; color: #1976d2; }
        .location-success { background-color: #e8f5e9; color: #2e7d32; }
        .location-error { background-color: #ffebee; color: #c62828; }
        .location-warning { background-color: #fff3e0; color: #f57c00; }

        .coordinates-display {
            background-color: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-bottom: 15px;
        }

        .geofence-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .geofence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .geofence-item:last-child {
            border-bottom: none;
        }

        .geofence-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .geofence-valid { color: #2e7d32; }
        .geofence-invalid { color: #f57c00; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 2000;
            animation: slideInRight 0.3s;
        }

        .alert-success { background: #4caf50; color: white; }
        .alert-error { background: #f44336; color: white; }
        .alert-warning { background: #ff9800; color: white; }
        .alert-info { background: #2196f3; color: white; }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">T</div>
                <div>
                    <div style="font-weight: 600; color: #333;" id="userName">Tutor</div>
                    <div style="font-size: 0.9rem; color: #666;" id="userEmail">tutor@escola.com</div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="cards-container">
            <div class="card">
                <div class="card-icon blue">
                    <i class="fas fa-users"></i>
                </div>
                <h3 style="color: #666; font-size: 0.9rem;">Total de Alunos</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #333;" id="totalStudents">0</p>
            </div>

            <div class="card">
                <div class="card-icon green">
                    <i class="fas fa-user-check"></i>
                </div>
                <h3 style="color: #666; font-size: 0.9rem;">Presentes</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #4caf50;" id="presentStudents">0</p>
            </div>

            <div class="card">
                <div class="card-icon orange">
                    <i class="fas fa-user-times"></i>
                </div>
                <h3 style="color: #666; font-size: 0.9rem;">Ausentes</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #ff9800;" id="absentStudents">0</p>
            </div>

            <div class="card">
                <div class="card-icon purple">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 style="color: #666; font-size: 0.9rem;">Presença Hoje</h3>
                <p style="font-size: 2rem; font-weight: bold; color: #9c27b0;" id="attendanceRate">0%</p>
            </div>
        </div>

        <!-- Students Section -->
        <div class="card" style="margin-bottom: 20px;">
            <h2 style="margin-bottom: 20px; color: #333;">
                <i class="fas fa-graduation-cap"></i> Meus Alunos
            </h2>
            <div class="students-grid" id="studentsGrid">
                <!-- Students will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Registrar Ação</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage" style="margin-bottom: 20px;"></p>

                <!-- Location Section -->
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        <i class="fas fa-map-marker-alt"></i> Localização Atual
                    </label>

                    <!-- Location Status -->
                    <div id="locationStatus" class="location-status" style="display: none;"></div>

                    <!-- Coordinates Display -->
                    <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                        <div><strong>Latitude:</strong> <span id="displayLatitude">-</span></div>
                        <div><strong>Longitude:</strong> <span id="displayLongitude">-</span></div>
                    </div>

                    <!-- Geofence Validation Results -->
                    <div id="geofenceResults" class="geofence-info" style="display: none;">
                        <h4 style="margin-bottom: 10px; color: #555;">Validação de Perímetro:</h4>
                        <div id="geofenceList"></div>
                    </div>

                    <!-- Get Location Button -->
                    <button class="btn btn-primary" id="getLocationBtn" onclick="getCurrentLocation()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-location-arrow"></i> Obter Localização Atual
                    </button>

                    <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                        <i class="fas fa-info-circle"></i> A localização é validada com o perímetro da escola
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmAction()" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';

        // State Management
        let currentUser = null;
        let currentSchoolId = 1;
        let students = [];
        let selectedStudentId = null;
        let actionType = null;
        let currentLocation = null;
        let schoolGeofences = [];
        let isWithinGeofence = false;
        let tutorName = null;
        let currentUserId = null;
        let latitude = undefined;
        let longitude = undefined;

        // ========== INITIALIZATION ==========
        async function initializeDashboard() {
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    window.location.href = 'index.html';
                    return;
                }

                // 1º - Carregar informações do usuário (define currentSchoolId)
                await loadUserInfo();
                
                // 2º - Só depois carregar geofences (agora currentSchoolId está definido)
                await loadGeofences();
                
                // 3º - Carregar alunos
                await loadStudents();

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Erro ao inicializar dashboard', 'error');
            }
        }

        // ========== USER MANAGEMENT ==========
        async function loadUserInfo() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    
                    // IMPORTANTE: Garantir que currentSchoolId NUNCA seja undefined
                    currentSchoolId = currentUser.escolaId;
                    tutorName = currentUser.nome || currentUser.name;
                    console.log('Nome do tutor capturado:', tutorName);
                    // Log para debug
                    console.log('currentUser recebido:', currentUser);
                    console.log('currentSchoolId definido como:', currentSchoolId);
                    // IMPORTANTE: O currentUser já tem o ID
                    console.log('User ID:', currentUser.id);

                    // IMPORTANTE: Capturar o nome do tutor
                    

                    // Exibir informações do usuário
                    document.getElementById('userFullName').textContent = tutorName;

                    // Adicionar estas linhas para debug e salvamento
                    console.log('User info loaded:', currentUser);
                    
                    // Salvar o ID do usuário no localStorage para uso posterior
                    if (currentUser.id) {
                        localStorage.setItem('user_id', currentUser.id.toString());
                    }
                    if (currentUser.email) {
                        localStorage.setItem('user_email', currentUser.email);
                    }
                    
                    // Salva o email no localStorage para uso posterior
                    if (currentUser.email) {
                        localStorage.setItem('user_email', currentUser.email);
                    }

                    // Update UI
                    document.getElementById('userName').textContent = currentUser.nome || 'Tutor';
                    document.getElementById('userEmail').textContent = currentUser.email || '';
                    document.getElementById('userAvatar').textContent = 
                        (currentUser.nome || 'T').charAt(0).toUpperCase();
                } else {
                    throw new Error('Failed to load user info');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                logout();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // ========== GEOFENCE MANAGEMENT ==========
        async function loadGeofences() {
            try {
                // PROTEÇÃO: Garantir que currentSchoolId está definido
                if (!currentSchoolId || currentSchoolId === 'undefined') {
                    console.warn('currentSchoolId não definido, usando valor padrão 1');
                    currentSchoolId = 1;
                }

                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${BACKEND_URL}/api/geofences/escola/${currentSchoolId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    schoolGeofences = await response.json();
                    console.log('School geofences loaded:', schoolGeofences);
                } else if (response.status === 403) {
                    // Não mostrar erro para tutores - é esperado não ter permissão
                    console.warn('Sem permissão para carregar geofences - usando validação padrão');
                    schoolGeofences = [];
                } else {
                    console.warn('Could not load geofences:', response.status);
                    schoolGeofences = [];
                }

            } catch (error) {
                console.error('Error loading geofences:', error);
                schoolGeofences = [];
            }
        }

        function validateLocationWithGeofences(latitude, longitude) {
            const validations = [];

            for (const geofence of schoolGeofences) {
                if (!geofence.ativo) continue;

                // Calculate distance using Haversine formula
                const distance = calculateDistance(
                    latitude, longitude,
                    geofence.latitude, geofence.longitude
                );

                const isValid = distance <= geofence.raioMetros;

                validations.push({
                    nome: geofence.nome,
                    tipo: geofence.tipo,
                    distancia: Math.round(distance),
                    raio: geofence.raioMetros,
                    valido: isValid
                });
            }

            return validations;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // ========== LOCATION MANAGEMENT ==========
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                showLocationError('Geolocalização não suportada pelo navegador');
                return;
            }

            showLocationLoading();
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // CRUCIAL: Definir as variáveis globais
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    
                    currentLocation = {
                        latitude: latitude,
                        longitude: longitude
                    };

                    showLocationSuccess(currentLocation);

                    // Validação com geofences
                    const validations = validateLocationWithGeofences(latitude, longitude);
                    showGeofenceValidation(validations);

                    isWithinGeofence = validations.some(v => 
                        v.valido && 
                        (actionType === 'entrada' ? v.tipo !== 'SAIDA' : v.tipo !== 'ENTRADA')
                    );

                    // Habilitar botão se localização válida
                    const confirmBtn = document.getElementById('confirmActionBtn');
                    confirmBtn.disabled = !isWithinGeofence;

                    if (!isWithinGeofence) {
                        showLocationWarning('Você está fora do perímetro permitido para esta ação');
                    }
                },
                (error) => {
                    showLocationError(getLocationErrorMessage(error));
                    currentLocation = null;
                    latitude = undefined;  // Resetar
                    longitude = undefined;  // Resetar
                    isWithinGeofence = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function showLocationLoading() {
            const status = document.getElementById('locationStatus');
            status.className = 'location-status location-loading';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
            status.style.display = 'flex';

            document.getElementById('coordinatesDisplay').style.display = 'none';
            document.getElementById('geofenceResults').style.display = 'none';
        }

        function showLocationSuccess(coords) {
            const status = document.getElementById('locationStatus');
            status.className = 'location-status location-success';
            status.innerHTML = '<i class="fas fa-check-circle"></i> Localização obtida com sucesso!';
            status.style.display = 'flex';

            // Display coordinates
            const coordsDisplay = document.getElementById('coordinatesDisplay');
            document.getElementById('displayLatitude').textContent = coords.latitude.toFixed(6);
            document.getElementById('displayLongitude').textContent = coords.longitude.toFixed(6);
            coordsDisplay.style.display = 'block';
        }

        function showLocationError(message) {
            const status = document.getElementById('locationStatus');
            status.className = 'location-status location-error';
            status.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            status.style.display = 'flex';

            document.getElementById('coordinatesDisplay').style.display = 'none';
            document.getElementById('geofenceResults').style.display = 'none';

            document.getElementById('confirmActionBtn').disabled = true;
        }

        function showLocationWarning(message) {
            const status = document.getElementById('locationStatus');
            status.className = 'location-status location-warning';
            status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            status.style.display = 'flex';
        }

        function showGeofenceValidation(validations) {
            const container = document.getElementById('geofenceResults');
            const list = document.getElementById('geofenceList');

            list.innerHTML = '';

            for (const validation of validations) {
                const item = document.createElement('div');
                item.className = 'geofence-item';

                const statusClass = validation.valido ? 'geofence-valid' : 'geofence-invalid';
                const statusIcon = validation.valido ? 'check-circle' : 'times-circle';
                const statusText = validation.valido ? 'Dentro do perímetro' : `Fora (${validation.distancia}m)`;

                item.innerHTML = `
                    <div>
                        <strong>${validation.nome}</strong>
                        <div style="font-size: 0.85rem; color: #666;">
                            Tipo: ${validation.tipo} | Raio: ${validation.raio}m
                        </div>
                    </div>
                    <div class="geofence-status ${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        ${statusText}
                    </div>
                `;

                list.appendChild(item);
            }

            container.style.display = 'block';
        }

        function getLocationErrorMessage(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return 'Permissão de localização negada';
                case error.POSITION_UNAVAILABLE:
                    return 'Localização indisponível';
                case error.TIMEOUT:
                    return 'Tempo esgotado ao obter localização';
                default:
                    return 'Erro ao obter localização';
            }
        }

        // ========== STUDENTS MANAGEMENT ==========
        async function loadStudents() {
            try {
                const accessToken = localStorage.getItem('access_token');
                
                // Verificação estrita - sem fallbacks
                if (!tutorName) {
                    console.error('ERRO CRÍTICO: tutorName não está definido');
                    showAlert('Erro: Nome do tutor não disponível', 'error');
                    return;
                }
                
                console.log('Carregando alunos do tutor:', tutorName);
                
                // ✅ CORRETO: Usar o NOME do tutor na URL
                const response = await fetch(`${BACKEND_URL}/api/tutores/${encodeURIComponent(tutorName)}/alunos`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Resposta da API (TutorDetalheDTO):', data);
                    
                    // O endpoint retorna um TutorDetalheDTO que provavelmente tem a estrutura:
                    // { nome: "Maria", alunos: [...], ... }
                    if (data.alunos && Array.isArray(data.alunos)) {
                        students = data.alunos;
                    } else if (Array.isArray(data)) {
                        students = data;
                    } else {
                        students = [];
                        console.warn('Formato de resposta não reconhecido:', data);
                    }
                    
                    console.log(`Total de alunos carregados: ${students.length}`);
                    
                    // Renderizar os alunos
                    renderStudents();
                    updateStatistics();
                    
                } else {
                    const errorText = await response.text();
                    console.error(`Erro HTTP ${response.status}:`, errorText);
                    
                    if (response.status === 404) {
                        showAlert(`Tutor "${tutorName}" não encontrado`, 'error');
                    } else if (response.status === 401) {
                        showAlert('Sessão expirada. Faça login novamente', 'error');
                        setTimeout(() => logout(), 2000);
                    } else {
                        showAlert(`Erro ao carregar alunos: ${response.status}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showAlert('Erro ao carregar alunos. Verifique sua conexão.', 'error');
            }
        }

        function renderStudents() {
            const grid = document.getElementById('studentsGrid');

            if (students.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhum aluno vinculado</p>';
                return;
            }

            grid.innerHTML = students.map(student => `
                <div class="student-card">
                    <div class="student-header">
                        <span class="student-name">${student.nome}</span>
                        <span class="status-badge ${student.presente ? 'present' : 'absent'}">
                            ${student.presente ? 'Presente' : 'Ausente'}
                        </span>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">
                        <i class="fas fa-id-card"></i> Matrícula: ${student.matricula || 'N/A'}
                    </div>
                    <div class="action-buttons">
                        ${!student.presente ? `
                            <button class="btn btn-success" onclick="openActionModal(${student.id}, 'entrada', '${student.nome}')">
                                <i class="fas fa-sign-in-alt"></i> Entrada
                            </button>
                        ` : `
                            <button class="btn btn-danger" onclick="openActionModal(${student.id}, 'saida', '${student.nome}')">
                                <i class="fas fa-sign-out-alt"></i> Saída
                            </button>
                        `}
                        <button class="btn btn-info" onclick="viewHistory(${student.id})">
                            <i class="fas fa-history"></i> Histórico
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStatistics() {
            const total = students.length;
            const present = students.filter(s => s.presente).length;
            const absent = total - present;
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('presentStudents').textContent = present;
            document.getElementById('absentStudents').textContent = absent;
            document.getElementById('attendanceRate').textContent = rate + '%';
        }

        // ========== MODAL MANAGEMENT ==========
        function openActionModal(studentId, type, studentName) {
            selectedStudentId = studentId;
            actionType = type;

            const modal = document.getElementById('actionModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');

            title.textContent = `Registrar ${type === 'entrada' ? 'Entrada' : 'Saída'}`;
            message.innerHTML = `Confirmar <strong>${type === 'entrada' ? 'entrada' : 'saída'}</strong> do aluno <strong>${studentName}</strong>?`;

            // Reset location state
            resetLocationState();

            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('actionModal');
            modal.style.display = 'none';

            selectedStudentId = null;
            actionType = null;
            currentLocation = null;
            isWithinGeofence = false;

            resetLocationState();
        }

        function resetLocationState() {
            latitude = undefined;
            longitude = undefined;
            document.getElementById('locationStatus').style.display = 'none';
            document.getElementById('coordinatesDisplay').style.display = 'none';
            document.getElementById('geofenceResults').style.display = 'none';
            document.getElementById('displayLatitude').textContent = '-';
            document.getElementById('displayLongitude').textContent = '-';
            document.getElementById('confirmActionBtn').disabled = true;
        }

        // ========== ACTION CONFIRMATION ==========
        async function confirmAction() {
            if (!selectedStudentId || !actionType) {
                showAlert('Dados incompletos', 'error');
                return;
            }
            
            // VALIDAÇÃO DAS COORDENADAS GLOBAIS
            if (typeof latitude === 'undefined' || typeof longitude === 'undefined') {
                showAlert('Localização não disponível. Obtenha a localização primeiro.', 'error');
                return;
            }
            
            if (!isWithinGeofence) {
                showAlert('Você está fora do perímetro permitido', 'error');
                return;
            }

            try {
                const accessToken = localStorage.getItem('access_token');
                const endpoint = actionType === 'entrada' ? 'entrada' : 'saida';

                const requestData = {
                    alunoId: selectedStudentId,
                    responsavelNome: tutorName || currentUser.nome,
                    responsavelTipo: 'TUTOR',
                    responsavelId: currentUser.id || 1,
                    latitude: latitude,      // Usar variável global
                    longitude: longitude      // Usar variável global
                };

                console.log('Enviando:', requestData);

                const response = await fetch(`${BACKEND_URL}/api/presencas/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    showAlert(`${actionType === 'entrada' ? 'Entrada' : 'Saída'} registrada!`, 'success');
                    closeModal();
                    await loadStudents();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Erro ao registrar');
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert(`Erro: ${error.message}`, 'error');
            }
        }

        function viewHistory(studentId) {
            showAlert('Histórico em desenvolvimento', 'info');
        }

        // ========== UTILITIES ==========
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 4000);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('actionModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>