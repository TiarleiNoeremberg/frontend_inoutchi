<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INOUTCHI - Dashboard Tutor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== VARI√ÅVEIS CSS ===== */
:root {
    --primary-color: #4a6fa5;
    --secondary-color: #166088;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --text-color: #343a40;
    --border-color: #dee2e6;
    --warning-bg: #FFFBEB;
    --warning-text: #B45309;
}

/* ===== ESTILOS GERAIS ===== */
body {
    background-color: #f4f7f9;
    font-family: 'Segoe UI', sans-serif;
    color: var(--text-color);
}

/* ===== HEADER ===== */
header {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1020;
}

.logo h1 {
    color: var(--primary-color);
    font-size: 20px;
    font-weight: 700;
    margin: 0;
}

.header-logo {
    height: 35px;
    width: auto;
    vertical-align: middle;
    margin-right: 10px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
}

/* ===== MAIN CONTENT ===== */
main {
    padding: 15px;
}

.welcome-section h2 {
    color: var(--primary-color);
    font-weight: 600;
}

/* ===== CARDS ===== */
.card {
    background-color: white;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-header {
    background-color: transparent;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 0.9rem 1.1rem;
}

.card-header i {
    font-size: 18px;
    margin-right: 10px;
    color: var(--primary-color);
}

.card-header h3 {
    font-size: 17px;
    font-weight: 600;
    margin: 0;
}

/* ===== STUDENT LIST ===== */
.student-list {
    list-style: none;
    padding: 0;
}

.student-item {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
    border-bottom: 1px solid #f1f1f1;
}

.student-item:last-child {
    border-bottom: none;
}

.student-item-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.student-info {
    display: flex;
    flex-direction: column;
}

.student-name {
    font-weight: 600;
    font-size: 1rem;
}

.student-class {
    font-size: 0.85em;
    color: #6c757d;
}

.student-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
}

.student-actions-group {
    display: flex;
    gap: 8px;
}

/* ===== STATUS BADGES ===== */
.status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.status-present {
    background-color: rgba(40, 167, 69, 0.1);
    color: var(--success-color);
}

.status-absent {
    background-color: rgba(220, 53, 69, 0.1);
    color: var(--danger-color);
}

.status-warning {
    background-color: var(--warning-bg);
    color: var(--warning-text);
}

.status-finalizado {
    background-color: rgba(74, 111, 165, 0.15);
    color: var(--primary-color);
}

/* ===== TOKEN STATUS ===== */
.token-status {
    padding: .25em .6em;
    font-size: .75em;
    font-weight: 700;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: .375rem;
}

.token-status-ativo {
    background-color: var(--success-color, #198754);
}

.token-status-expirado {
    background-color: var(--warning-color, #ffc107);
    color: #000;
}

.token-status-utilizado {
    background-color: #6c757d;
}

.token-status-revogado {
    background-color: var(--danger-color, #dc3545);
}

/* ===== HISTORY SECTION ===== */
.history-section {
    margin-top: 30px;
}

.history-table {
    width: 100%;
    font-size: 0.9rem;
}

.history-table th,
.history-table td {
    text-align: left;
    padding: 10px;
}

.history-table thead {
    background-color: #f8f9fa;
}

/* ===== PAGINATION ===== */
.pagination-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    padding: 10px 0;
}

.pagination-buttons {
    display: flex;
    gap: 6px;
}

#historyPaginationInfo {
    color: var(--primary-color);
    font-weight: bold;
    font-size: 0.9rem;
}

#historyPrevBtn,
#historyNextBtn {
    padding-left: 24px;
    padding-right: 24px;
}

/* ===== BUTTONS ===== */
.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
}

/* ===== LOADING STATES ===== */
.loading {
    text-align: center;
    padding: 50px;
}

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    100% {
        transform: rotate(360deg);
    }
}

.modal-loading {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(4px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10;
    border-radius: var(--bs-modal-inner-border-radius);
}

/* ===== RESPONSIVE DESIGN ===== */
@media (min-width: 768px) {
    main {
        padding: 25px;
    }
    
    .logo h1 {
        font-size: 22px;
    }
    
    .student-item {
        flex-direction: row;
        align-items: center;
        padding: 15px 20px;
    }
    
    .student-item-main {
        flex-grow: 1;
    }
        
    .pagination-controls {
        flex-direction: row;
        justify-content: space-between;
    }
}
    </style>
</head>
<body>
    <header>
        <div class="logo"><h1>inoutchi</h1></div>
        <div class="user-info">
            <button id="myTokensBtn" class="btn btn-info" title="Meus Tokens">
                <i class="fas fa-key"></i><span class="d-none d-md-inline ms-2">Meus Tokens</span>
            </button>
            <div class="user-avatar" id="userAvatar">?</div>
            <button class="btn btn-danger btn-sm" onclick="logout()">Sair</button>
        </div>
    </header>

    <main>
        <div class="welcome-section mb-4">
            <h2>Ol√°, <span id="userFullName">Tutor</span>!</h2>
            <p class="text-muted">Gerencie a presen√ßa dos seus alunos de forma simples e r√°pida.</p>
        </div>

        <div id="alertBox" class="alert alert-dismissible fade show" role="alert" style="display: none;"></div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p class="mt-3 text-muted">Carregando informa√ß√µes...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="card">
                <div class="card-header"><i class="fas fa-users"></i><h3>Alunos Vinculados</h3></div>
                <ul class="student-list" id="studentList"></ul>
            </div>

            <div class="history-section card" id="historySection" style="display: none;">
                <div class="card-header"><i class="fas fa-history"></i><h3 id="historyTitle">Hist√≥rico de Presen√ßa</h3></div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="history-table">
                            <thead><tr><th>Entrada</th><th>Sa√≠da</th><th>Status</th></tr></thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                    <div id="historyPaginationControls" class="pagination-controls mt-3" style="display: none;">
                        <span id="historyPaginationInfo" class="small"></span>
                        <div class="pagination-buttons">
                            <button class="btn btn-sm btn-primary" id="historyFirstBtn"><i class="fas fa-angle-double-left"></i></button>
                            <button class="btn btn-sm btn-primary" id="historyPrevBtn"><i class="fas fa-angle-left"></i></button>
                            <button class="btn btn-sm btn-primary" id="historyNextBtn"><i class="fas fa-angle-right"></i></button>
                            <button class="btn btn-sm btn-primary" id="historyLastBtn"><i class="fas fa-angle-double-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="actionLocationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content position-relative">
                <div class="modal-loading" id="modalLoading">
                    <div class="text-center">
                        <div class="loading-spinner"></div>
                        <p class="mt-2" id="modalLoadingText"></p>
                    </div>
                </div>
                <div class="modal-header">
                    <h5 class="modal-title" id="actionLocationModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                    <div class="form-group mt-3">
                        <div id="locationStatus" class="location-status" style="display: none;"></div>
                        <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                            <div>Lat: <span id="displayLatitude">-</span></div>
                            <div>Lon: <span id="displayLongitude">-</span></div>
                        </div>
                        <button class="btn btn-primary w-100 mt-2" id="getLocationBtn">
                            <i class="fas fa-sync-alt"></i> Tentar Localiza√ß√£o Novamente
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn" disabled></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manualConfirmExitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Sa√≠da Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="manualConfirmExitMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="manualConfirmExitOkBtn"><i class="fas fa-check-circle"></i> Sim, Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gerar Token (VERS√ÉO CORRIGIDA E COMPLETA) -->
    <div class="modal fade" id="generateTokenModal" tabindex="-1" aria-labelledby="generateTokenModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <form id="generateTokenForm" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="generateTokenModalLabel">Gerar Token de Acesso para <span id="tokenAlunoNome"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Campo oculto para o ID do aluno -->
                        <input type="hidden" id="tokenAlunoId" name="alunoId">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="destinatarioNome" class="form-label">Nome do Destinat√°rio</label>
                                <input type="text" class="form-control" id="destinatarioNome" name="destinatarioNome" required>
                            </div>
                            <div class="col-md-6">
                                <label for="tipoParentesco" class="form-label">Parentesco</label>
                                <select class="form-select" id="tipoParentesco" name="tipoParentesco" required>
                                    <option value="PARENTE">Parente</option>
                                    <option value="AMIGO">Amigo</option>
                                    <option value="IRMAO">Irm√£o</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="destinatarioTelefone" class="form-label">Telefone do Destinat√°rio</label>
                                <input type="tel" class="form-control" id="destinatarioTelefone" name="destinatarioTelefone" placeholder="(11) 99999-9999">
                            </div>
                            <div class="col-md-6">
                                <label for="destinatarioEmail" class="form-label">E-mail do Destinat√°rio</label>
                                <input type="email" class="form-control" id="destinatarioEmail" name="destinatarioEmail" placeholder="nome@email.com">
                            </div>

                            <div class="col-md-6">
                                <label for="tipoOperacao" class="form-label">Tipo de Opera√ß√£o</label>
                                <select class="form-select" id="tipoOperacao" name="tipoOperacao" required>
                                    <option value="SAIDA" selected>Sa√≠da</option>
                                    <option value="ENTRADA">Entrada</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="dataExpiracao" class="form-label">Data e Hora de Expira√ß√£o</label>
                                <input type="datetime-local" class="form-control" id="dataExpiracao" name="dataExpiracao" required>
                            </div>

                            <div class="col-12">
                                <label for="observacao" class="form-label">Observa√ß√£o (Opcional)</label>
                                <textarea class="form-control" id="observacao" name="observacao" rows="2" placeholder="Ex: Buscar na sa√≠da da escola."></textarea>
                            </div>
                        </div>
                        <div id="generateTokenError" class="alert alert-danger mt-3" style="display:none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="generateTokenSubmitBtn">Gerar Token</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Listar Meus Tokens -->
    <div id="myTokensModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Meus Tokens Gerados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="myTokensLoading" class="text-center" style="display: none; padding: 20px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Carregando tokens...</p>
                    </div>
                    <div id="myTokensError" class="alert alert-danger" style="display: none;"></div>
                    <div id="myTokensContainer" class="table-responsive" style="display: none;">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Destinat√°rio</th>
                                    <th>Expira em</th>
                                    <th>Status</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="myTokensTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Sucesso ao Gerar Token -->
    <div id="tokenSuccessModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Token Gerado com Sucesso!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" style="padding: 20px;">
                    <p>Compartilhe o link de acesso abaixo com o destinat√°rio:</p>
                    <div class="input-group">
                        <input type="text" id="tokenLinkInput" class="form-control" readonly>
                        <button id="copyTokenLinkBtn" class="btn btn-outline-secondary" title="Copiar Link"><i class="fas fa-copy"></i></button>
                    </div>
                    <p id="copyFeedback" class="mt-2" style="display:none; color: var(--success-color); font-weight: bold;">Link copiado!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', () => {
            // URL do backend
            const BACKEND_URL = 'https://inoutchi-cd92743c8443.herokuapp.com';

            // Vari√°veis de estado global
            let currentUser = null;
            let students = [];
            let studentsAutoRefreshInterval = null;

            // Elementos do DOM
            const userFullName = document.getElementById('userFullName');
            const userAvatar = document.getElementById('userAvatar');
            const studentListElement = document.getElementById('student-list');
            const alertBox = document.getElementById('alertBox');

            // ========================================================================
            // FUN√á√ïES DE AUTENTICA√á√ÉO E COMUNICA√á√ÉO COM API
            // ========================================================================

            /**
             * Wrapper para o fetch que adiciona o token de autentica√ß√£o e j√° retorna o JSON.
             * Esta fun√ß√£o lida centralmente com a autentica√ß√£o e erros de rede.
             */
            async function fetchWithAuth(endpoint, options = {}) {
                const url = `${BACKEND_URL}${endpoint}`;
                const token = localStorage.getItem('access_token');

                const finalOptions = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers,
                    },
                };

                const response = await fetch(url, finalOptions);

                if (response.status === 401 || response.status === 403) {
                    showAlert('Sua sess√£o expirou. Por favor, fa√ßa login novamente.', 'danger');
                    setTimeout(() => window.location.href = 'index.html', 3000);
                    throw new Error('N√£o autorizado. Redirecionando para o login.');
                }

                if (response.status === 204) { // Resposta "No Content"
                    return { success: true, message: 'Opera√ß√£o realizada com sucesso.' };
                }

                const responseText = await response.text();
                if (!response.ok) {
                    let errorMessage = `Erro na requisi√ß√£o: ${response.status}`;
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.message || errorData.mensagem || errorMessage;
                    } catch (e) {
                        errorMessage = responseText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    // Se n√£o for JSON v√°lido, pode ser uma resposta de texto simples
                    return responseText;
                }
            }

            // ========================================================================
            // FUN√á√ïES PRINCIPAIS DO DASHBOARD
            // ========================================================================

            /**
             * Ponto de entrada. Inicia o dashboard.
             */
            async function initializeDashboard() {
                console.log("üöÄ Inicializando dashboard do tutor...");

                // Valida a sess√£o do usu√°rio
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showAlert('Nenhum token encontrado. Redirecionando para login.', 'danger');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }
                console.log("üîë Sess√£o de usu√°rio validada com sucesso.");

                try {
                    // Carrega as informa√ß√µes do usu√°rio e, em sequ√™ncia, seus alunos
                    await loadUserInfo();

                    // Inicia a atualiza√ß√£o autom√°tica
                    startStudentsAutoRefresh();
                } catch (error) {
                    console.error('‚ùå Erro fatal durante a inicializa√ß√£o:', error.message);
                    showAlert(`Falha ao carregar os dados do dashboard: ${error.message}`, 'danger');
                }
            }

            /**
             * Carrega as informa√ß√µes do usu√°rio logado e dispara o carregamento dos alunos.
             */
            async function loadUserInfo() {
                try {
                    console.log('üîÑ Carregando informa√ß√µes do usu√°rio...');
                    // fetchWithAuth j√° retorna o JSON, ent√£o n√£o precisamos de .json() aqui.
                    currentUser = await fetchWithAuth('/api/users/me');

                    if (!currentUser || !currentUser.nome) {
                        throw new Error("Formato de dados do usu√°rio inv√°lido recebido da API.");
                    }

                    console.log(`‚úÖ Informa√ß√µes do usu√°rio carregadas: ${currentUser.nome}`);
                    userFullName.textContent = currentUser.nome;
                    userAvatar.textContent = currentUser.nome.charAt(0).toUpperCase();

                    // AGORA que temos o nome do tutor, carregamos os alunos.
                    await loadAlunosVinculados(currentUser.nome);

                } catch (error) {
                    console.error('‚ùå Erro ao carregar informa√ß√µes do usu√°rio:', error);
                    // Propaga o erro para ser tratado no initializeDashboard
                    throw new Error(`Falha ao obter dados do usu√°rio. ${error.message}`);
                }
            }

            /**
             * Carrega os alunos vinculados ao tutor, j√° com a corre√ß√£o.
             */
            async function loadAlunosVinculados(tutorName) {
                console.log(`üîÑ Buscando alunos vinculados para o tutor: ${tutorName}`);

                try {
                    // fetchWithAuth j√° retorna JSON ou lan√ßa um erro.
                    const data = await fetchWithAuth(`/api/tutores/${encodeURIComponent(tutorName)}/alunos`);

                    if (!data || !Array.isArray(data.alunos)) {
                        throw new Error("A resposta da API de alunos n√£o continha a lista esperada.");
                    }
                    
                    console.log(`‚úÖ ${data.alunos.length} alunos recebidos. Verificando status...`);

                    const studentPromises = data.alunos.map(async (student) => {
                        try {
                            const saidaAtiva = await fetchWithAuth(`/api/presencas/aluno/${student.id}/saida-ativa`);
                            if (saidaAtiva && saidaAtiva.sucesso && saidaAtiva.dados && saidaAtiva.dados.status === 'AGUARDANDO_CONFIRMACAO') {
                                student.status = 'AGUARDANDO_CONFIRMACAO';
                            }
                        } catch (error) {
                            // Um erro aqui (como 404) significa apenas que n√£o h√° sa√≠da ativa, o que √© normal.
                            console.log(`‚ÑπÔ∏è Aluno ${student.id} n√£o possui sa√≠da ativa.`);
                            // O status que vem da primeira API ('PRESENTE' ou 'AUSENTE') ser√° mantido.
                        }
                        return student;
                    });

                    students = await Promise.all(studentPromises);
                    renderStudents(); // Renderiza a lista de alunos atualizada

                } catch (error) {
                    console.error('‚ùå Erro detalhado ao carregar alunos vinculados:', error);
                    studentListElement.innerHTML = `<li class="list-group-item text-center text-danger p-3">Falha ao carregar alunos: ${error.message}</li>`;
                }
            }

            /**
             * Renderiza a lista de alunos na tela.
             */
            function renderStudents() {
                if (!studentListElement) return;

                if (students.length === 0) {
                    studentListElement.innerHTML = '<li class="list-group-item text-center p-4 text-muted">Nenhum aluno vinculado.</li>';
                    return;
                }

                studentListElement.innerHTML = ''; // Limpa a lista antes de recri√°-la

                students.forEach(student => {
                    if (!student || !student.id) {
                        console.warn('Item de aluno inv√°lido recebido:', student);
                        return;
                    }

                    const li = document.createElement('li');
                    li.className = 'student-item';
                    li.id = `student-${student.id}`;

                    const safeStudentName = student.nome ? String(student.nome).replace(/'/g, "\\'") : 'Aluno';

                    let statusClass, statusText, actionButtonHtml;

                    // Define o status visual com base na propriedade `status` do aluno
                    switch (student.status) {
                        case 'PRESENTE':
                            statusClass = 'status-present';
                            statusText = 'Presente';
                            actionButtonHtml = `<button class="btn btn-sm btn-danger action-btn" onclick="openLocationActionModal(${student.id}, 'saida', '${safeStudentName}')"><i class="fas fa-sign-out-alt"></i> Solicitar Sa√≠da</button>`;
                            break;
                        case 'AGUARDANDO_CONFIRMACAO':
                            statusClass = 'status-warning';
                            statusText = 'Aguardando Confirma√ß√£o';
                            actionButtonHtml = `<button class="btn btn-sm btn-warning action-btn" disabled><i class="fas fa-clock"></i> Aguardando</button>`;
                            break;
                        case 'AUSENTE':
                        default:
                            statusClass = 'status-absent';
                            statusText = 'Ausente';
                            actionButtonHtml = `<button class="btn btn-sm btn-success action-btn" onclick="openLocationActionModal(${student.id}, 'entrada', '${safeStudentName}')"><i class="fas fa-sign-in-alt"></i> Registrar Entrada</button>`;
                            break;
                    }

                    li.innerHTML = `
                        <div class="student-info-container">
                            <span class="student-name">${student.nome || 'Nome Indispon√≠vel'}</span>
                            <span class="student-class">${student.salaNome || 'Sala n√£o definida'}</span>
                        </div>
                        <div class="student-status-container">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="student-actions-container">
                            ${actionButtonHtml}
                            <button class="btn btn-sm btn-info action-btn" onclick="openGenerateTokenModal(${student.id}, '${safeStudentName}')" title="Gerar Token Provis√≥rio">
                                <i class="fas fa-key"></i> Token
                            </button>
                            <button class="btn btn-sm btn-secondary action-btn" onclick="viewStudentHistory(${student.id})" title="Hist√≥rico do Aluno">
                                <i class="fas fa-history"></i> Hist√≥rico
                            </button>
                        </div>
                    `;
                    studentListElement.appendChild(li);
                });
                console.log("‚úÖ Lista de alunos renderizada na tela.");
            }
            
            /**
             * Inicia a atualiza√ß√£o autom√°tica da lista de alunos.
             */
            function startStudentsAutoRefresh() {
                if (studentsAutoRefreshInterval) {
                    clearInterval(studentsAutoRefreshInterval);
                }

                studentsAutoRefreshInterval = setInterval(() => {
                    if (currentUser && currentUser.nome) {
                        console.log('üîÑ Atualiza√ß√£o autom√°tica da lista de alunos...');
                        loadAlunosVinculados(currentUser.nome);
                    }
                }, 60000); // Atualiza a cada 60 segundos

                console.log('üïí Atualiza√ß√£o autom√°tica da lista de alunos iniciada (intervalo: 60s).');
            }

            /**
             * Exibe uma mensagem de alerta na tela.
             */
            function showAlert(message, type = 'info', duration = 5000) {
                if (!alertBox) return;
                const alertDiv = document.createElement('div');
                alertDiv.className = `custom-alert alert-${type}`;
                alertDiv.textContent = message;
                alertBox.appendChild(alertDiv);
                setTimeout(() => {
                    alertDiv.remove();
                }, duration);
            }

            // TODO: Adicione aqui as implementa√ß√µes das fun√ß√µes chamadas pelos bot√µes,
            // como openLocationActionModal, openGenerateTokenModal, viewStudentHistory, etc.
            // Exemplo:
            window.openLocationActionModal = (id, action, name) => {
                console.log(`A√ß√£o: ${action} para o aluno ${name} (ID: ${id})`);
                // L√≥gica para abrir o modal de a√ß√£o
                showAlert(`Funcionalidade 'openLocationActionModal' ainda n√£o implementada.`, 'warning');
            };
            window.openGenerateTokenModal = (id, name) => {
                console.log(`Gerar token para o aluno ${name} (ID: ${id})`);
                // L√≥gica para abrir o modal de token
                showAlert(`Funcionalidade 'openGenerateTokenModal' ainda n√£o implementada.`, 'warning');
            };
            window.viewStudentHistory = (id) => {
                console.log(`Ver hist√≥rico para o aluno ID: ${id}`);
                // L√≥gica para ver o hist√≥rico
                showAlert(`Funcionalidade 'viewStudentHistory' ainda n√£o implementada.`, 'warning');
            }

            // Inicia a aplica√ß√£o
            initializeDashboard();
        });

    
    </script>


<!-- ======================================================================= -->
<!-- ======================= MODALS PARA TOKEN DE ACESSO =================== -->
<!-- ======================================================================= -->

<!-- Modal: Gerar Token de Acesso -->
<div id="generateTokenModal" class="modal" style="display:none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h2>Gerar Token de Acesso para <span id="tokenStudentName"></span></h2>
            <span class="close-btn" onclick="closeModal('generateTokenModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="generateTokenForm">
                <!-- O ID do aluno fica escondido, mas √© essencial para a requisi√ß√£o -->
                <input type="hidden" id="tokenAlunoId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="destinatarioNome">Nome do Destinat√°rio:</label>
                        <input type="text" id="destinatarioNome" required>
                    </div>
                    <div class="form-group">
                        <label for="tipoParentesco">Parentesco:</label>
                        <select id="tipoParentesco" required>
                            <option value="PAI">Pai</option>
                            <option value="MAE">M√£e</option>
                            <option value="AVO">Av√≥/Av√¥</option>
                            <option value="TIO">Tio/Tia</option>
                            <option value="IRMAO">Irm√£o/Irm√£</option>
                            <option value="OUTRO" selected>Outro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="destinatarioTelefone">Telefone do Destinat√°rio:</label>
                        <input type="tel" id="destinatarioTelefone" placeholder="(XX) XXXXX-XXXX">
                    </div>
                    <div class="form-group">
                        <label for="destinatarioEmail">E-mail do Destinat√°rio:</label>
                        <input type="email" id="destinatarioEmail" placeholder="email@exemplo.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoOperacao">Tipo de Opera√ß√£o:</label>
                        <select id="tipoOperacao" required>
                            <option value="SAIDA">Sa√≠da</option>
                            <option value="ENTRADA">Entrada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataExpiracao">Data e Hora de Expira√ß√£o:</label>
                        <input type="datetime-local" id="dataExpiracao" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observacao">Observa√ß√£o:</label>
                    <textarea id="observacao" rows="2" placeholder="Ex: Autorizado a buscar meu filho(a) na escola."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Gerar Token</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Exibir Token Gerado (NOVO) -->
<div id="showTokenModal" class.modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Token Gerado com Sucesso!</h2>
            <span class="close-btn" onclick="closeModal('showTokenModal')">&times;</span>
        </div>
        <div class="modal-body text-center">
            <p>Compartilhe o token ou o link com o destinat√°rio:</p>
            <div class="token-display">
                <input type="text" id="generatedTokenValue" readonly>
                <button onclick="copyToClipboard('generatedTokenValue', 'Copiado!')" title="Copiar Token"><i class="fas fa-copy"></i></button>
            </div>
            <p style="margin-top: 15px;"><strong>Link de Acesso Direto:</strong></p>
            <div class="token-display">
                 <input type="text" id="generatedTokenLink" readonly>
                 <button onclick="copyToClipboard('generatedTokenLink', 'Link copiado!')" title="Copiar Link"><i class="fas fa-link"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Listar Meus Tokens -->
<div id="myTokensModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Meus Tokens Gerados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="myTokensLoading" class="text-center" style="display: none; padding: 20px;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando tokens...</p>
                </div>
                <div id="myTokensError" class="alert alert-danger" style="display: none;"></div>
                <div id="myTokensContainer" class="table-responsive" style="display: none;">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Aluno</th>
                                <th>Destinat√°rio</th>
                                <th>Expira em</th>
                                <th>Status</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="myTokensTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Sucesso ao Gerar Token -->
<div id="tokenSuccessModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Token Gerado com Sucesso!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" style="padding: 20px;">
                <p>Compartilhe o link de acesso abaixo com o destinat√°rio:</p>
                <div class="input-group">
                    <input type="text" id="tokenLinkInput" class="form-control" readonly>
                    <button id="copyTokenLinkBtn" class="btn btn-outline-secondary" title="Copiar Link"><i class="fas fa-copy"></i></button>
                </div>
                <p id="copyFeedback" class="mt-2" style="display:none; color: var(--success-color); font-weight: bold;">Link copiado!</p>
            </div>
        </div>
    </div>
</div>
        

</body>
</html>